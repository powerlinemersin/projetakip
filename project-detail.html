<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Detayları</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- jsPDF Kütüphaneleri (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Türkçe karakterler için jsPDF'e font eklemek gerekebilir, şimdilik standart fontlarla deneyeceğiz -->

  <style>
    /* ... (mevcut stilleriniz aynı kalacak) ... */
  </style>
</head>
<body>
  <header>
    <!-- ... (header içeriği) ... -->
  </header>
  <main>
    <!-- ... (Genel Bilgiler, Aşamalar, Sözleşme ve Kar Hesapları, Harcama Kalemleri, Proje Dosyaları bölümleri) ... -->
    <section> /* ... */ </section>
    <section style="margin-top: 30px;"> /* ... */ </section>
    <section style="margin-top: 30px;"> /* ... */ </section>
    <section style="margin-top: 30px;"> /* ... */ </section>


    <div style="margin-top: 30px; padding-bottom: 30px;">
        <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
        <button onclick="generateReport()" style="margin-left:10px; background:#16a085;">Rapor İndir (PDF)</button> <!-- YENİ BUTON -->
        <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
    </div>
  </main>

  <script>
    // ... (Firebase config, app, db, auth, storage, para formatlama fonksiyonları tanımlamaları) ...
    const { jsPDF } = window.jspdf; // jsPDF'i global scope'tan al

    // ... (auth.onAuthStateChanged, loadProject, renderStages, vb. fonksiyonlar) ...

    // Rapor Oluşturma Fonksiyonu
    async function generateReport() {
        if (!projectId) {
            alert("Rapor oluşturulacak proje bulunamadı.");
            return;
        }

        const projectRef = db.collection("projects").doc(projectId);
        const projectDoc = await projectRef.get();

        if (!projectDoc.exists) {
            alert("Proje verileri bulunamadı.");
            return;
        }
        const p = projectDoc.data();
        const doc = new jsPDF();

        // Türkçe karakterler için bir font ayarlaması gerekebilir.
        // Örnek: doc.setFont("helvetica", "normal"); // Veya bir TTF dosyası yükleyip registerFont ile ekleyebilirsiniz.
        // Şimdilik varsayılan fontlarla deneyelim. Eğer Türkçe karakterler bozuk çıkarsa, font ekleme adımına geçeriz.
        // Örnek bir Google Font (Roboto) ekleme (önce font dosyasını base64'e çevirip eklemek gerekir, bu daha karmaşık)
        // Basit bir çözüm için, jsPDF'in desteklediği standart fontlardan birini kullanabiliriz:
        // doc.setFont("arial", "normal"); // Arial genellikle daha fazla karakteri destekler.
        // Ancak 'arial' jsPDF'e ayrıca eklenmeli. 'Helvetica' veya 'Times' daha standarttır.
        // En iyi çözüm, özel bir fontu (örn: NotoSans-Regular.ttf) base64 olarak ekleyip kullanmaktır.
        // Şimdilik font ayarını yoksayarak devam edelim, sorun çıkarsa bakarız.

        let yPos = 20; // PDF'te dikey pozisyonu takip etmek için

        // Başlık
        doc.setFontSize(18);
        doc.text("Proje Detay Raporu", 105, yPos, { align: "center" });
        yPos += 10;

        // Genel Proje Bilgileri
        doc.setFontSize(12);
        doc.text(`Proje Adı: ${p.name || 'N/A'}`, 14, yPos);
        yPos += 7;
        doc.text(`Müşteri Adı: ${p.client || 'N/A'}`, 14, yPos);
        yPos += 7;
        doc.text(`Proje Durumu: ${p.status || defaultProjectStatus}`, 14, yPos);
        yPos += 7;
        doc.text(`Sözleşme Başlangıcı: ${p.startDate || 'N/A'}`, 14, yPos);
        yPos += 7;
        doc.text(`Sözleşme Bitişi: ${p.endDate || 'N/A'}`, 14, yPos);
        yPos += 10; // Biraz boşluk

        // Aşamalar Tablosu
        doc.setFontSize(14);
        doc.text("Proje Aşamaları", 14, yPos);
        yPos += 7;
        const stagesTableHeaders = [["Aşama Adı", "Sorumlu Kişi", "Tarih", "Durum"]];
        const stagesTableBody = (p.stages || []).map(s => [
            s.name || 'N/A',
            s.responsible || 'N/A',
            s.date || 'N/A',
            s.completed ? "Tamamlandı" : "Tamamlanmadı"
        ]);
        doc.autoTable({
            startY: yPos,
            head: stagesTableHeaders,
            body: stagesTableBody,
            theme: 'grid', // 'striped', 'grid', 'plain'
            headStyles: { fillColor: [52, 73, 94] }, // Koyu mavi başlık
            styles: { font: "helvetica", fontSize: 10 }, // Tablo için font ve boyut
            // didDrawPage: function (data) { yPos = data.cursor.y; } // Eğer sayfa taşması olursa yPos'u güncellemek için
        });
        yPos = doc.lastAutoTable.finalY + 10; // Tablodan sonraki pozisyonu al

        // Harcama Kalemleri Tablosu
        doc.setFontSize(14);
        doc.text("Harcama Kalemleri", 14, yPos);
        yPos += 7;
        const expensesTableHeaders = [["Açıklama", "Tutar (TL)"]];
        const expensesTableBody = (p.expenses || []).map(e => [
            e.desc || 'N/A',
            formatCurrencyTR(e.amount || 0) // Formatlı göster
        ]);
        doc.autoTable({
            startY: yPos,
            head: expensesTableHeaders,
            body: expensesTableBody,
            theme: 'grid',
            headStyles: { fillColor: [52, 73, 94] },
            styles: { font: "helvetica", fontSize: 10 },
            columnStyles: { 1: { halign: 'right' } } // Tutar sütununu sağa yasla
        });
        yPos = doc.lastAutoTable.finalY + 10;

        // Finansal Özet
        doc.setFontSize(14);
        doc.text("Finansal Özet", 14, yPos);
        yPos += 7;
        doc.setFontSize(12);
        
        const contractVal = parseCurrencyTR(document.getElementById("contractValue").value); // Güncel değeri al
        const totalExp = parseCurrencyTR(document.getElementById("totalExpenses").value); // Güncel değeri al
        const realProfit = parseCurrencyTR(document.getElementById("realizedProfit").value); // Güncel değeri al
        const profitMarginText = document.getElementById("realizedProfitMargin").value;


        doc.text(`Sözleşme Tutarı: ${formatCurrencyTR(contractVal)} TL`, 14, yPos);
        yPos += 7;
        doc.text(`Toplam Harcama: ${formatCurrencyTR(totalExp)} TL`, 14, yPos);
        yPos += 7;
        doc.text(`Gerçekleşen Kar: ${formatCurrencyTR(realProfit)} TL`, 14, yPos);
        yPos += 7;
        doc.text(`Gerçekleşen Kar Marjı: % ${profitMarginText}`, 14, yPos);
        yPos += 10;

        // Rapor Tarihi
        const reportDate = new Date().toLocaleDateString('tr-TR');
        doc.setFontSize(10);
        doc.text(`Rapor Tarihi: ${reportDate}`, 14, yPos);

        // PDF'i İndir
        const fileName = `${p.name ? p.name.replace(/\s+/g, '_') : 'proje'}_rapor.pdf`;
        doc.save(fileName);
        alert("Rapor başarıyla oluşturuldu ve indiriliyor.");
    }

    // ... (loadProject, renderStages, saveStageField, updateProjectStatus, renderExpenses, addExpense, removeExpense, ...)
    // ... (updateCalculations, saveDetails, renderFiles, uploadFile, deleteFile, goBack, logout) ...
    // (Mevcut fonksiyonlarınız burada yer alacak)

  </script>
</body>
</html>
