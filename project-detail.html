<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Detayları</title>
  <!-- ... (Google Fonts, Firebase SDK, jsPDF linkleri aynı kalacak) ... -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ... (mevcut stilleriniz aynı kalacak, index.html'deki category-checkbox-group stilleri buraya da eklenecek) ... */
    .category-checkbox-group { /* index.html'den alındı */
        margin-top: 15px;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 6px;
        background-color: #fdfdfd;
    }
    .category-checkbox-group legend {
        font-weight: 600;
        padding: 0 5px;
        margin-left: 5px;
        color: #34495e;
    }
    .category-checkbox-group label {
        display: inline-block; 
        margin-right: 15px;
        font-weight: normal; 
        cursor: pointer;
    }
    .category-checkbox-group input[type="checkbox"] {
        width: auto; 
        margin-right: 5px;
        vertical-align: middle;
    }
    /* ... (diğer mevcut stilleriniz) ... */
  </style>
</head>
<body>
  <header>
    <!-- ... (header içeriği) ... -->
  </header>
  <main>
    <section>
      <h3>Genel Bilgiler</h3>
      <div class="input-group">
        <div style="flex: 2;">
          <label for="projectName">Proje Adı</label>
          <input type="text" id="projectName" class="readonly" readonly />
        </div>
        <div style="flex: 2;">
          <label for="clientName">Müşteri Adı</label>
          <input type="text" id="clientName" class="readonly" readonly />
        </div>
        <div style="flex: 1;">
          <label for="projectStatus">Proje Durumu</label>
          <select id="projectStatus" onchange="updateProjectStatus(this.value)">
            <option value="Başlamadı">Başlamadı</option>
            <option value="Devam Ediyor">Devam Ediyor</option>
            <option value="Tamamlandı">Tamamlandı</option>
          </select>
        </div>
      </div>

      <!-- PROJE KATEGORİLERİ CHECKBOX BÖLÜMÜ -->
      <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer">
          <legend>Proje Kategorileri</legend>
          <!-- Checkbox'lar JavaScript ile buraya eklenecek -->
      </fieldset>
      <!-- PROJE KATEGORİLERİ CHECKBOX BÖLÜMÜ SONU -->
      
      <h3>Aşamalar & Sorumlular</h3>
      <!-- ... (Aşamalar Tablosu) ... -->
      <table id="stagesTable"> /* ... */ </table>
      
      <div class="input-group" style="margin-top: 20px;">
        <!-- ... (Sözleşme Başlangıcı, Bitişi) ... -->
      </div>
    </section>

    <!-- ... (Sözleşme ve Kar Hesapları, Harcama Kalemleri, Proje Dosyaları bölümleri aynı kalacak) ... -->
    <section style="margin-top: 30px;"> /* ... */ </section>
    <section style="margin-top: 30px;"> /* ... */ </section>
    <section style="margin-top: 30px;"> /* ... */ </section>

    <div style="margin-top: 30px; padding-bottom: 30px;">
        <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
        <button onclick="generateReport()" style="margin-left:10px; background:#16a085;">Rapor İndir (PDF)</button>
        <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
    </div>
  </main>

  <script>
    // ... (Firebase config, app, db, auth, storage, jsPDF tanımlamaları aynı) ...
    const firebaseConfig = { /* ... */ };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    const { jsPDF } = window.jspdf;

    let projectId = null;
    const predefinedStageNames = [ /* ... */ ];
    const defaultProjectStatus = "Başlamadı";

    // Proje Kategorileri Tanımı (index.html ile aynı olmalı)
    const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];

    // Para formatlama fonksiyonları (formatCurrencyTR, parseCurrencyTR, handleCurrencyInput, formatCurrencyOnBlur)
    // ... (önceki mesajdaki gibi aynı kalacaklar) ...
    function formatCurrencyTR(numberStrOrNum) { /* ... */ }
    function parseCurrencyTR(formattedValue) { /* ... */ }
    function handleCurrencyInput(event) { /* ... */ }
    function formatCurrencyOnBlur(event) { /* ... */ }

    // Kategori checkbox'larını oluşturma fonksiyonu (index.html'deki ile benzer)
    function renderDetailCategoryCheckboxes() {
        const container = document.getElementById('projectCategoriesCheckboxesContainer');
        if (!container) return;
        
        // Legend'ı koru veya yeniden oluştur
        let legend = container.querySelector('legend');
        if (!legend) {
            legend = document.createElement('legend');
            legend.textContent = 'Proje Kategorileri';
        }
        container.innerHTML = ""; // Temizle ama legend'ı kaybetmemek için sonra ekle
        container.appendChild(legend);


        projectCategories.forEach(category => {
            const checkboxId = `detail_${category.replace(/\s+/g, '-').toLowerCase()}`; // ID prefix'i farklı olsun
            const wrapper = document.createElement('span'); 
            wrapper.style.marginRight = "15px"; 
            wrapper.style.display = "inline-block";

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.value = category;
            checkbox.name = 'project_category_detail';
            checkbox.style.marginRight = "5px";
            checkbox.style.verticalAlign = "middle";
            checkbox.onchange = updateProjectCategories; // Değişiklikte güncelleme fonksiyonunu çağır

            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.textContent = category;
            label.style.fontWeight = "normal";
            label.style.cursor = "pointer";
            label.style.verticalAlign = "middle";
            
            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            container.appendChild(wrapper);
        });
    }

    auth.onAuthStateChanged(user => { /* ... (mevcut kod aynı) ... */ });

    async function loadProject() {
      if (!projectId) return;
      try {
        renderDetailCategoryCheckboxes(); // ÖNCE CHECKBOX'LARI OLUŞTUR

        const projectRef = db.collection("projects").doc(projectId);
        const projectDoc = await projectRef.get();
        if (!projectDoc.exists) { /* ... */ return; }
        const p = projectDoc.data();

        document.getElementById("projectName").value = p.name || "";
        document.getElementById("clientName").value = p.client || "";
        document.getElementById("startDate").value = p.startDate || "";
        document.getElementById("endDate").value = p.endDate || "";
        document.getElementById("contractValue").value = formatCurrencyTR(p.contractValue || 0);
        document.getElementById("projectStatus").value = p.status || defaultProjectStatus;

        // Kayıtlı kategorilere göre checkbox'ları işaretle
        if (p.categories && Array.isArray(p.categories)) {
            p.categories.forEach(savedCategory => {
                const checkboxId = `detail_${savedCategory.replace(/\s+/g, '-').toLowerCase()}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // ... (stages, expenses, files, calculations yükleme kodları aynı) ...
        let stagesData = p.stages || []; /* ... */ renderStages(stagesData);
        renderExpenses(p.expenses || []);
        renderFiles(p.files || []);
        updateCalculations();

      } catch (error) { /* ... */ }
    }
    
    // Kategori güncelleme fonksiyonu
    async function updateProjectCategories() {
        if (!projectId) return;

        const selectedCategories = [];
        const checkboxes = document.querySelectorAll('#projectCategoriesCheckboxesContainer input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            selectedCategories.push(checkbox.value);
        });

        try {
            const projectRef = db.collection("projects").doc(projectId);
            await projectRef.update({
                categories: selectedCategories
            });
            console.log("Proje kategorileri güncellendi:", selectedCategories);
        } catch (error) {
            console.error("Proje kategorileri güncellenirken hata:", error);
            alert("Proje kategorileri güncellenirken bir hata oluştu.");
        }
    }


    // ... (renderStages, saveStageField, updateProjectStatus, renderExpenses, addExpense, removeExpense, ...)
    // ... (updateCalculations, saveDetails, renderFiles, uploadFile, deleteFile, generateReport, goBack, logout) ...
    // (Mevcut diğer fonksiyonlarınız burada yer alacak)

  </script>
</body>
</html>
