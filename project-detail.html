<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Proje Detayları</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f4f4f4; 
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2c3e50;
      color: white;
      padding: 10px 20px;
    }
    .logo-title-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-title-container img {
      height: 40px;
    }
    .logo-title-container h1 {
      font-size: 1.2em;
      margin: 0;
    }
    main {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2, h3 {
      color: #333;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="date"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .readonly {
      background-color: #eee;
      color: #555;
    }
    .category-checkbox-group label {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 10px;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-title-container">
    <img src="https://powerlinemersin.github.io/projetakip/logo.png"  alt="Logo" />
    <h1>Proje Detayları</h1>
  </div>
  <div class="header-content-right">
    <button onclick="logout()" style="background:#e74c3c; color:white;">Çıkış Yap</button>
  </div>
</header>

<main>
  <section>
    <h3>Genel Bilgiler</h3>
    <div class="input-group">
      <div style="flex: 2;">
        <label for="projectName">Proje Adı</label>
        <input type="text" id="projectName" class="readonly" readonly />
      </div>
      <div style="flex: 2;">
        <label for="clientName">Müşteri Adı</label>
        <input type="text" id="clientName" class="readonly" readonly />
      </div>
    </div>
    <div class="input-group">
      <div style="flex: 1;">
        <label for="projectStatus">Proje Durumu</label>
        <select id="projectStatus" onchange="updateProjectStatus(this.value)">
          <option value="Başlamadı">Başlamadı</option>
          <option value="Devam Ediyor">Devam Ediyor</option>
          <option value="Takip Ediliyor">Takip Ediliyor</option>
          <option value="Tamamlandı">Tamamlandı</option>
        </select>
      </div>
    </div>
    <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer">
      <legend>Proje Kategorileri</legend>
    </fieldset>
  </section>

  <section style="margin-top: 30px;">
    <h3>Sözleşme ve Kar Hesapları</h3>
    <div class="input-group">
      <div>
        <label for="contractValue">Sözleşme Tutarı</label>
        <input type="text" id="contractValue" placeholder="0,00" readonly class="readonly" />
      </div>
    </div>
    <p id="profitSummary" style="font-weight:bold; margin-top: 10px;"></p>
  </section>

  <section style="margin-top: 30px;">
    <h3>Harcama Listesi</h3>
    <p id="noExpensesMessage" style="color:#999;">Bu projeye henüz harcama eklenmemiş.</p>
    <table id="expensesTable">
      <thead>
        <tr>
          <th>Açıklama</th>
          <th>Orijinal Tutar</th>
          <th>P.B.</th>
          <th>Kur Tarihi</th>
          <th>Kur Oranı</th>
          <th style="text-align:right;">Tutar (TL)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top: 30px;">
    <h3>Tahsilat Listesi</h3>
    <p id="noCollectionsMessage" style="color:#999;">Bu projeye henüz tahsilat eklenmemiş.</p>
    <table id="collectionsTable">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Tip</th>
          <th>Vade Tarihi</th>
          <th>Orijinal Tutar</th>
          <th>P.B.</th>
          <th>Kur Tarihi</th>
          <th>Kur Oranı</th>
          <th style="text-align:right;">Tutar/Değer (TL)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top: 30px;">
    <h3>Proje Dosyaları</h3>
    <ul id="fileList"></ul>
    <p id="noProjectFilesMessage" style="color:#999;">Bu projeye ait dosya yok.</p>
  </section>

  <div style="margin-top: 30px;">
    <button onclick="goBack()">Geri Dön</button>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

<script>
  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
    authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
    projectId: "projetakipsistemi-fbabd"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let projectId = null;

  const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];

  function formatCurrencyTR(val) {
    let n = typeof val === 'string' ? parseFloat(val.replace(/\./g,'').replace(',','.')) : val;
    return isNaN(n) ? "0,00" : n.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  async function renderDetailCategoryCheckboxes() {
    const container = document.getElementById("projectCategoriesCheckboxesContainer");
    if (!container) return;
    container.innerHTML = "";
    const legend = document.createElement("legend");
    legend.textContent = "Proje Kategorileri";
    container.appendChild(legend);
    projectCategories.forEach(cat => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${cat}" disabled>${cat}`;
      container.appendChild(label);
    });
  }

  async function loadProject() {
    const params = new URLSearchParams(window.location.search);
    projectId = params.get("id");

    if (!projectId) {
      alert("Proje ID'si bulunamadı.");
      goBack();
      return;
    }

    try {
      const doc = await db.collection("projects").doc(projectId).get();
      if (!doc.exists) {
        alert("Proje bulunamadı.");
        goBack();
        return;
      }

      const p = doc.data();

      document.getElementById("projectName").value = p.name || "N/A";
      document.getElementById("clientName").value = p.client || "N/A";
      document.getElementById("projectStatus").value = p.status || "Başlamadı";

      const checkboxes = document.querySelectorAll("#projectCategoriesCheckboxesContainer input[type='checkbox']");
      checkboxes.forEach(cb => cb.checked = p.categories?.includes(cb.value));

      document.getElementById("contractValue").value = formatCurrencyTR(p.contractValue || 0);

      if (p.expenses && Array.isArray(p.expenses)) {
        renderExpenses(p.expenses);
      } else {
        document.getElementById("noExpensesMessage").style.display = "block";
      }

      if (p.collections && Array.isArray(p.collections)) {
        renderCollections(p.collections);
      } else {
        document.getElementById("noCollectionsMessage").style.display = "block";
      }

      if (p.files && p.files.length > 0) {
        renderFiles(p.files);
      } else {
        document.getElementById("noProjectFilesMessage").style.display = "block";
      }

    } catch (e) {
      console.error("Proje yükleme hatası:", e);
      alert("Proje detayları yüklenirken bir hata oluştu.");
      goBack();
    }
  }

  function renderExpenses(expenses) {
    const tbody = document.querySelector("#expensesTable tbody");
    tbody.innerHTML = "";
    expenses.forEach(exp => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${exp.desc || "-"}</td>
        <td style="text-align:right;">${formatCurrencyTR(exp.originalAmount)}</td>
        <td>${exp.currency || "TRY"}</td>
        <td>${exp.exchangeRateDate || "-"}</td>
        <td>${exp.exchangeRate ? formatCurrencyTR(exp.exchangeRate) : "-"}</td>
        <td style="text-align:right;">${formatCurrencyTR(exp.amountInTRY)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderCollections(collections) {
    const tbody = document.querySelector("#collectionsTable tbody");
    tbody.innerHTML = "";
    collections.forEach(col => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${col.date || "-"}</td>
        <td>${col.type || "-"}</td>
        <td>${col.checkDetails?.dueDate || "-"}</td>
        <td style="text-align:right;">${formatCurrencyTR(col.originalAmount || 0)}</td>
        <td>${col.currency || "TRY"}</td>
        <td>${col.exchangeRateDate || "-"}</td>
        <td>${col.exchangeRate ? formatCurrencyTR(col.exchangeRate) : "-"}</td>
        <td style="text-align:right;">${formatCurrencyTR(col.amountInTRY || 0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderFiles(files) {
    const ul = document.getElementById("fileList");
    ul.innerHTML = "";
    files.forEach(file => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${file.description || file.name}</span>`;
      ul.appendChild(li);
    });
  }

  function updateProjectStatus(newSt) {
    db.collection("projects").doc(projectId).update({ status: newSt });
  }

  function goBack() {
    window.location.href = "index.html";
  }

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    }).catch(err => {
      console.error("Çıkış yapılırken hata:", err);
    });
  }

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      renderDetailCategoryCheckboxes();
      loadProject();
    }
  });

</script>

</body>
</html>
