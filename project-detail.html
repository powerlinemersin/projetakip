<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Proje Detayı</title>
  <style>
    body { font-family: sans-serif; margin: 40px; background: #f5f5f5; }
    label { display: block; margin-top: 10px; }
    input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    input[readonly] {
      background-color: #eee;
      border: 1px solid #ccc;
      color: #555;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button { margin-top: 20px; padding: 10px 20px; background-color: #3498db; color: white; border: none; cursor: pointer; }
    .profit-positive { color: green; font-weight: bold; }
    .profit-negative { color: red; font-weight: bold; }
    input[type=number] { width: 80px; }
  </style>
</head>
<body>
  <h1>Proje Detayları</h1>
  <form id="projectForm">
    <label>Proje Adı
      <input type="text" id="name" readonly />
    </label>
    <label>Müşteri Adı
      <input type="text" id="client" readonly />
    </label>
    <label>Başlangıç Tarihi
      <input type="date" id="startDate" readonly />
    </label>
    <label>Bitiş Tarihi
      <input type="date" id="endDate" readonly />
    </label>

    <h3>Aşamalar & Sorumlular</h3>
    <table id="milestonesTable">
      <thead>
        <tr>
          <th>Aşama</th>
          <th>Sorumlu Kişi</th>
          <th>Planlanan Süre (gün)</th>
          <th>Tamamlandı mı?</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Bütçe Yönetimi</h3>
    <label>Tahmini Bütçe (₺)
      <input type="number" id="estimatedBudget" min="0" step="0.01" />
    </label>
    <label>Gerçekleşen Bütçe (₺)
      <input type="number" id="actualBudget" min="0" step="0.01" />
    </label>
    <label>Gerçekleşen Kar (₺)
      <input type="text" id="profit" readonly />
    </label>
    <label>Kar Marjı (%)
      <input type="text" id="profitMargin" readonly />
    </label>

    <button type="button" onclick="saveProject()">Kaydet</button>
  </form>

  <script>
    const stages = [
      "Keşif / Ön görüşme",
      "Teklif oluşturma",
      "Onay – sözleşme",
      "Malzeme temini",
      "Uygulama",
      "Test ve devreye alma",
      "Teslimat"
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const projects = JSON.parse(localStorage.getItem('projects') || '[]');

    if (id === null || !projects[id]) {
      alert('Geçersiz proje!');
      window.location.href = 'index.html';
    }

    const proj = projects[id];

    // Proje temel bilgilerini doldur (readonly)
    document.getElementById('name').value = proj.name;
    document.getElementById('client').value = proj.client;
    document.getElementById('startDate').value = proj.startDate;
    document.getElementById('endDate').value = proj.endDate;

    // Aşamalar tablosunu oluştur
    const tbody = document.querySelector("#milestonesTable tbody");
    const milestones = proj.milestones || {};
    stages.forEach(stage => {
      const data = milestones[stage] || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${stage}</td>
        <td><input type="text" class="responsible" value="${data.responsible || ''}" /></td>
        <td><input type="number" class="duration" min="0" value="${data.duration || ''}" /></td>
        <td style="text-align:center;"><input type="checkbox" class="completed" ${data.completed ? 'checked' : ''} /></td>
      `;
      tbody.appendChild(tr);
    });

    // Bütçe alanlarını doldur
    document.getElementById('estimatedBudget').value = proj.estimatedBudget || '';
    document.getElementById('actualBudget').value = proj.actualBudget || '';

    // Kar ve marj hesapla ve göster
    function calculateProfit() {
      const estimated = parseFloat(document.getElementById('estimatedBudget').value) || 0;
      const actual = parseFloat(document.getElementById('actualBudget').value) || 0;
      const profit = estimated - actual;
      const profitMargin = estimated ? (profit / estimated) * 100 : 0;

      const profitField = document.getElementById('profit');
      const marginField = document.getElementById('profitMargin');

      profitField.value = profit.toFixed(2);
      marginField.value = profitMargin.toFixed(2);

      if (profit >= 0) {
        profitField.className = 'profit-positive';
        marginField.className = 'profit-positive';
      } else {
        profitField.className = 'profit-negative';
        marginField.className = 'profit-negative';
      }
    }

    document.getElementById('estimatedBudget').addEventListener('input', calculateProfit);
    document.getElementById('actualBudget').addEventListener('input', calculateProfit);
    calculateProfit();

    function saveProject() {
      const updatedMilestones = {};
      const rows = tbody.querySelectorAll('tr');

      rows.forEach(row => {
        const stageName = row.cells[0].textContent;
        const responsible = row.querySelector('.responsible').value.trim();
        const duration = parseInt(row.querySelector('.duration').value) || 0;
        const completed = row.querySelector('.completed').checked;

        updatedMilestones[stageName] = { responsible, duration, completed };
      });

      projects[id] = {
        ...projects[id],  // mevcut diğer verileri koru
        milestones: updatedMilestones,
        estimatedBudget: parseFloat(document.getElementById('estimatedBudget').value) || 0,
        actualBudget: parseFloat(document.getElementById('actualBudget').value) || 0,
      };

      localStorage.setItem('projects', JSON.stringify(projects));
      alert('Proje güncellendi!');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
