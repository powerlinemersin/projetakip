<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Proje Detayı</title>
  <style>
    body { font-family: sans-serif; margin: 40px; background: #f5f5f5; }
    label { display: block; margin-top: 10px; }
    input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button { margin-top: 20px; padding: 10px 20px; background-color: #3498db; color: white; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Proje Detayları</h1>
  <form id="projectForm">
    <label>Proje Adı<input type="text" id="name" /></label>
    <label>Müşteri Adı<input type="text" id="client" /></label>
    <label>Başlangıç Tarihi<input type="date" id="startDate" /></label>
    <label>Bitiş Tarihi<input type="date" id="endDate" /></label>

    <h3>Aşamalar & Takip</h3>
    <table id="milestoneTable">
      <thead>
        <tr>
          <th>Aşama</th>
          <th>Sorumlu</th>
          <th>Süre (gün)</th>
          <th>Tamamlandı</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button type="button" onclick="saveProject()">Kaydet</button>
  </form>

  <script>
    const defaultMilestones = [
      "Keşif / Ön görüşme",
      "Teklif oluşturma",
      "Onay – sözleşme",
      "Malzeme temini",
      "Uygulama",
      "Test ve devreye alma",
      "Teslimat"
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const projects = JSON.parse(localStorage.getItem('projects') || '[]');

    const nameInput = document.getElementById('name');
    const clientInput = document.getElementById('client');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const milestoneTableBody = document.querySelector('#milestoneTable tbody');

    let currentProject = null;

    function loadMilestones(data = []) {
      milestoneTableBody.innerHTML = '';
      defaultMilestones.forEach((title, index) => {
        const row = document.createElement('tr');
        const existing = data[index] || {};

        row.innerHTML = `
          <td>${title}</td>
          <td><input type="text" value="${existing.responsible || ''}" data-index="${index}" data-field="responsible" /></td>
          <td><input type="number" value="${existing.duration || ''}" data-index="${index}" data-field="duration" /></td>
          <td><input type="checkbox" ${existing.done ? 'checked' : ''} data-index="${index}" data-field="done" /></td>
        `;
        milestoneTableBody.appendChild(row);
      });
    }

    if (id !== null && projects[id]) {
      currentProject = projects[id];
      nameInput.value = currentProject.name;
      clientInput.value = currentProject.client;
      startDateInput.value = currentProject.startDate;
      endDateInput.value = currentProject.endDate;
      loadMilestones(currentProject.milestones || []);
    } else {
      loadMilestones();
    }

    function saveProject() {
      if (id === null) return alert('Geçersiz proje!');

      const updatedMilestones = defaultMilestones.map((title, index) => {
        const responsible = document.querySelector(`input[data-index="${index}"][data-field="responsible"]`).value;
        const duration = document.querySelector(`input[data-index="${index}"][data-field="duration"]`).value;
        const done = document.querySelector(`input[data-index="${index}"][data-field="done"]`).checked;
        return { title, responsible, duration, done };
      });

      projects[id] = {
        ...projects[id],
        name: nameInput.value.trim(),
        client: clientInput.value.trim(),
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        milestones: updatedMilestones
      };

      localStorage.setItem('projects', JSON.stringify(projects));
      alert('Proje güncellendi!');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
