<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Detayları</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- jsPDF Kütüphaneleri (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f9fbfd;
      color: #2c3e50;
    }
    header {
      background-color: #34495e;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header img {
      height: 40px;
      width: auto;
    }
    header h1 {
      font-weight: 600;
      font-size: 1.6rem;
      margin: 0;
      user-select: none;
    }
    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }
    h3 {
        color: #34495e;
        margin-top: 30px;
        margin-bottom: 15px;
        border-bottom: 2px solid #2980b9;
        padding-bottom: 8px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input, button, select, textarea {
      padding: 10px 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #2980b9;
      box-shadow: 0 0 5px #2980b9;
    }
    button {
      background-color: #2980b9;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      margin-top: 10px;
      border-radius: 6px;
      width: auto;
      padding: 10px 20px;
    }
    button:hover {
      background-color: #1c5980;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 25px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 14px 18px;
      border-bottom: 1px solid #e3e6ea;
      text-align: left;
    }
    thead {
      background-color: #2980b9;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background-color: #ecf6fc;
    }
    .input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }
    .input-group > div {
      flex: 1;
      min-width: 150px;
    }
    .readonly {
        background-color: #f0f0f0;
        cursor: not-allowed;
    }
    input[type="text"].currency-input {
        text-align: right;
    }
     .category-checkbox-group {
        margin-top: 15px;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 6px;
        background-color: #fdfdfd;
    }
    .category-checkbox-group legend {
        font-weight: 600; padding: 0 5px; margin-left: 5px; color: #34495e;
    }
    .category-checkbox-group label {
        display: inline-block; margin-right: 15px; font-weight: normal; cursor: pointer;
    }
    .category-checkbox-group input[type="checkbox"] {
        width: auto; margin-right: 5px; vertical-align: middle;
    }
    .file-list {
        list-style-type: none; padding: 0;
    }
    .file-list li {
        background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px;
        margin-bottom: 5px; border-radius: 4px; display: flex;
        justify-content: space-between; align-items: center;
    }
    .file-list a { color: #007bff; text-decoration: none; }
    .file-list a:hover { text-decoration: underline; }
    .delete-file-btn {
        background-color: #dc3545; color: white; border: none; padding: 5px 8px;
        border-radius: 4px; cursor: pointer; font-size: 0.8em;
    }
    .delete-file-btn:hover { background-color: #c82333; }
    #uploadProgress {
        width: 100%; background-color: #e9ecef; border-radius: .25rem;
        margin-top: 5px; height: 10px; display: none;
    }
    #uploadProgressBar {
        width: 0%; height: 100%; background-color: #28a745; border-radius: .25rem;
        text-align: center; line-height: 10px; color: white; font-size: 0.7em;
    }
    @media (max-width: 768px) {
      header { flex-direction: column; gap: 10px; padding: 20px; }
      .input-group { flex-direction: column; align-items: stretch; }
      .input-group > div { min-width: 100%; }
      .input-group button { width: 100%; margin-top: 10px; }
      .file-upload-input-group > div:last-child button { margin-top: 10px; }
      .category-checkbox-group label { margin-bottom: 5px; }
      #stagesTable, #expensesTable { display: block; width: 100%; }
      #stagesTable thead, #expensesTable thead { display: none; }
      #stagesTable tbody, #expensesTable tbody { display: block; width: 100%; }
      #stagesTable tr, #expensesTable tr {
        display: block; margin-bottom: 15px; background: white; border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 10px; border: 1px solid #ddd;
      }
      #stagesTable td, #expensesTable td {
        display: flex; justify-content: space-between; padding: 8px 0;
        border-bottom: 1px solid #eee; text-align: right;
      }
      #stagesTable td:last-child, #expensesTable td:last-child { border-bottom: 0; }
      #stagesTable td::before, #expensesTable td::before {
        font-weight: bold; margin-right: 10px; text-align: left; flex-grow: 1;
      }
      #stagesTable tbody td:nth-of-type(1)::before { content: "Aşama:"; }
      #stagesTable tbody td:nth-of-type(2)::before { content: "Sorumlu Kişi:"; }
      #stagesTable tbody td:nth-of-type(3)::before { content: "Tarih:"; }
      #stagesTable tbody td:nth-of-type(4)::before { content: "Tamamlandı mı?:"; }
      #expensesTable tbody td:nth-of-type(1)::before { content: "Açıklama:"; }
      #expensesTable tbody td:nth-of-type(2)::before { content: "Tutar (TL):"; }
      #expensesTable tbody td:nth-of-type(3)::before { content: "İşlem:"; }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://via.placeholder.com/150x40?text=Logo" alt="Şirket Logosu" />
    <h1>Proje Detayları</h1>
    <button onclick="logout()" style="margin-left:auto; background:#e74c3c; color:white;">Çıkış Yap</button>
  </header>
  <main>
    <section>
      <h3>Genel Bilgiler</h3>
      <div class="input-group">
        <div style="flex: 2;">
          <label for="projectName">Proje Adı</label>
          <input type="text" id="projectName" class="readonly" readonly />
        </div>
        <div style="flex: 2;">
          <label for="clientName">Müşteri Adı</label>
          <input type="text" id="clientName" class="readonly" readonly />
        </div>
        <div style="flex: 1;">
          <label for="projectStatus">Proje Durumu</label>
          <select id="projectStatus" onchange="updateProjectStatus(this.value)">
            <option value="Başlamadı">Başlamadı</option>
            <option value="Devam Ediyor">Devam Ediyor</option>
            <option value="Tamamlandı">Tamamlandı</option>
          </select>
        </div>
      </div>

      <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer">
          <legend>Proje Kategorileri</legend>
      </fieldset>
      
      <h3>Aşamalar & Sorumlular</h3>
      <table id="stagesTable">
        <thead>
          <tr>
            <th>Aşama</th>
            <th>Sorumlu Kişi</th>
            <th>Tarih</th>
            <th>Tamamlandı mı?</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <div class="input-group" style="margin-top: 20px;">
        <div>
          <label for="startDate">Sözleşme Başlangıcı</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label for="endDate">Sözleşme Bitişi</label>
          <input type="date" id="endDate" />
        </div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Sözleşme ve Kar Hesapları</h3>
      <div class="input-group">
          <div>
            <label for="contractValue">Sözleşme Tutarı (TL)</label>
            <input type="text" id="contractValue" class="currency-input" placeholder="0,00"
                   oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event)"/>
          </div>
          <div>
            <label for="totalExpenses">Toplam Harcama (TL)</label>
            <input type="text" id="totalExpenses" class="readonly currency-input" readonly />
          </div>
      </div>
      <div class="input-group">
          <div>
            <label for="realizedProfit">Gerçekleşen Kar (TL)</label>
            <input type="text" id="realizedProfit" class="readonly currency-input" readonly />
          </div>
          <div>
            <label for="realizedProfitMargin">Gerçekleşen Kar Marjı (%)</label>
            <input type="text" id="realizedProfitMargin" class="readonly" readonly style="text-align: right;"/>
          </div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Harcama Kalemleri</h3>
      <table id="expensesTable">
        <thead>
          <tr>
            <th>Açıklama</th>
            <th>Tutar (TL)</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="input-group" style="margin-top: 15px;">
        <div><input type="text" id="expenseDesc" placeholder="Açıklama" /></div>
        <div>
            <input type="text" id="expenseAmount" class="currency-input" placeholder="0,00"
                   oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event)"/>
        </div>
        <div><button onclick="addExpense()">Harcama Ekle</button></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Proje Dosyaları</h3>
        <div class="input-group file-upload-input-group">
            <div>
                <label for="fileUploadInput">Dosya Seç</label>
                <input type="file" id="fileUploadInput" />
            </div>
            <div>
                <button onclick="uploadFile()">Yükle</button>
            </div>
        </div>
        <div id="uploadProgress"><div id="uploadProgressBar"></div></div>
        <h4 style="margin-top: 20px;">Yüklenmiş Dosyalar:</h4>
        <ul id="fileList" class="file-list"></ul>
        <p id="noFilesMessage" style="display:none;">Bu projeye henüz dosya yüklenmemiş.</p>
    </section>

    <div style="margin-top: 30px; padding-bottom: 30px;">
        <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
        <button onclick="generateReport()" style="margin-left:10px; background:#16a085;">Rapor İndir (PDF)</button>
        <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
    </div>
  </main>

  <script>
    // Firebase yapılandırması
    const firebaseConfig = {
      apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
      authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
      projectId: "projetakipsistemi-fbabd",
      storageBucket: "projetakipsistemi-fbabd.appspot.com",
      messagingSenderId: "335282912485",
      appId: "1:335282912485:web:5ad9091ccf3cabd8f8280c"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    const { jsPDF } = window.jspdf;

    let projectId = null;
    const predefinedStageNames = [
      "Keşif / Ön görüşme", "Teklif oluşturma", "Onay – sözleşme", 
      "Malzeme temini", "Uygulama", "Test ve devreye alma", "Teslimat"
    ];
    const defaultProjectStatus = "Başlamadı";
    const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];

    // PARA FORMATLAMA
    function formatCurrencyTR(numberStrOrNum) {
        let number = typeof numberStrOrNum === 'string' ? parseFloat(numberStrOrNum.replace(/\./g, '').replace(',', '.')) : numberStrOrNum;
        if (isNaN(number)) return "0,00";
        return number.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function parseCurrencyTR(formattedValue) {
        if (typeof formattedValue !== 'string' || !formattedValue.trim()) return 0;
        const cleanedValue = formattedValue.replace(/\./g, '').replace(',', '.');
        const number = parseFloat(cleanedValue);
        return isNaN(number) ? 0 : number;
    }
    function handleCurrencyInput(event) {
        const input = event.target; let value = input.value;
        let numericValue = value.replace(/[^0-9,]/g, ''); 
        const parts = numericValue.split(',');
        if (parts.length > 2) { numericValue = parts[0] + ',' + parts.slice(1).join('');}
        input.value = numericValue; 
    }
    function formatCurrencyOnBlur(event) {
        const input = event.target;
        const numericValue = parseCurrencyTR(input.value);
        input.value = formatCurrencyTR(numericValue);
        updateCalculations(); 
    }

    // KATEGORİ CHECKBOX
    function renderDetailCategoryCheckboxes() {
        const container = document.getElementById('projectCategoriesCheckboxesContainer');
        if (!container) return;
        let legend = container.querySelector('legend');
        if (!legend) { legend = document.createElement('legend'); legend.textContent = 'Proje Kategorileri'; }
        container.innerHTML = ""; container.appendChild(legend);
        projectCategories.forEach(category => {
            const checkboxId = `detail_${category.replace(/\s+/g, '-').toLowerCase()}`;
            const wrapper = document.createElement('span'); 
            wrapper.style.marginRight = "15px"; wrapper.style.display = "inline-block";
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.id = checkboxId; checkbox.value = category;
            checkbox.name = 'project_category_detail'; checkbox.style.marginRight = "5px";
            checkbox.style.verticalAlign = "middle"; checkbox.onchange = updateProjectCategories;
            const label = document.createElement('label');
            label.htmlFor = checkboxId; label.textContent = category;
            label.style.fontWeight = "normal"; label.style.cursor = "pointer"; label.style.verticalAlign = "middle";
            wrapper.appendChild(checkbox); wrapper.appendChild(label); container.appendChild(wrapper);
        });
    }
    async function updateProjectCategories() {
        if (!projectId) return;
        const selectedCategories = [];
        document.querySelectorAll('#projectCategoriesCheckboxesContainer input[type="checkbox"]:checked').forEach(cb => selectedCategories.push(cb.value));
        try {
            await db.collection("projects").doc(projectId).update({ categories: selectedCategories });
            console.log("Proje kategorileri güncellendi:", selectedCategories);
        } catch (error) {
            console.error("Proje kategorileri güncellenirken hata:", error);
            alert("Proje kategorileri güncellenirken bir hata oluştu.");
        }
    }

    auth.onAuthStateChanged(user => {
      if (!user) { window.location.href = "login.html"; } 
      else {
        const params = new URLSearchParams(window.location.search); projectId = params.get("id");
        if (projectId) { loadProject(); } else { alert("Proje ID bulunamadı."); goBack(); }
      }
    });

    async function loadProject() {
      if (!projectId) return;
      try {
        renderDetailCategoryCheckboxes(); 
        const projectRef = db.collection("projects").doc(projectId);
        const projectDoc = await projectRef.get();
        if (!projectDoc.exists) { alert("Proje bulunamadı..."); goBack(); return; }
        const p = projectDoc.data();
        document.getElementById("projectName").value = p.name || "";
        document.getElementById("clientName").value = p.client || "";
        document.getElementById("startDate").value = p.startDate || "";
        document.getElementById("endDate").value = p.endDate || "";
        document.getElementById("contractValue").value = formatCurrencyTR(p.contractValue || 0);
        document.getElementById("projectStatus").value = p.status || defaultProjectStatus;
        if (p.categories && Array.isArray(p.categories)) {
            p.categories.forEach(cat => {
                const cbId = `detail_${cat.replace(/\s+/g, '-').toLowerCase()}`;
                const cb = document.getElementById(cbId); if (cb) cb.checked = true;
            });
        }
        let stagesData = p.stages || [];
        if (!stagesData.length || stagesData.length !== predefinedStageNames.length || stagesData.some((s, i) => s.name !== predefinedStageNames[i])) {
            stagesData = predefinedStageNames.map(name => {
                const es = stagesData.find(s1 => s1.name === name);
                return { name: name, responsible: es?.responsible||"", date: es?.date||"", completed: es?.completed||false };
            });
            if (!p.stages || p.stages.length === 0) { await projectRef.update({ stages: stagesData }); }
        }
        renderStages(stagesData); renderExpenses(p.expenses || []); renderFiles(p.files || []); updateCalculations();
      } catch (error) { console.error("Proje yüklenirken hata:", error); alert("Proje detayları yüklenirken bir hata oluştu."); }
    }

    function renderStages(stagesData) {
      const tbody = document.querySelector("#stagesTable tbody"); tbody.innerHTML = "";
      predefinedStageNames.forEach((stageName, i) => {
        let stage = stagesData.find(s => s.name === stageName) || { name: stageName, responsible: "", date: "", completed: false };
        const row = `<tr><td>${stage.name}</td><td><input type="text" value="${stage.responsible||''}" data-idx="${i}" data-field="responsible" class="stage-input"></td><td><input type="date" value="${stage.date||''}" data-idx="${i}" data-field="date" class="stage-input"></td><td><input type="checkbox" ${stage.completed?"checked":""} data-idx="${i}" data-field="completed" class="stage-input"></td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
      tbody.querySelectorAll(".stage-input").forEach(input => {
        const idx = parseInt(input.dataset.idx), field = input.dataset.field;
        input.addEventListener((field==="completed"?"change":"blur"), e => saveStageField(idx, field, (field==="completed"?e.target.checked:e.target.value)));
      });
    }

    async function saveStageField(index, field, value) {
      if (!projectId) return;
      try {
        const ref = db.collection("projects").doc(projectId); const doc = await ref.get(); if(!doc.exists) return;
        let stages = doc.data().stages || [];
        if (!stages.length || stages.length !== predefinedStageNames.length || stages.some((s,i) => s.name !== predefinedStageNames[i])) {
            stages = predefinedStageNames.map(n => ({name:n,responsible:"",date:"",completed:false}));
        }
        if (stages[index]) { stages[index][field] = value; stages[index].name = predefinedStageNames[index]; await ref.update({stages});}
      } catch (e) { console.error("Aşama kaydetme hatası:", e); }
    }

    async function updateProjectStatus(newStatus) {
        if (!projectId) return; try { await db.collection("projects").doc(projectId).update({status:newStatus}); console.log("Durum güncellendi:",newStatus); }
        catch(e){ console.error("Durum güncelleme hatası:",e); alert("Durum güncellenemedi.");}
    }

    function renderExpenses(list) {
      const tbody = document.querySelector("#expensesTable tbody"); tbody.innerHTML = "";
      (list||[]).forEach((item,idx) => {
        const row = `<tr><td>${item.desc}</td><td style="text-align:right;">${formatCurrencyTR(item.amount||0)}</td><td><button onclick="removeExpense(${idx})" class="delete-file-btn" style="padding:5px 8px;">Sil</button></td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    async function addExpense() {
      const desc = document.getElementById("expenseDesc").value.trim();
      const amountIn = document.getElementById("expenseAmount"); const amount = parseCurrencyTR(amountIn.value);
      if (!desc||isNaN(amount)||amount<=0) { alert("Geçerli açıklama ve tutar girin."); return; }
      try {
        const ref = db.collection("projects").doc(projectId);
        await ref.update({expenses: firebase.firestore.FieldValue.arrayUnion({desc, amount})});
        document.getElementById("expenseDesc").value=""; amountIn.value=formatCurrencyTR(0);
        const uDoc = await ref.get(); if(uDoc.exists) { renderExpenses(uDoc.data().expenses||[]); updateCalculations(); }
      } catch (e) { console.error("Harcama ekleme hatası:",e); alert("Harcama eklenemedi."); }
    }

    async function removeExpense(index) {
      if(!confirm("Bu harcamayı silmek istediğinizden emin misiniz?")) return;
      try {
        const ref = db.collection("projects").doc(projectId); const doc = await ref.get(); if(!doc.exists) return;
        let exp = doc.data().expenses||[]; exp.splice(index,1); await ref.update({expenses:exp});
        renderExpenses(exp); updateCalculations();
      } catch (e) { console.error("Harcama silme hatası:",e); alert("Harcama silinemedi."); }
    }

    function updateCalculations() {
      const contract = parseCurrencyTR(document.getElementById("contractValue").value);
      let totalCost=0; document.querySelectorAll("#expensesTable tbody tr").forEach(r => { totalCost += parseCurrencyTR(r.cells[1]?r.cells[1].innerText:"0,00");});
      const profit = contract - totalCost; const margin = contract>0?(profit/contract)*100:0;
      document.getElementById("totalExpenses").value = formatCurrencyTR(totalCost);
      document.getElementById("realizedProfit").value = formatCurrencyTR(profit);
      document.getElementById("realizedProfitMargin").value = margin.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
    }

    async function saveDetails() {
      const pRef = db.collection("projects").doc(projectId);
      try {
        await pRef.update({
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          contractValue: parseCurrencyTR(document.getElementById("contractValue").value)
        });
        alert("Sözleşme bilgileri kaydedildi."); updateCalculations();
      } catch(e){ console.error("Detay kaydetme hatası:",e); alert("Bilgiler kaydedilemedi.");}
    }

    function renderFiles(files) {
      const ul=document.getElementById("fileList"); const msg=document.getElementById("noFilesMessage"); ul.innerHTML="";
      if(files&&files.length>0){ msg.style.display="none"; files.forEach((f,i)=>{ul.innerHTML+=`<li><a href="${f.url}" target="_blank" title="İndir: ${f.name}">${f.name}</a><button class="delete-file-btn" onclick="deleteFile(${i},'${f.name}','${f.path}')">Sil</button></li>`;});}
      else{ msg.style.display="block"; }
    }

    async function uploadFile() {
      const fin = document.getElementById('fileUploadInput'); const f = fin.files[0];
      const pBarC = document.getElementById('uploadProgress'); const pBar = document.getElementById('uploadProgressBar');
      if (!f) { alert("Dosya seçin."); return; } if (!projectId) { alert("Proje ID yok."); return; }
      const fNameStore = `${Date.now()}_${f.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
      const fPath = `projects/${projectId}/${fNameStore}`; const fRef = storage.ref(fPath);
      try {
        const task = fRef.put(f); pBarC.style.display='block';
        task.on('state_changed', (s) => { const prog=(s.bytesTransferred/s.totalBytes)*100; pBar.style.width=prog+'%'; pBar.textContent=Math.round(prog)+'%';},
        (err) => { console.error("Yükleme hatası:",err); alert(`Yükleme hatası: ${err.message}`); pBarC.style.display='none';},
        async () => {
          pBarC.style.display='none'; pBar.style.width='0%'; pBar.textContent='';
          const url = await task.snapshot.ref.getDownloadURL(); const pRef = db.collection("projects").doc(projectId);
          await pRef.update({files:firebase.firestore.FieldValue.arrayUnion({name:f.name,url,path:fPath,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()})});
          alert("Dosya yüklendi!"); fin.value=""; const pDoc = await pRef.get(); if(pDoc.exists) renderFiles(pDoc.data().files||[]);
        });
      } catch (e) { console.error("Yükleme başlatma hatası:",e); alert("Yükleme başlatılamadı."); pBarC.style.display='none';}
    }

    async function deleteFile(idx, name, path) {
      if(!confirm(`"${name}" silinsin mi?`))return; if(!projectId||!path){alert("Silinemedi, bilgi eksik.");return;}
      try {
        await storage.ref(path).delete(); const pRef = db.collection("projects").doc(projectId); const pDoc = await pRef.get();
        if(pDoc.exists){ let files = pDoc.data().files||[]; files=files.filter(f=>f.path!==path); await pRef.update({files}); renderFiles(files); alert(`"${name}" silindi.`);}
      } catch (e) {
        console.error("Dosya silme hatası:", e);
        if (e.code==='storage/object-not-found'){ alert("Dosya Storage'da yok. DB kaydı siliniyor.");
            const pRef = db.collection("projects").doc(projectId); const pDoc = await pRef.get();
            if(pDoc.exists){ let files=pDoc.data().files||[]; files=files.filter(f=>f.path!==path); await pRef.update({files}); renderFiles(files);}
        } else { alert(`Silme hatası: ${e.message}`); }
      }
    }
    
    async function generateReport() {
        if (!projectId) { alert("Proje bulunamadı."); return; }
        const pRef = db.collection("projects").doc(projectId); const pDoc = await pRef.get();
        if (!pDoc.exists) { alert("Proje verisi yok."); return; } const p = pDoc.data();
        const doc = new jsPDF(); let y = 20; doc.setFontSize(18);
        doc.text("Proje Detay Raporu",105,y,{align:"center"}); y+=10; doc.setFontSize(12);
        doc.text(`Proje Adı: ${p.name||'N/A'}`,14,y); y+=7; doc.text(`Müşteri Adı: ${p.client||'N/A'}`,14,y); y+=7;
        doc.text(`Proje Durumu: ${p.status||defaultProjectStatus}`,14,y); y+=7;
        doc.text(`Söz. Başlangıcı: ${p.startDate||'N/A'}`,14,y); y+=7; doc.text(`Söz. Bitişi: ${p.endDate||'N/A'}`,14,y); y+=10;
        doc.setFontSize(14); doc.text("Proje Aşamaları",14,y); y+=7;
        doc.autoTable({startY:y, head:[["Aşama","Sorumlu","Tarih","Durum"]], body:(p.stages||[]).map(s=>[s.name||'N/A',s.responsible||'N/A',s.date||'N/A',s.completed?"Tamamlandı":"Tamamlanmadı"]), theme:'grid', headStyles:{fillColor:[52,73,94]}, styles:{fontSize:10}});
        y=doc.lastAutoTable.finalY+10; doc.setFontSize(14); doc.text("Harcama Kalemleri",14,y); y+=7;
        doc.autoTable({startY:y, head:[["Açıklama","Tutar (TL)"]], body:(p.expenses||[]).map(e=>[e.desc||'N/A',formatCurrencyTR(e.amount||0)]), theme:'grid', headStyles:{fillColor:[52,73,94]}, styles:{fontSize:10}, columnStyles:{1:{halign:'right'}}});
        y=doc.lastAutoTable.finalY+10; doc.setFontSize(14); doc.text("Finansal Özet",14,y); y+=7; doc.setFontSize(12);
        const contract=p.contractValue||0; const totalExp=(p.expenses||[]).reduce((sum,e)=>sum+(e.amount||0),0);
        const profit=contract-totalExp; const margin=contract>0?(profit/contract)*100:0;
        doc.text(`Sözleşme Tutarı: ${formatCurrencyTR(contract)} TL`,14,y); y+=7;
        doc.text(`Toplam Harcama: ${formatCurrencyTR(totalExp)} TL`,14,y); y+=7;
        doc.text(`Gerçekleşen Kar: ${formatCurrencyTR(profit)} TL`,14,y); y+=7;
        doc.text(`Kar Marjı: % ${margin.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2})}`,14,y); y+=10;
        doc.setFontSize(10); doc.text(`Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')}`,14,y);
        doc.save(`${p.name?p.name.replace(/[^a-zA-Z0-9]/g,'_'):'proje'}_rapor.pdf`); alert("Rapor indiriliyor.");
    }

    function goBack() { window.location.href = "index.html"; }
    function logout() { auth.signOut().then(()=>window.location.href="login.html").catch(e=>{console.error("Çıkış hatası:",e);alert("Çıkış hatası.");});}
  </script>
</body>
</html>
