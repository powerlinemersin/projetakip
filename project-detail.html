<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Proje Detayları</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f4f4f4; 
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2c3e50;
      color: white;
      padding: 10px 20px;
    }
    .logo-title-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-title-container img {
      height: 40px;
    }
    .logo-title-container h1 {
      font-size: 1.2em;
      margin: 0;
    }
    main {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    h2, h3 {
      color: #333;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="date"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .readonly {
      background-color: #eee;
      color: #555;
    }
    .category-checkbox-group label {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 10px;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .file-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
    }
    @media (max-width: 600px) {
      .input-group > div {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo-title-container">
    <img src="https://powerlinemersin.github.io/projetakip/logo.png"  alt="Logo" />
    <h1>Proje Detayları</h1>
  </div>
  <button onclick="logout()" style="background:#e74c3c; color:white;">Çıkış Yap</button>
</header>

<main>
  <section>
    <h3>Genel Bilgiler</h3>
    <div class="input-group">
      <div style="flex: 2;">
        <label for="projectName">Proje Adı</label>
        <input type="text" id="projectName" class="readonly" readonly />
      </div>
      <div style="flex: 2;">
        <label for="clientName">Müşteri Adı</label>
        <input type="text" id="clientName" class="readonly" readonly />
      </div>
    </div>
    <div class="input-group">
      <div style="flex: 1;">
        <label for="projectStatus">Proje Durumu</label>
        <select id="projectStatus" onchange="updateProjectStatus(this.value)">
          <option value="Başlamadı">Başlamadı</option>
          <option value="Devam Ediyor">Devam Ediyor</option>
          <option value="Takip Ediliyor">Takip Ediliyor</option>
          <option value="Tamamlandı">Tamamlandı</option>
        </select>
      </div>
    </div>
    <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer">
      <legend>Proje Kategorileri</legend>
    </fieldset>
  </section>

  <section style="margin-top: 30px;">
    <h3>Aşamalar</h3>
    <table id="stagesTable">
      <thead>
        <tr>
          <th>Aşama</th>
          <th>Tarih</th>
          <th>Tamamlandı mı?</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top: 30px;">
    <h3>Sözleşme ve Kar Hesapları</h3>
    <div class="input-group">
      <div>
        <label for="contractValue">Sözleşme Tutarı</label>
        <input type="text" id="contractValue" placeholder="0,00" oninput="this.value = formatCurrencyTR(this.value)" />
        <select id="contractCurrency" onchange="toggleContractRateDisplay()">
          <option value="TRY">TL</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
      </div>
      <div>
        <label for="startDate">Sözleşme Başlangıç Tarihi</label>
        <input type="date" id="startDate" onchange="fetchRatesAndUpdateCalculations('contractRates', this.value, true)" />
      </div>
    </div>
    <div id="contractRates" style="display:none;"></div>
    <button onclick="saveDetails()">Kaydet</button>
    <p id="profitSummary" style="font-weight:bold; margin-top: 10px;"></p>
  </section>

  <section style="margin-top: 30px;">
    <h3>Harcama Ekle</h3>
    <div class="input-group">
      <div><label for="expenseDesc">Açıklama</label><input type="text" id="expenseDesc" /></div>
      <div><label for="expenseAmount">Tutar</label><input type="text" id="expenseAmount" placeholder="0,00" oninput="this.value = formatCurrencyTR(this.value)" /></div>
      <div><label for="expenseCurrency">Para Birimi</label><select id="expenseCurrency"><option value="TRY">TL</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
      <div><label for="expenseDate">Harcama Tarihi</label><input type="date" id="expenseDate" /></div>
    </div>
    <div id="expenseRates" style="display:none;"></div>
    <button onclick="addExpense()">Harcama Ekle</button>
  </section>

  <section>
    <h3>Harcama Listesi</h3>
    <p id="noExpensesMessage" style="color:#999;">Bu projeye henüz harcama eklenmemiş.</p>
    <table id="expensesTable">
      <thead>
        <tr>
          <th>Açıklama</th>
          <th>Orijinal Tutar</th>
          <th>P.B.</th>
          <th>Kur Tarihi</th>
          <th>Kur Oranı</th>
          <th style="text-align:right;">Tutar (TL)</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top: 30px;">
    <h3>Tahsilat Ekle</h3>
    <div class="input-group">
      <div><label for="collectionDate">Tahsilat Tarihi</label><input type="date" id="collectionDate" /></div>
      <div><label for="collectionType">Tip</label><select id="collectionType"><option value="Nakit">Nakit</option><option value="Banka Havalesi">Banka Havalesi</option><option value="Çek">Çek</option><option value="Barter">Barter</option></select></div>
      <div><label for="collectionAmount">Tutar</label><input type="text" id="collectionAmount" placeholder="0,00" oninput="this.value = formatCurrencyTR(this.value)" /></div>
      <div><label for="collectionCurrency">Para Birimi</label><select id="collectionCurrency"><option value="TRY">TL</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
    </div>
    <button onclick="addCollection()">Tahsilat Ekle</button>
  </section>

  <section>
    <h3>Tahsilat Listesi</h3>
    <p id="noCollectionsMessage" style="color:#999;">Bu projeye henüz tahsilat eklenmemiş.</p>
    <table id="collectionsTable">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Tip</th>
          <th>Tutar (Orijinal)</th>
          <th>P.B.</th>
          <th>Kur Tarihi</th>
          <th>Kur Oranı</th>
          <th>Tutar (TL)</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <div style="margin-top: 30px;">
    <button onclick="goBack()">Geri Dön</button>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
    authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
    projectId: "projetakipsistemi-fbabd"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let projectId = null;

  const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];
  const predefinedStageNames = ["Keşif", "Teklif", "Onay", "Malzeme Temini", "Uygulama", "Test", "Teslimat"];

  function formatCurrencyTR(val) {
    let n = typeof val === 'string' ? parseFloat(val.replace(/\./g,'').replace(',','.')) : val;
    return isNaN(n) ? "0,00" : n.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function parseCurrencyTR(val) {
    return parseFloat(val.replace(/\./g, '').replace(',', '.'));
  }

  async function renderDetailCategoryCheckboxes() {
    const container = document.getElementById("projectCategoriesCheckboxesContainer");
    if (!container) return;
    container.innerHTML = "<legend>Proje Kategorileri</legend>";
    projectCategories.forEach(cat => {
      container.innerHTML += `<label><input type="checkbox" value="${cat}" disabled>${cat}</label>`;
    });
  }

  async function loadProject() {
    const params = new URLSearchParams(window.location.search);
    projectId = params.get("id");

    if (!projectId) {
      alert("Proje ID'si bulunamadı.");
      goBack();
      return;
    }

    try {
      const doc = await db.collection("projects").doc(projectId).get();
      if (!doc.exists) {
        alert("Proje bulunamadı.");
        goBack();
        return;
      }

      const p = doc.data();

      document.getElementById("projectName").value = p.name || "";
      document.getElementById("clientName").value = p.client || "";
      document.getElementById("projectStatus").value = p.status || "Başlamadı";

      // Kategoriler
      const checkboxes = document.querySelectorAll("#projectCategoriesCheckboxesContainer input[type='checkbox']");
      checkboxes.forEach(cb => cb.checked = p.categories?.includes(cb.value));

      // Aşamalar
      const stages = p.stages || [];
      renderStages(stages);

      // Harcamalar
      if (p.expenses && Array.isArray(p.expenses)) {
        renderExpenses(p.expenses);
      } else {
        document.getElementById("noExpensesMessage").style.display = "block";
      }

      // Tahsilatlar
      if (p.collections && Array.isArray(p.collections)) {
        renderCollections(p.collections);
      } else {
        document.getElementById("noCollectionsMessage").style.display = "block";
      }

      // Sözleşme bilgisi
      if (p.contractValue !== undefined) {
        document.getElementById("contractValue").value = formatCurrencyTR(p.contractValue);
        document.getElementById("contractCurrency").value = p.contractCurrency || "TRY";
      }

      if (p.startDate) {
        document.getElementById("startDate").value = p.startDate;
      }

      // Kur bilgisi güncelle
      if (p.contractDateForRate) {
        document.getElementById("contractRates").style.display = "block";
        document.getElementById("contractRates").innerHTML = `TCMB Döviz Kurları (${p.contractDateForRate}):<br/>1 USD = ${formatCurrencyTR(p.contractRate)} TL<br/>1 EUR = ${formatCurrencyTR(p.eurRate)} TL`;
      }

      updateCalculations();

    } catch (e) {
      console.error("Proje yükleme hatası:", e);
      alert("Detaylar yüklenemedi.");
    }
  }

  function renderStages(stages) {
    const tbody = document.querySelector("#stagesTable tbody");
    tbody.innerHTML = "";
    stages.forEach((stage, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stage.name}</td>
        <td><input type="date" data-index="${idx}" value="${stage.date || ''}" onchange="updateStageDate(${idx}, this.value)" /></td>
        <td><input type="checkbox" ${stage.completed ? 'checked' : ''} onchange="toggleStageCompleted(${idx}, this.checked)" /></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function updateStageDate(index, date) {
    try {
      const ref = db.collection("projects").doc(projectId);
      const doc = await ref.get();
      const stages = doc.data().stages || [];
      if (index >= 0 && index < stages.length) {
        stages[index].date = date;
        await ref.update({ stages });
      }
    } catch (error) {
      console.error("Aşama tarihi güncellenirken hata:", error);
    }
  }

  async function toggleStageCompleted(index, completed) {
    try {
      const ref = db.collection("projects").doc(projectId);
      const doc = await ref.get();
      const stages = doc.data().stages || [];
      if (index >= 0 && index < stages.length) {
        stages[index].completed = completed;
        await ref.update({ stages });
      }
    } catch (error) {
      console.error("Aşama tamamlama hatası:", error);
    }
  }

  async function saveDetails() {
    if (!projectId) return;
    const status = document.getElementById("projectStatus").value;
    const contractValue = parseCurrencyTR(document.getElementById("contractValue").value);
    const currency = document.getElementById("contractCurrency").value;
    const startDate = document.getElementById("startDate").value;

    const dataToUpdate = {
      status,
      contractValue,
      contractCurrency: currency,
      startDate
    };

    try {
      await db.collection("projects").doc(projectId).update(dataToUpdate);
      alert("Sözleşme bilgileri kaydedildi.");
    } catch (e) {
      console.error("Kayıt hatası:", e);
      alert("Kayıt başarısız oldu.");
    }
  }

  async function addExpense() {
    const desc = document.getElementById("expenseDesc").value.trim();
    const amountInput = document.getElementById("expenseAmount");
    const originalAmount = parseCurrencyTR(amountInput.value);
    const currency = document.getElementById("expenseCurrency").value;
    const expenseDate = document.getElementById("expenseDate").value || new Date().toISOString().split('T')[0];

    if (!desc || isNaN(originalAmount) || originalAmount <= 0) {
      alert("Geçerli açıklama ve tutar girin.");
      return;
    }

    let amountInTRY = originalAmount;
    let exchangeRate = 1;
    let exchangeRateDate = expenseDate;

    if (currency !== "TRY") {
      const rates = await getOrFetchRates(expenseDate);
      if (rates && rates[currency]) {
        exchangeRate = rates[currency];
        amountInTRY = originalAmount * exchangeRate;
      } else {
        if (!confirm(`${currency} kuru bulunamadı. TL olarak mı kaydedilsin?`)) return;
      }
    }

    const newExpense = {
      desc,
      originalAmount,
      currency,
      amountInTRY,
      date: expenseDate,
      exchangeRateDate,
      exchangeRate
    };

    try {
      await db.collection("projects").doc(projectId).update({ expenses: firebase.firestore.FieldValue.arrayUnion(newExpense) });
      document.getElementById("expenseDesc").value = "";
      amountInput.value = formatCurrencyTR(0);
      document.getElementById("expenseCurrency").value = "TRY";
      document.getElementById("expenseDate").value = "";

      const updatedDoc = await db.collection("projects").doc(projectId).get();
      renderExpenses(updatedDoc.data().expenses || []);
      updateCalculations();
    } catch (e) {
      console.error("Harcama ekleme hatası:", e);
      alert("Harcama eklenemedi.");
    }
  }

  function renderExpenses(expenses) {
    const tbody = document.querySelector("#expensesTable tbody");
    tbody.innerHTML = "";
    if (expenses.length === 0) {
      document.getElementById("noExpensesMessage").style.display = "block";
      return;
    }
    document.getElementById("noExpensesMessage").style.display = "none";
    expenses.forEach((exp, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${exp.desc}</td>
        <td style="text-align:right;">${formatCurrencyTR(exp.originalAmount)}</td>
        <td>${exp.currency}</td>
        <td>${exp.exchangeRateDate || '-'}</td>
        <td>${exp.exchangeRate ? formatCurrencyTR(exp.exchangeRate) : '-'}</td>
        <td style="text-align:right;">${formatCurrencyTR(exp.amountInTRY)}</td>
        <td><button class="btn-danger" onclick="removeExpense(${idx})">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function removeExpense(idx) {
    if (!confirm("Bu harcama silinsin mi?")) return;
    try {
      const ref = db.collection("projects").doc(projectId);
      const d = await ref.get();
      let ex = d.data().expenses || [];
      ex.splice(idx, 1);
      await ref.update({ expenses: ex });
      renderExpenses(ex);
      updateCalculations();
    } catch (e) {
      console.error("Harcama silme hatası:", e);
      alert("Harcama silinemedi.");
    }
  }

  async function addCollection() {
    const date = document.getElementById("collectionDate").value;
    const type = document.getElementById("collectionType").value;
    const amountInput = document.getElementById("collectionAmount");
    const originalAmount = parseCurrencyTR(amountInput.value);
    const currency = document.getElementById("collectionCurrency").value;

    if (!date || !type || isNaN(originalAmount) || originalAmount <= 0) {
      alert("Geçerli tarih, tip ve tutar girin.");
      return;
    }

    let amountInTRY = originalAmount;
    if (currency !== "TRY") {
      const rates = await getOrFetchRates(date);
      if (rates && rates[currency]) {
        amountInTRY = originalAmount * rates[currency];
      } else {
        if (!confirm(`${currency} kuru alınamadı. TL olarak mı kaydedilsin?`)) return;
      }
    }

    const newCollection = {
      date,
      type,
      originalAmount,
      currency,
      amountInTRY
    };

    try {
      await db.collection("projects").doc(projectId).update({ collections: firebase.firestore.FieldValue.arrayUnion(newCollection) });
      amountInput.value = formatCurrencyTR(0);
      document.getElementById("collectionDate").value = "";
      document.getElementById("collectionType").value = "Nakit";
      const updatedDoc = await db.collection("projects").doc(projectId).get();
      renderCollections(updatedDoc.data().collections || []);
      updateCalculations();
    } catch (e) {
      console.error("Tahsilat ekleme hatası:", e);
      alert("Tahsilat eklenemedi.");
    }
  }

  function renderCollections(collections) {
    const tbody = document.querySelector("#collectionsTable tbody");
    tbody.innerHTML = "";
    if (collections.length === 0) {
      document.getElementById("noCollectionsMessage").style.display = "block";
      return;
    }
    document.getElementById("noCollectionsMessage").style.display = "none";
    collections.forEach((col, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${col.date || "-"}</td>
        <td>${col.type || "-"}</td>
        <td style="text-align:right;">${formatCurrencyTR(col.originalAmount || col.amount || 0)}</td>
        <td>${col.currency || "TRY"}</td>
        <td>${col.exchangeRateDate || "-"}</td>
        <td>${col.exchangeRate ? formatCurrencyTR(col.exchangeRate) : "-"}</td>
        <td style="text-align:right;">${formatCurrencyTR(col.amountInTRY || 0)}</td>
        <td><button class="btn-danger" onclick="removeCollection(${idx})">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function removeCollection(idx) {
    if (!confirm("Bu tahsilat silinsin mi?")) return;
    try {
      const ref = db.collection("projects").doc(projectId);
      const d = await ref.get();
      let cols = d.data().collections || [];
      cols.splice(idx, 1);
      await ref.update({ collections: cols });
      renderCollections(cols);
      updateCalculations();
    } catch (e) {
      console.error("Tahsilat silme hatası:", e);
      alert("Tahsilat silinemedi.");
    }
  }

  async function updateCalculations() {
    if (!projectId) return;
    const doc = await db.collection("projects").doc(projectId).get();
    if (!doc.exists) return;
    const p = doc.data();

    let totalExpensesInTRY = 0;
    if (p.expenses && Array.isArray(p.expenses)) {
      totalExpensesInTRY = p.expenses.reduce((sum, e) => sum + (e.amountInTRY || 0), 0);
    }

    const contractInTRY = p.contractValue || 0;
    const profit = contractInTRY - totalExpensesInTRY;
    const margin = contractInTRY > 0 ? (profit / contractInTRY * 100).toFixed(2) : "0.00";

    document.getElementById("profitSummary").innerHTML = `
      Toplam Harcama (TL): ${formatCurrencyTR(totalExpensesInTRY)} |
      Sözleşme (TL): ${formatCurrencyTR(contractInTRY)} |
      Kar: <span style="color:${profit >= 0 ? 'green' : 'red'}">${formatCurrencyTR(profit)}</span> |
      Kar Marjı: %${margin}`;
  }

  async function fetchRatesAndUpdateCalculations(displayDivId, dateString, isContract = false) {
    const displayDiv = document.getElementById(displayDivId);
    if (!displayDiv) return;
    displayDiv.style.display = "block";
    displayDiv.innerHTML = "Kur bilgisi alınıyor...";

    const rates = await getOrFetchRates(dateString);
    if (rates) {
      displayDiv.innerHTML = `TCMB Döviz Kurları (${dateString}):<br/>1 USD = ${rates.USD ? formatCurrencyTR(rates.USD) : '-'} TL<br/>1 EUR = ${rates.EUR ? formatCurrencyTR(rates.EUR) : '-'} TL`;
    } else {
      displayDiv.innerHTML = "Kur bilgisi alınamadı.";
    }

    await updateCalculations();
  }

  async function getOrFetchRates(dateString) {
    try {
      const getRatesFunction = firebase.app().functions('europe-west1').httpsCallable('getExchangeRateForDate');
      const result = await getRatesFunction({ date: dateString });
      if (result.data.success) {
        return result.data.rates;
      }
      return {};
    } catch (error) {
      console.error("Kur çekerken hata:", error);
      return {};
    }
  }

  function toggleContractRateDisplay() {
    const contractCurrency = document.getElementById("contractCurrency").value;
    document.getElementById("startDate").parentElement.style.display = contractCurrency === "TRY" ? "none" : "block";
  }

  function updateProjectStatus(status) {
    db.collection("projects").doc(projectId).update({ status });
  }

  function goBack() {
    window.location.href = "index.html";
  }

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    }).catch(err => {
      console.error("Çıkış yapılırken hata:", err);
    });
  }

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      const params = new URLSearchParams(window.location.search);
      projectId = params.get("id");
      if (projectId) {
        renderDetailCategoryCheckboxes();
        loadProject();
      } else {
        alert("Proje ID yok.");
        goBack();
      }
    }
  });

</script>

</body>
</html>
