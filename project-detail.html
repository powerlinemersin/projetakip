<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Proje Detayı</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    main { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2, h3 { color: #333; }
    .input-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .input-group > div { flex: 1; min-width: 200px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="date"], textarea, select {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
    }
    button { padding: 10px 15px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .file-list li { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .delete-file-btn { background-color: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .delete-file-btn:hover { background-color: #c0392b; }
    .category-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
    .category-checkbox-group label { display: flex; align-items: center; gap: 5px; }
    @media (max-width: 600px) {
      .input-group > div { flex: 1 1 100%; }
    }
  </style>
</head>
<body>

<main>
  <h2>Proje Detayı</h2>
  <div class="input-group">
    <div><label for="projectName">Proje Adı</label><input type="text" id="projectName" /></div>
    <div><label for="clientName">Müşteri Adı</label><input type="text" id="clientName" /></div>
  </div>
  <div class="input-group">
    <div style="flex: 1;">
      <label for="projectStatus">Proje Durumu</label>
      <select id="projectStatus" onchange="updateProjectStatus(this.value)">
        <option value="Başlamadı">Başlamadı</option>
        <option value="Devam Ediyor">Devam Ediyor</option>
        <option value="Takip Ediliyor">Takip Ediliyor</option>
        <option value="Tamamlandı">Tamamlandı</option>
      </select>
    </div>
  </div>
  <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer">
    <legend>Proje Kategorileri</legend>
  </fieldset>

  <h3>Aşamalar & Sorumlular</h3>
  <table id="stagesTable">
    <thead>
      <tr>
        <th>Aşama</th>
        <th>Sorumlu Kişi</th>
        <th>Tarih</th>
        <th>Notlar/Açıklama</th>
        <th>Tamamlandı mı?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="input-group" style="margin-top: 20px;">
    <div><label for="startDate">Sözleşme Başlangıcı</label><input type="date" id="startDate" onchange="toggleContractRateDisplay()" /></div>
    <div><label for="endDate">Sözleşme Bitişi</label><input type="date" id="endDate" /></div>
  </div>

  <section style="margin-top: 30px;">
    <h3>Sözleşme ve Kar Hesapları</h3>
    <div class="input-group">
      <div>
        <label for="contractValue">Sözleşme Tutarı</label>
        <div class="currency-select-group">
          <input type="text" id="contractValue" placeholder="0,00" oninput="this.value = formatCurrencyTR(this.value)" />
          <select id="contractCurrency" onchange="toggleContractRateDisplay()">
            <option value="TRY">TL</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div id="contractRates" style="display:none;"></div>
      </div>
      <div>
        <label for="contractRateDate">Kur Tarihi (Opsiyonel)</label>
        <input type="date" id="contractRateDate" onchange="fetchRatesAndUpdateCalculations('contractRates', this.value, true)" />
      </div>
    </div>
    <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
    <p id="profitSummary" style="font-weight:bold; margin-top: 10px;"></p>
  </section>

  <section style="margin-top: 30px;">
    <h3>Harcama Ekle</h3>
    <div class="input-group">
      <div><label for="expenseDesc">Açıklama</label><input type="text" id="expenseDesc" /></div>
      <div><label for="expenseAmount">Tutar</label><input type="text" id="expenseAmount" placeholder="0,00" oninput="this.value = formatCurrencyTR(this.value)" /></div>
      <div><label for="expenseCurrency">Para Birimi</label><select id="expenseCurrency"><option value="TRY">TL</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
      <div><label for="expenseDate">Harcama Tarihi</label><input type="date" id="expenseDate" /></div>
    </div>
    <div id="expenseRates" style="display:none;"></div>
    <button onclick="addExpense()">Harcama Ekle</button>
  </section>

  <section>
    <h3>Harcama Listesi</h3>
    <p id="noExpensesMessage" style="color:#999;">Bu projeye henüz harcama eklenmemiş.</p>
    <table id="expensesTable">
      <thead>
        <tr>
          <th>Açıklama</th>
          <th>Orijinal Tutar</th>
          <th>P.B.</th>
          <th>Kur Tarihi</th>
          <th>Kur Oranı</th>
          <th style="text-align:right;">Tutar (TL)</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top: 30px;">
    <h3>Tahsilat Ekle</h3>
    <div class="input-group">
      <div><label for="collectionDate">Tahsilat Tarihi</label><input type="date" id="collectionDate" /></div>
      <div>
        <label for="collectionType">Tip</label>
        <select id="collectionType" onchange="toggleCollectionDetails()">
          <option value="Nakit">Nakit</option>
          <option value="Banka Havalesi">Banka Havalesi</option>
          <option value="Çek">Çek</option>
          <option value="Barter">Barter</option>
        </select>
      </div>
      <div id="checkDetails" style="display:none;">
        <label for="checkNo">Çek No</label>
        <input type="text" id="checkNo" />
        <label for="checkDueDate">Vade Tarihi</label>
        <input type="date" id="checkDueDate" />
        <label for="checkBank">Banka</label>
        <input type="text" id="checkBank" />
      </div>
      <div id="barterDetails" style="display:none;">
        <label for="barterItem">Varlık</label>
        <input type="text" id="barterItem" />
        <label for="barterValue">Değer</label>
        <input type="text" id="barterValue" placeholder="0,00" oninput="this.value = formatCurrencyTR(this.value)" />
        <label for="barterCurrency">Para Birimi</label>
        <select id="barterCurrency">
          <option value="TRY">TL</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
      </div>
      <div><label for="collectionDescription">Açıklama/Not:</label><textarea id="collectionDescription" rows="3" placeholder="Tahsilatla ilgili ek notlar..."></textarea></div>
    </div>
    <button onclick="addCollection()" style="margin-top:15px;">Tahsilat Ekle</button>
  </section>

  <section>
    <h3>Tahsilat Listesi</h3>
    <p id="noCollectionsMessage" style="color:#999;">Bu projeye henüz tahsilat eklenmemiş.</p>
    <table id="collectionsTable">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Tip</th>
          <th>Vade Tarihi</th>
          <th>Orijinal Tutar</th>
          <th>P.B.</th>
          <th>Kur Tarihi</th>
          <th>Kur Oranı</th>
          <th style="text-align:right;">Tutar/Değer (TL)</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top: 30px;">
    <h3>Proje Dosyaları</h3>
    <div class="input-group file-upload-input-group">
      <div style="flex-basis: 40%;">
        <label for="fileUploadInput">Dosya Seç</label>
        <input type="file" id="fileUploadInput" />
      </div>
      <div style="flex-basis: 40%;">
        <label for="fileDescriptionInput">Dosya Açıklaması (Opsiyonel)</label>
        <input type="text" id="fileDescriptionInput" placeholder="Örn: Sözleşme V1, Teklif Onay Yazısı" />
      </div>
      <div style="flex-basis: 15%; min-width: 100px;">
        <button onclick="uploadFile()" style="width:100%;">Yükle</button>
      </div>
    </div>
    <div id="uploadProgress"><div id="uploadProgressBar"></div></div>
    <h4 style="margin-top: 20px;">Yüklenmiş Dosyalar:</h4>
    <ul id="fileList" class="file-list"></ul>
    <p id="noProjectFilesMessage" style="display:none;">Bu projeye henüz dosya yüklenmemiş.</p>
  </section>

  <div style="margin-top: 30px; padding-bottom: 30px;">
    <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
    <button onclick="generateExcelReport()" style="margin-left:10px; background:#27ae60;">Rapor İndir (Excel)</button>
    <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.8/xlsx.full.min.js"></script> 

<script>
  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
    authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
    projectId: "projetakipsistemi-fbabd",
    storageBucket: "projetakipsistemi-fbabd.appspot.com",
    messagingSenderId: "335282912485",
    appId: "1:335282912485:web:5ad9091ccf3cabd8f8280c"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();
  const functions = firebase.app().functions('europe-west1');

  let projectId = null;

  const predefinedStageNames = ["Keşif / Ön görüşme", "Teklif oluşturma", "Onay – sözleşme", "Malzeme temini", "Uygulama", "Test ve devreye alma", "Teslimat"];
  const defaultProjectStatus = "Başlamadı";
  const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];
  let fetchedRatesCache = {};

  function formatCurrencyTR(val) {
    let n = typeof val === 'string' ? parseFloat(val.replace(/\./g,'').replace(',','.')) : val;
    return isNaN(n) ? "0,00" : n.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function parseCurrencyTR(val) {
    return parseFloat(val.replace(/\./g, '').replace(',', '.'));
  }

  async function renderDetailCategoryCheckboxes() {
    const container = document.getElementById("projectCategoriesCheckboxesContainer");
    if (!container) return;
    container.innerHTML = "";
    projectCategories.forEach(cat => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${cat}">${cat}`;
      container.appendChild(label);
    });
  }

  async function saveDetails() {
    if (!projectId) return;
    const dataToUpdate = {
      name: document.getElementById("projectName").value.trim(),
      client: document.getElementById("clientName").value.trim(),
      status: document.getElementById("projectStatus").value,
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value
    };

    const selectedCategories = [];
    document.querySelectorAll('#projectCategoriesCheckboxesContainer input[type="checkbox"]:checked').forEach(cb => {
      selectedCategories.push(cb.value);
    });
    dataToUpdate.categories = selectedCategories;

    try {
      await db.collection("projects").doc(projectId).update(dataToUpdate);
      alert("Sözleşme bilgileri kaydedildi.");
    } catch(e) {
      console.error("Detay kaydetme hatası:", e);
      alert("Bilgiler kaydedilemedi.");
    }
  }

  async function updateCalculations() {
    if (!projectId) return;
    const doc = await db.collection("projects").doc(projectId).get();
    if (!doc.exists) return;
    const p = doc.data();

    let totalExpensesInTRY = 0;
    let contractInTRY = 0;

    if (p.expenses && Array.isArray(p.expenses)) {
      totalExpensesInTRY = p.expenses.reduce((sum, e) => sum + (e.amountInTRY || 0), 0);
    }

    if (p.originalContractAmount && typeof p.originalContractAmount === 'number') {
      contractInTRY = p.originalContractAmount;
    }

    const profit = contractInTRY - totalExpensesInTRY;
    const margin = contractInTRY > 0 ? (profit / contractInTRY) * 100 : 0;

    const profitSummary = document.getElementById("profitSummary");
    profitSummary.innerHTML = `
      Toplam Harcama (TL): ${formatCurrencyTR(totalExpensesInTRY)} |
      Sözleşme (TL): ${formatCurrencyTR(contractInTRY)} |
      Kar: <span style="color:${profit >= 0 ? 'green' : 'red'}">${formatCurrencyTR(profit)}</span> |
      Kar Marjı: ${margin.toFixed(2)}%
    `;
  }

  async function loadProject() {
    const p = new URLSearchParams(window.location.search);
    projectId = p.get("id");
    if (!projectId) {
      alert("Proje ID yok.");
      return;
    }
    try {
      const doc = await db.collection("projects").doc(projectId).get();
      if (!doc.exists) {
        alert("Proje bulunamadı.");
        return;
      }
      const p = doc.data();
      document.getElementById("projectName").value = p.name || "";
      document.getElementById("clientName").value = p.client || "";
      document.getElementById("startDate").value = p.startDate || "";
      document.getElementById("endDate").value = p.endDate || "";
      document.getElementById("projectStatus").value = p.status || defaultProjectStatus;

      const checkboxes = document.querySelectorAll("#projectCategoriesCheckboxesContainer input[type='checkbox']");
      checkboxes.forEach(cb => cb.checked = p.categories?.includes(cb.value));

      renderExpenses(p.expenses || []);
      renderCollections(p.collections || []);
      renderFiles(p.files || []);

      if (p.originalContractAmount) {
        document.getElementById("contractValue").value = formatCurrencyTR(p.originalContractAmount);
        document.getElementById("contractCurrency").value = p.contractCurrency || "TRY";
      }

      if (p.contractDateForRate) {
        document.getElementById("contractRateDate").value = p.contractDateForRate;
      }

      await updateCalculations();
    } catch (e) {
      console.error("Proje yükleme hatası:", e);
      alert("Detaylar yüklenemedi.");
    }
  }

  async function addExpense() {
    const desc = document.getElementById("expenseDesc").value.trim();
    const amountInput = document.getElementById("expenseAmount");
    const originalAmount = parseCurrencyTR(amountInput.value);
    const currency = document.getElementById("expenseCurrency").value;
    const expenseDate = document.getElementById("expenseDate").value || new Date().toISOString().split('T')[0];

    if (!desc || isNaN(originalAmount) || originalAmount <= 0) {
      alert("Geçerli açıklama ve tutar girin.");
      return;
    }

    let amountInTRY = originalAmount;
    let exchangeRate = 1;
    let exchangeRateDate = expenseDate;

    if (currency !== "TRY") {
      const rates = await getOrFetchRates(expenseDate);
      if (rates && rates[currency]) {
        exchangeRate = rates[currency];
        amountInTRY = originalAmount * exchangeRate;
      }
    }

    const newExpense = {
      desc, originalAmount, currency, amountInTRY, date: expenseDate,
      exchangeRateDate, exchangeRate
    };

    try {
      await db.collection("projects").doc(projectId).update({ expenses: firebase.firestore.FieldValue.arrayUnion(newExpense) });
      document.getElementById("expenseDesc").value = "";
      amountInput.value = formatCurrencyTR(0);
      document.getElementById("expenseCurrency").value = "TRY";
      document.getElementById("expenseDate").value = "";
      const updatedDoc = await db.collection("projects").doc(projectId).get();
      renderExpenses(updatedDoc.data().expenses || []);
      await updateCalculations();
    } catch (e) {
      console.error("Harcama ekleme hatası:", e);
      alert("Harcama eklenemedi.");
    }
  }

  function renderExpenses(expenses) {
    const tbody = document.querySelector("#expensesTable tbody");
    tbody.innerHTML = "";
    if (expenses.length === 0) {
      document.getElementById("noExpensesMessage").style.display = "block";
      return;
    } else {
      document.getElementById("noExpensesMessage").style.display = "none";
    }
    expenses.forEach((exp, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${exp.desc}</td>
        <td style="text-align:right;">${formatCurrencyTR(exp.originalAmount)}</td>
        <td>${exp.currency}</td>
        <td>${exp.exchangeRateDate || '-'}</td>
        <td>${exp.exchangeRate ? formatCurrencyTR(exp.exchangeRate) : '-'}</td>
        <td style="text-align:right;">${formatCurrencyTR(exp.amountInTRY)}</td>
        <td><button class="delete-file-btn" onclick="removeExpense(${idx})">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function removeExpense(idx) {
    if (!confirm("Bu harcama silinsin mi?")) return;
    try {
      const ref = db.collection("projects").doc(projectId);
      const d = await ref.get();
      if (!d.exists) return;
      let ex = d.data().expenses || [];
      ex.splice(idx, 1);
      await ref.update({ expenses: ex });
      renderExpenses(ex);
      await updateCalculations();
    } catch (e) {
      console.error("Harcama silme hatası:", e);
      alert("Harcama silinemedi.");
    }
  }

  async function generateExcelReport() {
    if (!projectId) {
      alert("Proje bulunamadı.");
      return;
    }
    const pRef = db.collection("projects").doc(projectId);
    const pDoc = await pRef.get();
    if (!pDoc.exists) {
      alert("Proje verisi yok.");
      return;
    }
    const p = pDoc.data();
    const wb = XLSX.utils.book_new();
    const generalInfoData = [
      ["Proje Adı", p.name || 'N/A'],
      ["Müşteri Adı", p.client || 'N/A'],
      ["Proje Durumu", p.status || defaultProjectStatus],
      ["Kategoriler", (p.categories || []).join(", ") || 'N/A'],
      ["Sözleşme Başlangıcı", p.startDate || 'N/A'],
      ["Sözleşme Bitişi", p.endDate || 'N/A'],
      ["Sözleşme Tutarı (Orijinal)", p.originalContractAmount || 'N/A']
    ];
    const wsGeneral = XLSX.utils.aoa_to_sheet(generalInfoData);
    XLSX.utils.book_append_sheet(wb, wsGeneral, "Genel Bilgi");

    const stagesHeaders = ["Aşama Adı", "Sorumlu Kişi", "Tarih", "Notlar", "Durum"];
    const stagesBody = (p.stages || []).map(s => [s.name, s.responsible, s.date, s.notes || '', s.completed ? "Tamamlandı" : "Tamamlanmadı"]);
    const wsStages = XLSX.utils.aoa_to_sheet([stagesHeaders, ...stagesBody]);
    XLSX.utils.book_append_sheet(wb, wsStages, "Aşamalar");

    const expensesHeaders = ["Açıklama", "Harcama Tarihi", "Orijinal Tutar", "P.B.", "Kur Tarihi", "Kur Oranı", "Tutar (TL)"];
    const expensesBody = (p.expenses || []).map(e => [e.desc, e.date || 'N/A', e.originalAmount, e.currency, e.exchangeRateDate || '-', e.exchangeRate ? formatCurrencyTR(e.exchangeRate) : '-', e.amountInTRY]);
    const wsExpenses = XLSX.utils.aoa_to_sheet([expensesHeaders, ...expensesBody]);
    XLSX.utils.book_append_sheet(wb, wsExpenses, "Harcamalar");

    const collectionsHeaders = ["Tahsilat Tarihi", "Tip", "Açıklama / Detay", "Vade Tarihi", "Orijinal Tutar", "P.B.", "Kur Tarihi", "Kur Oranı", "Tutar/Değer (TL)"];
    const collectionsBody = (p.collections || []).map(c => {
      let oAmt = c.type === "Barter" && c.barterDetails ? c.barterDetails.value : (c.originalAmount || c.amount || 0);
      let curr = c.type === "Barter" && c.barterDetails ? (c.barterDetails.currency || "TRY") : (c.currency || "TRY");
      let amtTRY = c.amountInTRY || 0;
      let desc = c.description || '';
      let dueDate = '-';
      if (c.type === "Çek" && c.checkDetails) {
        desc += `${desc ? ' <br> ' : ''}Çek No: ${c.checkDetails.checkNo || 'N/A'}, Banka: ${c.checkDetails.bank || 'N/A'}`;
        dueDate = c.checkDetails.dueDate || '-';
      }
      return [c.date || 'N/A', c.type, desc, dueDate, oAmt, curr, '-', '-', amtTRY];
    });
    const wsCollections = XLSX.utils.aoa_to_sheet([collectionsHeaders, ...collectionsBody]);
    XLSX.utils.book_append_sheet(wb, wsCollections, "Tahsilatlar");

    XLSX.writeFile(wb, `Proje_${p.name}.xlsx`);
  }

  async function goBack() {
    window.location.href = "index.html";
  }

  async function getOrFetchRates(dateString) {
    if (!dateString) {
      console.warn("Kur çekmek için tarih belirtilmedi.");
      return null;
    }
    if (fetchedRatesCache[dateString]) {
      console.log("Kur önbellekten alındı:", dateString, fetchedRatesCache[dateString]);
      return fetchedRatesCache[dateString];
    }
    try {
      const getRatesFunction = functions.httpsCallable('getExchangeRateForDate');
      const result = await getRatesFunction({ date: dateString });
      if (result.data && result.data.success) {
        fetchedRatesCache[dateString] = result.data.rates;
        console.log(`Firebase Function'dan kur çekildi (${result.data.source} - ${dateString}):`, result.data.rates);
        return result.data.rates;
      } else {
        console.error("Kur bilgisi alınamadı (fonksiyon başarısız):", result.data?.message || "Bilinmeyen fonksiyon hatası", result.data);
        return null;
      }
    } catch (error) {
      console.error(`Firebase Function (${dateString}) çağrılırken istemci tarafı hata:`, error);
      return null;
    }
  }

  async function fetchRatesAndUpdateCalculations(displayDivId, dateString, isContract = false) {
    const displayDiv = document.getElementById(displayDivId);
    if (!displayDiv) {
      console.warn("Kur gösterim alanı bulunamadı:", displayDivId);
      return;
    }
    displayDiv.style.display = "block";
    displayDiv.innerHTML = "Kur bilgisi alınıyor...";
    const rates = await getOrFetchRates(dateString);
    if (rates) {
      displayDiv.innerHTML = `TCMB Döviz Kurları (${dateString}):<br/>1 USD = ${rates.USD ? formatCurrencyTR(rates.USD) : '-'} TL<br/>1 EUR = ${rates.EUR ? formatCurrencyTR(rates.EUR) : '-'} TL`;
    } else {
      displayDiv.innerHTML = "Kur bilgisi alınamadı.";
      if (!isContract && dateString) alert(`${dateString} için kur bilgisi alınamadı.`);
    }
    await updateCalculations();
  }

  async function toggleContractRateDisplay() {
    const contractCurrency = document.getElementById("contractCurrency").value;
    const contractRateSection = document.getElementById("contractRateDate").parentElement;
    if (contractCurrency === "TRY") {
      contractRateSection.style.display = "none";
    } else {
      contractRateSection.style.display = "block";
    }
  }

</script>

</body>
</html>
