<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Proje Detayı</title>
  <style>
    body { font-family: sans-serif; margin: 40px; background: #f5f5f5; }
    label { display: block; margin-top: 10px; }
    input, textarea {
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Proje Detayları</h1>
  <form id="projectForm">
    <label>Proje Adı<input type="text" id="name" required /></label>
    <label>Müşteri Adı<input type="text" id="client" required /></label>
    <label>Başlangıç Tarihi<input type="date" id="startDate" required /></label>
    <label>Bitiş Tarihi<input type="date" id="endDate" required /></label>

    <h3>Aşamalar & Sorumlular</h3>
    <table>
      <thead>
        <tr>
          <th>Aşama</th>
          <th>Sorumlu</th>
          <th>Planlanan Süre (gün)</th>
          <th>Tamamlandı mı?</th>
        </tr>
      </thead>
      <tbody id="milestonesTableBody">
        <!-- Satırlar JS ile doldurulacak -->
      </tbody>
    </table>

    <h3>Bütçe Yönetimi</h3>
    <label>Tahmini Bütçe (TL)<input type="number" id="estimatedBudget" min="0" /></label>
    <label>Gerçekleşen Bütçe (TL)<input type="number" id="actualBudget" min="0" /></label>

    <button type="button" onclick="saveProject()">Kaydet</button>
  </form>

  <script>
    const fixedMilestones = [
      "Keşif / Ön görüşme",
      "Teklif oluşturma",
      "Onay – sözleşme",
      "Malzeme temini",
      "Uygulama",
      "Test ve devreye alma",
      "Teslimat"
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const projects = JSON.parse(localStorage.getItem('projects') || '[]');

    function createMilestoneRow(milestoneData = {}) {
      const tr = document.createElement('tr');

      // Aşama adı (sabit, input değil)
      const tdStage = document.createElement('td');
      tdStage.textContent = milestoneData.step || '';
      tr.appendChild(tdStage);

      // Sorumlu kişi input
      const tdResponsible = document.createElement('td');
      const inputResponsible = document.createElement('input');
      inputResponsible.type = 'text';
      inputResponsible.value = milestoneData.responsible || '';
      tdResponsible.appendChild(inputResponsible);
      tr.appendChild(tdResponsible);

      // Planlanan süre input (gün)
      const tdDuration = document.createElement('td');
      const inputDuration = document.createElement('input');
      inputDuration.type = 'number';
      inputDuration.min = 0;
      inputDuration.value = milestoneData.duration || '';
      tdDuration.appendChild(inputDuration);
      tr.appendChild(tdDuration);

      // Tamamlandı checkbox
      const tdCompleted = document.createElement('td');
      const inputCompleted = document.createElement('input');
      inputCompleted.type = 'checkbox';
      inputCompleted.checked = milestoneData.completed || false;
      tdCompleted.style.textAlign = 'center';
      tdCompleted.appendChild(inputCompleted);
      tr.appendChild(tdCompleted);

      return tr;
    }

    function loadMilestones() {
      const tbody = document.getElementById('milestonesTableBody');
      tbody.innerHTML = '';

      // Eğer proje varsa ve milestones verisi varsa
      if (id !== null && projects[id] && projects[id].milestones) {
        const savedMilestones = projects[id].milestones;

        fixedMilestones.forEach(stage => {
          // Kayıtta varsa eşleşeni al, yoksa boş doldur
          const saved = savedMilestones.find(m => m.step === stage) || {};
          const milestoneData = {
            step: stage,
            responsible: saved.responsible || '',
            duration: saved.duration || '',
            completed: saved.completed || false
          };
          tbody.appendChild(createMilestoneRow(milestoneData));
        });
      } else {
        // Yeni proje, boş satırlar oluştur
        fixedMilestones.forEach(stage => {
          tbody.appendChild(createMilestoneRow({step: stage}));
        });
      }
    }

    function saveProject() {
      if (id === null) {
        alert('Geçersiz proje!');
        return;
      }

      const tbody = document.getElementById('milestonesTableBody');
      const rows = tbody.querySelectorAll('tr');

      const milestonesArr = [];

      rows.forEach(tr => {
        const step = tr.children[0].textContent;
        const responsible = tr.children[1].querySelector('input').value.trim();
        const duration = tr.children[2].querySelector('input').value.trim();
        const completed = tr.children[3].querySelector('input').checked;

        milestonesArr.push({
          step,
          responsible,
          duration,
          completed
        });
      });

      projects[id] = {
        name: document.getElementById('name').value.trim(),
        client: document.getElementById('client').value.trim(),
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        milestones: milestonesArr,
        estimatedBudget: document.getElementById('estimatedBudget').value.trim(),
        actualBudget: document.getElementById('actualBudget').value.trim()
      };

      localStorage.setItem('projects', JSON.stringify(projects));
      alert('Proje güncellendi!');
      window.location.href = 'index.html';
    }

    // Sayfa yüklenince verileri yükle
    window.onload = () => {
      if (id !== null && projects[id]) {
        const proj = projects[id];
        document.getElementById('name').value = proj.name;
        document.getElementById('client').value = proj.client;
        document.getElementById('startDate').value = proj.startDate;
        document.getElementById('endDate').value = proj.endDate;
        document.getElementById('estimatedBudget').value = proj.estimatedBudget || '';
        document.getElementById('actualBudget').value = proj.actualBudget || '';
      }
      loadMilestones();
    };
  </script>
</body>
</html>
