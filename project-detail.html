<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Detayları</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f9fbfd; color: #2c3e50;
    }
    header {
      background-color: #34495e; color: white; padding: 15px 20px; display: flex;
      align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header-content-left { flex: 1; }
    .logo-title-container {
      display: flex; flex-direction: column; align-items: center; text-align: center;
      flex: 2; 
    }
    header img { height: 40px; width: auto; margin-bottom: 5px; }
    header h1 { font-weight: 600; font-size: 1.6rem; margin: 0; }
    .header-content-right { flex: 1; display: flex; justify-content: flex-end; }
    .header-content-right button { margin-top: 0; }
    
    main { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
    h3 {
        color: #34495e; margin-top: 30px; margin-bottom: 15px;
        border-bottom: 2px solid #2980b9; padding-bottom: 8px;
    }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input, button, select, textarea {
      padding: 10px 12px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;
      outline: none; transition: border-color 0.3s ease; width: 100%; box-sizing: border-box;
    }
    input:not([type="checkbox"]), select, textarea { width: 100%;}
    input[type="checkbox"] { width: auto; }
    input:focus, select:focus, textarea:focus {
      border-color: #2980b9; box-shadow: 0 0 5px #2980b9;
    }
    button {
      background-color: #2980b9; border: none; color: white; cursor: pointer; font-weight: 600;
      transition: background-color 0.3s ease; margin-top: 10px; border-radius: 6px;
      width: auto; padding: 10px 20px;
    }
    button:hover { background-color: #1c5980; }
    table {
      width: 100%; border-collapse: collapse; background: white; margin-top: 25px;
      border: 1px solid #ddd; border-radius: 8px; overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { padding: 10px 12px; border-bottom: 1px solid #e3e6ea; text-align: left; font-size: 0.9em;}
    thead { background-color: #2980b9; color: white; font-weight: 600; }
    tr:hover { background-color: #ecf6fc; }
    .input-group { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
    .input-group > div { flex: 1; min-width: 120px; }
    .input-group button {margin-top:0;}
    .readonly { background-color: #f0f0f0; cursor: not-allowed; }
    input[type="text"].currency-input { text-align: right; }
    .category-checkbox-group {
        margin-top: 15px; margin-bottom: 20px; padding: 10px; border: 1px solid #eee;
        border-radius: 6px; background-color: #fdfdfd;
    }
    .category-checkbox-group legend {
        font-weight: 600; padding: 0 5px; margin-left: 5px; color: #34495e;
    }
    .category-checkbox-group label {
        display: inline-block; margin-right: 15px; font-weight: normal; cursor: pointer;
        margin-top: 0; margin-bottom: 5px;
    }
    .category-checkbox-group input[type="checkbox"] {
        margin-right: 5px; vertical-align: middle;
    }
    .stage-notes-input {
        width: 100%; min-height: 40px; padding: 6px; font-size: 0.9em;
        border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; resize: vertical;
    }
    .file-list { list-style-type: none; padding: 0; }
    .file-list li {
        background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px;
        margin-bottom: 5px; border-radius: 4px; display: flex;
        justify-content: space-between; align-items: center;
    }
     .file-list li div { display: flex; flex-direction: column; }
    .file-list .file-name { font-weight: 600; }
    .file-list .file-description { font-size: 0.85em; color: #555; margin-top: 3px; }
    .delete-file-btn {
        background-color: #dc3545; color: white; border: none; padding: 5px 8px;
        border-radius: 4px; cursor: pointer; font-size: 0.8em;
    }
    .delete-file-btn:hover { background-color: #c82333; }
    #uploadProgress {
        width: 100%; background-color: #e9ecef; border-radius: .25rem;
        margin-top: 5px; height: 10px; display: none;
    }
    #uploadProgressBar {
        width: 0%; height: 100%; background-color: #28a745; border-radius: .25rem;
        text-align: center; line-height: 10px; color: white; font-size: 0.7em;
    }
    .collection-details-fields {
        display: none; padding-left: 15px; border-left: 2px solid #eee;
        margin-left: 5px; margin-top: 10px;
    }
    #collectionsTable td, #collectionsTable th { font-size: 0.85em; padding: 8px 10px;}
    .report-table th.sortable { cursor: pointer; }
    .report-table th.sortable:hover { background-color: #e9ecef; }
    .report-table th.sortable::after { content: ' \00A0\2195'; font-size: 0.8em; opacity: 0.5; }
    .report-table th.sort-asc::after { content: ' \00A0\2191'; opacity: 1;}
    .report-table th.sort-desc::after { content: ' \00A0\2193'; opacity: 1;}
     #exchangeRateInfo {
        font-size: 0.8em; color: #555; margin-top: 5px; padding: 5px;
        background-color: #f0f8ff; border: 1px dashed #add8e6;
        border-radius: 4px; display: none; 
    }

    @media print { 
      body { font-family: Arial, sans-serif; margin: 20mm; font-size: 10pt; }
      header, main > div:last-child > button, 
      main > section:nth-of-type(3) > .input-group > div:last-child > button, 
      main > section:nth-of-type(5) > .input-group > div:last-child > button, 
      #uploadProgress, .delete-file-btn, 
      #expensesTable button, #collectionsTable button,
      .stage-input[type="checkbox"] + label, .category-checkbox-group input[type="checkbox"],
      .category-checkbox-group label[for^="detail_"],
      #exchangeRateInfo /* Kur bilgisi yazdırmada gizlenebilir */
       { display: none !important; }
      h3 { border-bottom: 1px solid #ccc; margin-top: 15px; margin-bottom: 10px; font-size: 14pt;}
      table { margin-top: 10px; font-size: 9pt; width: 100% !important; border: 1px solid #ccc !important; page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      th, td { padding: 4px 6px !important; border: 1px solid #eee !important; word-wrap: break-word; }
      thead { background-color: #f0f0f0 !important; color: #333 !important; display: table-header-group; }
      a { text-decoration: none; color: black; }
      a[href]::after { content: " (" attr(href) ")"; font-size: 0.8em; color: #555; }
      input[type="text"], input[type="date"], select, textarea.stage-notes-input {
        border: none !important; box-shadow: none !important; padding: 0 !important;
        background-color: transparent !important; font: inherit !important; color: inherit !important;
        -webkit-appearance: none; -moz-appearance: none; appearance: none; width: auto !important;
      }
      input.readonly { color: #333; font-weight: normal; }
      .stage-input[type="checkbox"]::after { content: attr(checked) ? "Evet" : "Hayır"; }
      #projectCategoriesCheckboxesContainer legend { font-weight: bold; margin-bottom: 3px; }
      #projectCategoriesCheckboxesContainer { border: none; padding: 0; margin-bottom: 10px; }
      .file-list li { background-color: transparent; border: none; padding: 2px 0; margin-bottom: 2px; }
      main > section:nth-of-type(4) > div[style*="border:1px solid #ddd"] { display: none !important; } 
    }
    @media (max-width: 768px) { 
      header { flex-direction: column; padding: 15px; }
      .logo-title-container { order: 1; margin-bottom: 10px; }
      .header-content-left { display: none; }
      .header-content-right { order: 2; width: 100%; justify-content: center; }
      .header-content-right button { width: auto; }

      .input-group { flex-direction: column; align-items: stretch; }
      .input-group input, .input-group > div > button, .input-group select, .input-group textarea { width: 100%; margin-left: 0; }
      .input-group > div > button { margin-top: 10px; } 
      .file-upload-input-group > div:last-child > button { margin-top: 10px; }
      .category-checkbox-group label { margin-bottom: 8px; }
      #stagesTable, #expensesTable, #collectionsTable { display: block; width: 100%; }
      #stagesTable thead, #expensesTable thead, #collectionsTable thead { display: none; }
      #stagesTable tbody, #expensesTable tbody, #collectionsTable tbody { display: block; width: 100%; }
      #stagesTable tr, #expensesTable tr, #collectionsTable tr {
        display: block; margin-bottom: 15px; background: white; border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 15px; border: 1px solid #ddd;
      }
      tbody tr td {
        display: flex; justify-content: space-between; padding: 10px 0;
        border-bottom: 1px solid #eee; text-align: right;
      }
      tbody tr td:last-child { border-bottom: 0; }
      tbody tr td::before {
        content: attr(data-label); font-weight: bold; margin-right: 10px;
        text-align: left; flex-grow: 1; color: #555;
      }
      #stagesTable tbody td:nth-of-type(1)::before { content: "Aşama:"; }
      #stagesTable tbody td:nth-of-type(2)::before { content: "Sorumlu Kişi:"; }
      #stagesTable tbody td:nth-of-type(3)::before { content: "Tarih:"; }
      #stagesTable tbody td:nth-of-type(4)::before { content: "Notlar/Açıklama:"; }
      #stagesTable tbody td:nth-of-type(5)::before { content: "Tamamlandı mı?:"; }
      #expensesTable tbody td:nth-of-type(1)::before { content: "Tarih:"; }
      #expensesTable tbody td:nth-of-type(2)::before { content: "Açıklama:"; }
      #expensesTable tbody td:nth-of-type(3)::before { content: "Tutar:"; } 
      #expensesTable tbody td:nth-of-type(4)::before { content: "P.B.:"; } 
      #expensesTable tbody td:nth-of-type(5)::before { content: "İşlem:"; }
      #collectionsTable tbody td:nth-of-type(1)::before { content: "Tarih:"; }
      #collectionsTable tbody td:nth-of-type(2)::before { content: "Tip:"; }
      #collectionsTable tbody td:nth-of-type(3)::before { content: "Açıklama / Detay:"; }
      #collectionsTable tbody td:nth-of-type(4)::before { content: "Vade Tarihi:"; } 
      #collectionsTable tbody td:nth-of-type(5)::before { content: "Tutar/Değer:"; }
      #collectionsTable tbody td:nth-of-type(6)::before { content: "P.B.:"; }
      #collectionsTable tbody td:nth-of-type(7)::before { content: "İşlem:"; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content-left"></div>
    <div class="logo-title-container">
      <img src="https://powerlinemersin.github.io/projetakip/logo.png" alt="Powerline Mersin" />
      <h1>Proje Detayları</h1>
    </div>
    <div class="header-content-right">
      <button onclick="logout()" style="background:#e74c3c; color:white;">Çıkış Yap</button>
    </div>
  </header>
  <main>
    <section>
      <h3>Genel Bilgiler</h3>
      <div class="input-group">
        <div style="flex: 2;"><label for="projectName">Proje Adı</label><input type="text" id="projectName" class="readonly" readonly /></div>
        <div style="flex: 2;"><label for="clientName">Müşteri Adı</label><input type="text" id="clientName" class="readonly" readonly /></div>
        <div style="flex: 1;"><label for="projectStatus">Proje Durumu</label><select id="projectStatus" onchange="updateProjectStatus(this.value)"><option value="Başlamadı">Başlamadı</option><option value="Devam Ediyor">Devam Ediyor</option><option value="Takip Ediliyor">Takip Ediliyor</option><option value="Tamamlandı">Tamamlandı</option></select></div>
      </div>
      <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer"><legend>Proje Kategorileri</legend></fieldset>
      <h3>Aşamalar & Sorumlular</h3>
      <table id="stagesTable">
        <thead><tr><th>Aşama</th><th>Sorumlu Kişi</th><th>Tarih</th><th>Notlar/Açıklama</th><th>Tamamlandı mı?</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="input-group" style="margin-top: 20px;">
        <div><label for="startDate">Sözleşme Başlangıcı</label><input type="date" id="startDate" /></div>
        <div><label for="endDate">Sözleşme Bitişi</label><input type="date" id="endDate" /></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Sözleşme ve Kar Hesapları</h3>
      <div class="input-group">
          <div style="flex: 3;"><label for="contractValue">Sözleşme Tutarı</label><input type="text" id="contractValue" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event, 'contractCurrency')" onblur="formatInputOnBlur(this, 'contractCurrency')"/></div>
          <div style="flex: 1;"><label for="contractCurrency">P.B.</label><select id="contractCurrency" onchange="updateCalculationsOnCurrencyChange()"><option value="TRY" selected>TRY</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
      </div>
      <div id="exchangeRateInfo">Güncel kurlar yükleniyor/kullanılıyor...</div>
      <div class="input-group">
          <div><label for="totalExpenses">Toplam Harcama (<span id="contractCurrencyLabelForExpenses">TRY</span>)</label><input type="text" id="totalExpenses" class="readonly currency-input" readonly /></div>
          <div><label for="realizedProfit">Gerçekleşen Kar (<span id="contractCurrencyLabelForProfit">TRY</span>)</label><input type="text" id="realizedProfit" class="readonly currency-input" readonly /></div>
      </div>
      <div class="input-group">
          <div><label for="totalCollections">Toplam Tahsil Edilen (<span id="contractCurrencyLabelForCollections">TRY</span>)</label><input type="text" id="totalCollections" class="readonly currency-input" readonly /></div>
          <div><label for="remainingBalance">Kalan Bakiye (<span id="contractCurrencyLabelForBalance">TRY</span>)</label><input type="text" id="remainingBalance" class="readonly currency-input" readonly /></div>
      </div>
      <div class="input-group">
            <div><label for="realizedProfitMargin">Gerçekleşen Kar Marjı (%)</label><input type="text" id="realizedProfitMargin" class="readonly" readonly style="text-align: right;"/></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Harcama Kalemleri</h3>
      <table id="expensesTable">
        <thead><tr><th>Tarih</th><th>Açıklama</th><th style="text-align:right;">Tutar</th><th>P.B.</th><th>İşlem</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top: 20px; padding:15px; border:1px solid #ddd; border-radius:8px;">
        <h5 style="margin-top:0; margin-bottom:10px;">Yeni Harcama Ekle</h5>
        <div class="input-group">
            <div style="flex:2;"><label for="expenseDate">Harcama Tarihi</label><input type="date" id="expenseDate" /></div>
            <div style="flex:3;"><label for="expenseDesc">Açıklama</label><input type="text" id="expenseDesc" placeholder="Açıklama" /></div>
        </div>
        <div class="input-group" style="margin-top:10px;">
            <div style="flex:2;"><label for="expenseAmount">Tutar</label><input type="text" id="expenseAmount" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event, 'expenseCurrency')" onblur="formatInputOnBlur(this, 'expenseCurrency')"/></div>
            <div style="flex:1;"><label for="expenseCurrency">P.B.</label><select id="expenseCurrency"><option value="TRY" selected>TRY</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
            <div style="flex:1;"><button onclick="addExpense()" style="width:100%;">Ekle</button></div>
        </div>
      </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Tahsilatlar</h3>
        <table id="collectionsTable" class="report-table"> 
            <thead><tr><th class="sortable" onclick="sortTable('collectionsTable', 0, 'date')">Tarih</th><th class="sortable" onclick="sortTable('collectionsTable', 1, 'string')">Tip</th><th>Açıklama / Detay</th><th class="sortable" onclick="sortTable('collectionsTable', 3, 'date')">Vade T.</th><th class="sortable" onclick="sortTable('collectionsTable', 4, 'number')" style="text-align:right;">Tutar/Değer</th><th>P.B.</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
        </table>
        <p id="noCollectionsMessage" style="text-align:center; margin-top:10px; display:none;">Henüz tahsilat eklenmemiş.</p>
        <div style="margin-top: 20px; padding:15px; border:1px solid #ddd; border-radius:8px;">
            <h4>Yeni Tahsilat Ekle</h4>
            <div class="input-group">
                <div><label for="collectionDate">Tarih:</label><input type="date" id="collectionDate" /></div>
                <div><label for="collectionType">Tip:</label><select id="collectionType" onchange="toggleCollectionDetails()"><option value="Nakit">Nakit</option><option value="Banka Transferi">Banka Transferi</option><option value="Çek">Çek</option><option value="Barter">Barter</option></select></div>
                <div><label for="collectionCurrency">P.B.:</label><select id="collectionCurrency"><option value="TRY" selected>TRY</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
            </div>
            <div id="collectionAmountGroup"><label for="collectionAmount">Tutar:</label><input type="text" id="collectionAmount" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event, 'collectionCurrency')" onblur="formatInputOnBlur(this, 'collectionCurrency')"/></div>
            <div id="checkDetailsGroup" class="collection-details-fields"><h5>Çek Detayları</h5><label for="checkDueDate">Vade Tarihi:</label><input type="date" id="checkDueDate" /><label for="checkNumber">Çek No:</label><input type="text" id="checkNumber" placeholder="Çek Numarası" /><label for="checkBank">Banka:</label><input type="text" id="checkBank" placeholder="Banka Adı" /></div>
            <div id="barterDetailsGroup" class="collection-details-fields"><h5>Barter Detayları</h5><label for="barterAsset">Takas Edilen Varlık:</label><input type="text" id="barterAsset" placeholder="Örn: Daire, Araç" /><label for="barterValue">Belirlenen Değer:</label><input type="text" id="barterValue" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event, 'collectionCurrency')" onblur="formatInputOnBlur(this, 'collectionCurrency')"/></div>
            <div><label for="collectionDescription">Açıklama/Not:</label><textarea id="collectionDescription" rows="3" placeholder="Tahsilatla ilgili notlar..."></textarea></div>
            <button onclick="addCollection()" style="margin-top:15px;">Tahsilat Ekle</button>
        </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Proje Dosyaları</h3>
        <div class="input-group file-upload-input-group">
            <div style="flex-basis: 40%;"><label for="fileUploadInput">Dosya Seç</label><input type="file" id="fileUploadInput" /></div>
            <div style="flex-basis: 40%;"><label for="fileDescriptionInput">Dosya Açıklaması (Opsiyonel)</label><input type="text" id="fileDescriptionInput" placeholder="Örn: Sözleşme V1" /></div>
            <div style="flex-basis: 15%; min-width: 100px;"><button onclick="uploadFile()" style="width:100%;">Yükle</button></div>
        </div>
        <div id="uploadProgress"><div id="uploadProgressBar"></div></div>
        <h4 style="margin-top: 20px;">Yüklenmiş Dosyalar:</h4>
        <ul id="fileList" class="file-list"></ul>
        <p id="noProjectFilesMessage" style="display:none;">Bu projeye henüz dosya yüklenmemiş.</p>
    </section>

    <div style="margin-top: 30px; padding-bottom: 30px;">
        <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
        <button onclick="generateExcelReport()" style="margin-left:10px; background:#27ae60;">Rapor İndir (Excel)</button>
        <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
    </div>
  </main>

  <script>
    const firebaseConfig = {apiKey:"AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",authDomain:"projetakipsistemi-fbabd.firebaseapp.com",projectId:"projetakipsistemi-fbabd",storageBucket:"projetakipsistemi-fbabd.appspot.com",messagingSenderId:"335282912485",appId:"1:335282912485:web:5ad9091ccf3cabd8f8280c"};
    const app=firebase.initializeApp(firebaseConfig);const db=firebase.firestore();const auth=firebase.auth();const storage=firebase.storage();
    const functions = firebase.app().functions('europe-west1'); // Firebase Functions bölgenizi kontrol edin!
    let projectId=null;const predefinedStageNames=["Keşif / Ön görüşme","Teklif oluşturma","Onay – sözleşme","Malzeme temini","Uygulama","Test ve devreye alma","Teslimat"];const defaultProjectStatus="Başlamadı";const projectCategories=["Aydınlatma","Otomasyon","Taahhüt","Danışmanlık","Diğer"];
    let db_project_data={};let activeExchangeRates=null; // Dinamik kurlar buraya gelecek

    function formatCurrency(value,currency='TRY'){const num=parseFloat(value);if(isNaN(num))return currency==='TRY'?"0,00":"0.00";const options={minimumFractionDigits:2,maximumFractionDigits:2};const locale=(currency==='TRY')?'tr-TR':'en-US';try{return new Intl.NumberFormat(locale,options).format(num);}catch(e){return num.toFixed(2).replace('.',(currency==='TRY'?',':'.'));}}
    function parseCurrency(formattedValue,currency='TRY'){if(typeof formattedValue!=='string'||!formattedValue.trim())return 0;let cleanedValue=formattedValue.replace(/[^\d,.-]/g,'');if(currency==='TRY'){cleanedValue=cleanedValue.replace(/\./g,'').replace(',','.');}else{cleanedValue=cleanedValue.replace(/,/g,'');}const number=parseFloat(cleanedValue);return isNaN(number)?0:number;}
    function handleCurrencyInput(event,currencyElementId){const input=event.target;let value=input.value;let currency=document.getElementById(currencyElementId)?document.getElementById(currencyElementId).value:'TRY';let numericValue=value.replace(currency==='TRY'?[^0-9,]:/[^0-9.]/g,'');const parts=numericValue.split(currency==='TRY'?',':'.');if(parts.length>2){numericValue=parts[0]+(currency==='TRY'?',':'.')+parts.slice(1).join('');}input.value=numericValue;}
    function formatInputOnBlur(inputElement,currencyElementId){if(!inputElement)return;let currency=document.getElementById(currencyElementId)?document.getElementById(currencyElementId).value:'TRY';const numericValue=parseCurrency(inputElement.value,currency);inputElement.value=formatCurrency(numericValue,currency);if(typeof updateCalculations==="function")updateCalculations();}
    function updateCalculationsOnCurrencyChange(){if(typeof updateCalculations==="function")updateCalculations();}
    function renderDetailCategoryCheckboxes(){const c=document.getElementById('projectCategoriesCheckboxesContainer');if(!c)return;let lg=c.querySelector('legend');if(!lg){lg=document.createElement('legend');lg.textContent='Proje Kategorileri';}c.innerHTML="";c.appendChild(lg);projectCategories.forEach(cat=>{const id=`detail_${cat.replace(/\s+/g,'-').toLowerCase()}`;const wr=document.createElement('span');wr.style.marginRight="15px";wr.style.display="inline-block";const cb=document.createElement('input');cb.type='checkbox';cb.id=id;cb.value=cat;cb.name='project_category_detail';cb.style.marginRight="5px";cb.style.verticalAlign="middle";cb.onchange=updateProjectCategories;const lb=document.createElement('label');lb.htmlFor=id;lb.textContent=cat;lb.style.fontWeight="normal";lb.style.cursor="pointer";lb.style.verticalAlign="middle";wr.appendChild(cb);wr.appendChild(lb);c.appendChild(wr);});}
    async function updateProjectCategories(){if(!projectId)return;const sel=[];document.querySelectorAll('#projectCategoriesCheckboxesContainer input[type="checkbox"]:checked').forEach(cb=>sel.push(cb.value));try{await db.collection("projects").doc(projectId).update({categories:sel});console.log("Kategoriler güncellendi:",sel);db_project_data.categories=sel;}catch(e){console.error("Kategori güncelleme hatası:",e);alert("Kategoriler güncellenemedi.");}}
    auth.onAuthStateChanged(u=>{if(!u){window.location.href="login.html";}else{const p=new URLSearchParams(window.location.search);projectId=p.get("id");if(projectId){loadProject();}else{alert("Proje ID yok.");goBack();}}});
    async function loadProject(){if(!projectId)return;try{renderDetailCategoryCheckboxes();const ref=db.collection("projects").doc(projectId);const doc=await ref.get();if(!doc.exists){alert("Proje bulunamadı.");goBack();return;}db_project_data=doc.data()||{};const p=db_project_data;document.getElementById("projectName").value=p.name||"";document.getElementById("clientName").value=p.client||"";document.getElementById("startDate").value=p.startDate||"";document.getElementById("endDate").value=p.endDate||"";const contractCurr=p.contractCurrency||"TRY";document.getElementById("contractCurrency").value=contractCurr;document.getElementById("contractValue").value=formatCurrency(p.contractValue||0,contractCurr);document.getElementById("projectStatus").value=p.status||defaultProjectStatus;if(p.categories&&Array.isArray(p.categories)){p.categories.forEach(cat=>{const id=`detail_${cat.replace(/\s+/g,'-').toLowerCase()}`;const cb=document.getElementById(id);if(cb)cb.checked=true;});}
    let stages=p.stages||[];let updStg=false;if(!p.stages||p.stages.length===0){stages=predefinedStageNames.map(n=>({name:n,responsible:"",date:"",notes:"",completed:false}));updStg=true;}else if(stages.length!==predefinedStageNames.length||stages.some((s,i)=>s.name!==predefinedStageNames[i])){const newStg=predefinedStageNames.map(n=>{const es=stages.find(s1=>s1.name===n);return{name:n,responsible:es?.responsible||"",date:es?.date||"",notes:es?.notes||"",completed:es?.completed||false};});stages=newStg;updStg=true;}if(updStg&&stages.length>0){await ref.update({stages:stages});db_project_data.stages=stages;}
    renderStages(stages);renderExpenses(p.expenses||[]);renderCollections(p.collections||[]);renderFiles(p.files||[]);
    // Kur alımı ve hesaplamaların güncellenmesi:
    const today = new Date().toISOString().split('T')[0];
    await fetchAndSetExchangeRates(today); // Sayfa yüklendiğinde güncel kurları çek
    updateCalculations();}catch(e){console.error("Proje yükleme hatası:",e);alert("Detaylar yüklenemedi.");}}
    function renderStages(data){const tb=document.querySelector("#stagesTable tbody");tb.innerHTML="";predefinedStageNames.forEach((sName,i)=>{let s=data.find(st=>st.name===sName)||( {name:sName,responsible:"",date:"",notes:"",completed:false});tb.insertAdjacentHTML("beforeend",`<tr><td>${s.name}</td><td><input type="text" value="${s.responsible||''}" data-idx="${i}" data-field="responsible" class="stage-input"></td><td><input type="date" value="${s.date||''}" data-idx="${i}" data-field="date" class="stage-input"></td><td><textarea class="stage-notes-input stage-input" data-idx="${i}" data-field="notes">${s.notes||''}</textarea></td><td><input type="checkbox" ${s.completed?"checked":""} data-idx="${i}" data-field="completed" class="stage-input"></td></tr>`);});
    tb.querySelectorAll(".stage-input").forEach(inp=>{const idx=parseInt(inp.dataset.idx),fld=inp.dataset.field;inp.addEventListener((fld==="completed"?"change":(inp.tagName==='TEXTAREA'?"blur":"blur")),e=>saveStageField(idx,fld,(fld==="completed"?e.target.checked:e.target.value)));});}
    async function saveStageField(idx,fld,val){if(!projectId)return;try{const ref=db.collection("projects").doc(projectId);const doc=await ref.get();if(!doc.exists)return;let stg=doc.data().stages||[];if(!stg.length||stg.length!==predefinedStageNames.length||stg.some((s,i)=>s.name!==predefinedStageNames[i])){stg=predefinedStageNames.map(n=>{const es=stg.find(s1=>s1.name===n);return{name:n,responsible:es?.responsible||"",date:es?.date||"",notes:es?.notes||"",completed:es?.completed||false};});}
    if(stg[idx]){stg[idx][fld]=val;await ref.update({stages:stg});db_project_data.stages=stg;}}catch(e){console.error(`Aşama ${fld} güncelleme hatası:`,e);}}
    async function updateProjectStatus(newSt){if(!projectId)return;try{await db.collection("projects").doc(projectId).update({status:newSt});console.log("Durum güncellendi:",newSt);db_project_data.status=newSt;}catch(e){console.error("Durum güncelleme hatası:",e);alert("Durum güncellenemedi.");}}
    function renderExpenses(list){const tb=document.querySelector("#expensesTable tbody");if(!tb){return;}tb.innerHTML="";(list||[]).forEach((it,idx)=>{const currency=it.currency||'TRY';const amountFormatted=formatCurrency(it.amount||0,currency);const expenseDate=it.date||'N/A';tb.insertAdjacentHTML("beforeend",`<tr><td>${expenseDate}</td><td>${it.desc||'Açıklama Yok'}</td><td style="text-align:right;">${amountFormatted}</td><td>${currency}</td><td><button onclick="removeExpense(${idx})" class="delete-file-btn">Sil</button></td></tr>`);});}
    async function addExpense(){const date=document.getElementById("expenseDate").value;const desc=document.getElementById("expenseDesc").value.trim();const amountIn=document.getElementById("expenseAmount");const currency=document.getElementById("expenseCurrency").value;const amount=parseCurrency(amountIn.value,currency);if(!date){alert("Lütfen harcama tarihini girin.");return;}if(!desc||isNaN(amount)||amount<=0){alert("Geçerli açıklama ve tutar girin.");return;}
    const newExpense={date,desc,amount,currency,addedAt:firebase.firestore.Timestamp.now()};try{const ref=db.collection("projects").doc(projectId);await ref.update({expenses:firebase.firestore.FieldValue.arrayUnion(newExpense)});document.getElementById("expenseDate").value="";document.getElementById("expenseDesc").value="";amountIn.value=formatCurrency(0,currency);document.getElementById("expenseCurrency").value="TRY";if(db_project_data.expenses)db_project_data.expenses.push(newExpense);else db_project_data.expenses=[newExpense];renderExpenses(db_project_data.expenses);updateCalculations();alert("Harcama eklendi.");}catch(e){console.error("Harcama ekleme hatası:",e);alert("Harcama eklenemedi.");}}
    async function removeExpense(idx){if(!confirm("Bu harcama silinsin mi?"))return;try{const ref=db.collection("projects").doc(projectId);if(db_project_data.expenses&&db_project_data.expenses[idx]){db_project_data.expenses.splice(idx,1);await ref.update({expenses:db_project_data.expenses});renderExpenses(db_project_data.expenses);updateCalculations();alert("Harcama silindi.");}else{alert("Harcama bulunamadı.");}}catch(e){console.error("Harcama silme hatası:",e);alert("Harcama silinemedi.");}}
    function renderCollections(arr){const tb=document.querySelector("#collectionsTable tbody");const msg=document.getElementById("noCollectionsMessage");if(!tb||!msg)return;tb.innerHTML="";if(arr&&arr.length>0){msg.style.display="none";arr.forEach((col,idx)=>{let currency=col.currency||'TRY';let amtDisp=col.type==="Barter"&&col.barterDetails?formatCurrency(col.barterDetails.value||0,currency):formatCurrency(col.amount||0,currency);let descDisp=col.description||'';let dueDateDisp='-';if(col.type==="Çek"&&col.checkDetails){descDisp+=`${descDisp?' <br> ':''}Çek No: ${col.checkDetails.checkNo||'N/A'}, Banka: ${col.checkDetails.bank||'N/A'}`;dueDateDisp=col.checkDetails.dueDate||'N/A';}else if(col.type==="Barter"&&col.barterDetails){descDisp+=`${descDisp?' - ':''}Takas: ${col.barterDetails.asset||'Belirtilmemiş'}`;}
    tb.insertAdjacentHTML("beforeend",`<tr><td>${col.date||'N/A'}</td><td>${col.type||'N/A'}</td><td>${descDisp}</td><td>${dueDateDisp}</td><td style="text-align:right;">${amtDisp}</td><td>${currency}</td><td><button class="delete-file-btn" onclick="removeCollection(${idx})">Sil</button></td></tr>`);});}else{msg.style.display="block";}updateCalculations();}
    function toggleCollectionDetails(){const t=document.getElementById('collectionType').value;document.getElementById('checkDetailsGroup').style.display=t==='Çek'?'block':'none';document.getElementById('barterDetailsGroup').style.display=t==='Barter'?'block':'none';document.getElementById('collectionAmountGroup').style.display=t==='Barter'?'none':'block';}
    async function addCollection(){const dateInput=document.getElementById('collectionDate').value;const type=document.getElementById('collectionType').value;const description=document.getElementById('collectionDescription').value.trim();const currency=document.getElementById('collectionCurrency').value;let amount=0,checkDetails=null,barterDetails=null;if(!dateInput||!type){alert("Tarih ve tip seçin.");return;}
    if(type==="Nakit"||type==="Banka Transferi"){amount=parseCurrency(document.getElementById('collectionAmount').value,currency);if(isNaN(amount)||amount<=0){alert("Geçerli tutar.");return;}}else if(type==="Çek"){amount=parseCurrency(document.getElementById('collectionAmount').value,currency);const dueDate=document.getElementById('checkDueDate').value;const checkNo=document.getElementById('checkNumber').value.trim();const bank=document.getElementById('checkBank').value.trim();if(isNaN(amount)||amount<=0||!dueDate||!checkNo||!bank){alert("Çek detayları ve tutar.");return;}checkDetails={dueDate,checkNo,bank};}else if(type==="Barter"){const asset=document.getElementById('barterAsset').value.trim();const value=parseCurrency(document.getElementById('barterValue').value,currency);if(!asset||isNaN(value)||value<=0){alert("Barter varlık ve değer.");return;}barterDetails={asset,value};}
    const newCollection={date:dateInput,type,description,amount:(type!=="Barter"?amount:null),currency,checkDetails,barterDetails,addedAt:firebase.firestore.Timestamp.now()};
    try{const projectRef=db.collection("projects").doc(projectId);await projectRef.update({collections:firebase.firestore.FieldValue.arrayUnion(newCollection)});['collectionDate','collectionDescription','checkDueDate','checkNumber','checkBank','barterAsset'].forEach(id=>document.getElementById(id).value="");document.getElementById('collectionType').value="Nakit";document.getElementById('collectionCurrency').value="TRY";document.getElementById('collectionAmount').value=formatCurrency(0,"TRY");document.getElementById('barterValue').value=formatCurrency(0,"TRY");toggleCollectionDetails();
    if(db_project_data.collections)db_project_data.collections.push(newCollection);else db_project_data.collections=[newCollection];renderCollections(db_project_data.collections);alert("Tahsilat eklendi.");}catch(error){console.error("Tahsilat eklenirken Firestore hatası:",error);alert(`Tahsilat eklenemedi. Hata: ${error.message}`);}}
    async function removeCollection(idx){if(!confirm("Bu tahsilat silinsin mi?"))return;try{const ref=db.collection("projects").doc(projectId);if(db_project_data.collections&&db_project_data.collections[idx]){db_project_data.collections.splice(idx,1);await ref.update({collections:db_project_data.collections});renderCollections(db_project_data.collections);alert("Tahsilat silindi.");}else{alert("Tahsilat bulunamadı.");}}catch(e){console.error("Tahsilat silme hatası:",e);alert("Tahsilat silinemedi.");}}
    
    // KUR ALMA FONKSİYONLARI (Firebase Function çağrısı)
    async function getExchangeRatesForDate(dateToFetch) {
        const exchangeRateInfoDiv = document.getElementById('exchangeRateInfo');
        if (!exchangeRateInfoDiv) { console.error("exchangeRateInfoDiv bulunamadı!"); return null; }
        exchangeRateInfoDiv.textContent = `${dateToFetch} için TCMB kurları alınıyor...`;
        exchangeRateInfoDiv.style.display = 'block'; exchangeRateInfoDiv.style.color = '#555';
        try {
            const getRates = functions.httpsCallable('getTCMBRatesForDate'); 
            const result = await getRates({ date: dateToFetch });
            if (result.data && (result.data.USD || result.data.EUR)) {
                exchangeRateInfoDiv.textContent = `Kurlar (${dateToFetch} itibarıyla): USD/TRY: ${result.data.USD?.ForexBuying?.toFixed(4) || 'N/A'}, EUR/TRY: ${result.data.EUR?.ForexBuying?.toFixed(4) || 'N/A'}`;
                return result.data; // { USD: { ForexBuying: ... }, EUR: { ForexBuying: ... } }
            } else {
                throw new Error(result.data?.error || "Kur bilgisi bulunamadı.");
            }
        } catch (error) {
            console.error(`Firebase Function ile kur alınırken hata (${dateToFetch}):`, error);
            exchangeRateInfoDiv.textContent = `Kur bilgisi alınamadı (${dateToFetch}). Hesaplamalarda varsayılan/sabit kurlar kullanılacak.`;
            exchangeRateInfoDiv.style.color = 'red';
            return null;
        }
    }
    async function fetchAndSetExchangeRatesForToday() {
        const today = new Date().toISOString().split('T')[0];
        let fetchedRates = await getExchangeRatesForDate(today);
        if (!fetchedRates || (!fetchedRates.USD && !fetchedRates.EUR)) {
            console.warn("Bugünün kuru alınamadı, dünkü deneniyor...");
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            fetchedRates = await getExchangeRatesForDate(yesterday.toISOString().split('T')[0]);
        }
        if (!fetchedRates || (!fetchedRates.USD && !fetchedRates.EUR)) {
            console.warn("Dinamik kur alınamadı, lokal sabit kurlar kullanılacak.");
            document.getElementById('exchangeRateInfo').textContent = `DİKKAT: Güncel kur bilgisi alınamadı! Yaklaşık sabit kurlar kullanılıyor. USD/TRY: ${localExchangeRates.USD_TO_TRY}, EUR/TRY: ${localExchangeRates.EUR_TO_TRY}`;
            document.getElementById('exchangeRateInfo').style.color = 'orange';
            fetchedRates = { USD: { ForexBuying: localExchangeRates.USD_TO_TRY }, EUR: { ForexBuying: localExchangeRates.EUR_TO_TRY }};
        }
        activeExchangeRates = fetchedRates; // activeExchangeRates'i en son geçerli kurla set et
    }

    function convertToMainCurrency(amount, fromCurrency, mainCurrency, ratesToUse) {
        if (fromCurrency === mainCurrency) return amount;
        if (!ratesToUse || (!ratesToUse.USD && !ratesToUse.EUR)) { 
            console.warn(`Kur bilgisi eksik veya geçersiz. ${fromCurrency} -> ${mainCurrency} çevrimi yapılamıyor. Orijinal tutar döndürüldü.`); return amount; 
        }
        const usdRate = ratesToUse.USD?.ForexBuying; const eurRate = ratesToUse.EUR?.ForexBuying;
        if (mainCurrency === 'TRY') {
            if (fromCurrency === 'USD' && usdRate) return amount * usdRate;
            if (fromCurrency === 'EUR' && eurRate) return amount * eurRate;
        } else if (mainCurrency === 'USD') {
            if (fromCurrency === 'TRY' && usdRate) return amount / usdRate;
            if (fromCurrency === 'EUR' && eurRate && usdRate) return amount * (eurRate / usdRate);
        } else if (mainCurrency === 'EUR') {
            if (fromCurrency === 'TRY' && eurRate) return amount / eurRate;
            if (fromCurrency === 'USD' && usdRate && eurRate) return amount * (usdRate / eurRate);
        }
        console.warn(`Desteklenmeyen veya eksik kur bilgisiyle çevrim: ${fromCurrency} -> ${mainCurrency}. Orijinal tutar: ${amount}`); return amount; 
    }

    function updateCalculations(){
        if (!db_project_data) return;
        const contractCurrency = document.getElementById("contractCurrency").value || db_project_data.contractCurrency || 'TRY';
        ['Expenses', 'Profit', 'Collections', 'Balance'].forEach(label => {
            const span = document.getElementById(`contractCurrencyLabelFor${label}`);
            if(span) span.textContent = contractCurrency;
        });
        const contract=parseCurrency(document.getElementById("contractValue").value, contractCurrency);
        const ratesForCalc = activeExchangeRates || { USD: { ForexBuying: localExchangeRates.USD_TO_TRY }, EUR: { ForexBuying: localExchangeRates.EUR_TO_TRY }};

        let totalCostConverted=0; (db_project_data.expenses || []).forEach(exp=>{ totalCostConverted += convertToMainCurrency(exp.amount || 0, exp.currency || 'TRY', contractCurrency, ratesForCalc);});
        let totalCollConverted=0; (db_project_data.collections || []).forEach(col=>{const amount = col.type==="Barter"&&col.barterDetails?(col.barterDetails.value||0):(col.amount||0);totalCollConverted+=convertToMainCurrency(amount,col.currency||'TRY',contractCurrency,ratesForCalc);});
        const profit=contract-totalCostConverted;const margin=contract>0?(profit/contract)*100:0;const remain=contract-totalCollConverted;
        document.getElementById("totalExpenses").value=formatCurrency(totalCostConverted, contractCurrency);document.getElementById("realizedProfit").value=formatCurrency(profit, contractCurrency);document.getElementById("realizedProfitMargin").value=margin.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});document.getElementById("totalCollections").value=formatCurrency(totalCollConverted, contractCurrency);document.getElementById("remainingBalance").value=formatCurrency(remain, contractCurrency);
    }
    async function saveDetails(){const ref=db.collection("projects").doc(projectId);const contractCurr=document.getElementById("contractCurrency").value;try{const newContractValue=parseCurrency(document.getElementById("contractValue").value,contractCurr);await ref.update({startDate:document.getElementById("startDate").value,endDate:document.getElementById("endDate").value,contractValue:newContractValue,contractCurrency:contractCurr});db_project_data.startDate=document.getElementById("startDate").value;db_project_data.endDate=document.getElementById("endDate").value;db_project_data.contractValue=newContractValue;db_project_data.contractCurrency=contractCurr;alert("Sözleşme bilgileri kaydedildi.");updateCalculations();}catch(e){console.error("Detay kaydetme hatası:",e);alert("Bilgiler kaydedilemedi.");}}
    function renderFiles(files){const ul=document.getElementById("fileList");const msg=document.getElementById("noProjectFilesMessage");if(!ul||!msg){return;}ul.innerHTML="";if(files&&files.length>0){msg.style.display="none";files.forEach((f,i)=>{ul.innerHTML+=`<li><div><a href="${f.url}" target="_blank" class="file-name" title="İndir: ${f.name}">${f.name}</a>${f.description?`<span class="file-description">${f.description}</span>`:''}</div><button class="delete-file-btn" onclick="deleteFile(${i},'${f.name}','${f.path}')">Sil</button></li>`;});}else{msg.style.display="block";}}
    async function uploadFile(){const fin=document.getElementById('fileUploadInput');const din=document.getElementById('fileDescriptionInput');const f=fin.files[0];const dsc=din.value.trim();const pBarC=document.getElementById('uploadProgress');const pBar=document.getElementById('uploadProgressBar');if(!f){alert("Dosya seçin.");return;}if(!projectId){alert("Proje ID yok.");return;}
    const fNameStore=`${Date.now()}_${f.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;const fPath=`projects/${projectId}/${fNameStore}`;const fRef=storage.ref(fPath);try{const task=fRef.put(f);pBarC.style.display='block';task.on('state_changed',(s)=>{const prog=(s.bytesTransferred/s.totalBytes)*100;pBar.style.width=prog+'%';pBar.textContent=Math.round(prog)+'%';},(err)=>{console.error("Yükleme hatası:",err);alert(`Yükleme hatası: ${err.message}`);pBarC.style.display='none';},async ()=>{pBarC.style.display='none';pBar.style.width='0%';pBar.textContent='';const url=await task.snapshot.ref.getDownloadURL();const pRef=db.collection("projects").doc(projectId);const newFileEntry={name:f.name,url,path:fPath,description:dsc,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()};await pRef.update({files:firebase.firestore.FieldValue.arrayUnion(newFileEntry)});alert("Dosya yüklendi!");fin.value="";din.value="";
    if(db_project_data.files)db_project_data.files.push({...newFileEntry,uploadedAt:new Date()});else db_project_data.files=[{...newFileEntry,uploadedAt:new Date()}];renderFiles(db_project_data.files);});}catch(e){console.error("Yükleme başlatma hatası:",e);alert("Yükleme başlatılamadı.");pBarC.style.display='none';}}
    async function deleteFile(idx,name,path){if(!confirm(`"${name}" silinsin mi?`))return;if(!projectId||!path){alert("Silinemedi, bilgi eksik.");return;}try{await storage.ref(path).delete();
    if(db_project_data.files){db_project_data.files=db_project_data.files.filter(f=>f.path!==path);}const pRef=db.collection("projects").doc(projectId);await pRef.update({files:db_project_data.files});renderFiles(db_project_data.files);alert(`"${name}" silindi.`);}catch(e){console.error("Dosya silme hatası:",e);if(e.code==='storage/object-not-found'){alert("Dosya Storage'da yok. DB kaydı siliniyor.");if(db_project_data.files){db_project_data.files=db_project_data.files.filter(f=>f.path!==path);}const pRef=db.collection("projects").doc(projectId);await pRef.update({files:db_project_data.files});renderFiles(db_project_data.files);}else{alert(`Silme hatası: ${e.message}`);}}}
    async function generateExcelReport(){if(!projectId){alert("Proje bulunamadı.");return;}const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(!pDoc.exists){alert("Proje verisi yok.");return;}const p=pDoc.data();const contractCurr=p.contractCurrency||'TRY';const wb=XLSX.utils.book_new();
    const generalInfoData=[["Proje Adı",p.name||'N/A'],["Müşteri Adı",p.client||'N/A'],["Proje Durumu",p.status||defaultProjectStatus],["Kategoriler",(p.categories||[]).join(", ")||'N/A'],["Sözleşme Başlangıcı",p.startDate||'N/A'],["Sözleşme Bitişi",p.endDate||'N/A'],["Sözleşme P.B.",contractCurr]];const wsGeneral=XLSX.utils.aoa_to_sheet(generalInfoData);XLSX.utils.book_append_sheet(wb,wsGeneral,"Genel Bilgiler");
    const stagesHeaders=["Aşama Adı","Sorumlu Kişi","Tarih","Notlar","Durum"];const stagesBody=(p.stages||[]).map(s=>[s.name,s.responsible,s.date,s.notes||'',s.completed?"Tamamlandı":"Tamamlanmadı"]);const wsStages=XLSX.utils.aoa_to_sheet([stagesHeaders,...stagesBody]);XLSX.utils.book_append_sheet(wb,wsStages,"Aşamalar");
    const expensesHeaders=["Harcama Tarihi","Açıklama","Tutar","Para Birimi"];const expensesBody=(p.expenses||[]).map(e=>[e.date||'N/A',e.desc,e.amount,e.currency||'TRY']);const wsExpenses=XLSX.utils.aoa_to_sheet([expensesHeaders,...expensesBody]);
    (expensesBody||[]).forEach((r,i)=>{const adr=XLSX.utils.encode_cell({c:2,r:i+1});if(wsExpenses[adr]){wsExpenses[adr].t='n';wsExpenses[adr].z=`#,##0.00"${r[3]?" "+r[3]:""}"`;}});XLSX.utils.book_append_sheet(wb,wsExpenses,"Harcamalar");
    const collectionsHeaders=["Tarih","Tip","Açıklama / Detay","Vade Tarihi","Tutar/Değer","Para Birimi"];const collectionsBody=(p.collections||[]).map(c=>{let amt=0;let desc=c.description||'';let dueDate='-';let curr=c.currency||'TRY';if(c.type==="Barter"&&c.barterDetails){amt=c.barterDetails.value||0;desc+=`${desc?' - ':''}Takas:${c.barterDetails.asset||'Belirtilmemiş'}`;}else if(c.type==="Çek"&&c.checkDetails){amt=c.amount||0;desc+=`${desc?'<br>':''}Çek No:${c.checkDetails.checkNo||'N/A'},Banka:${c.checkDetails.bank||'N/A'}`;dueDate=c.checkDetails.dueDate||'-';}else{amt=c.amount||0;}return[c.date,c.type,desc.replace(/<br\s*\/?>/gi,' '),dueDate,amt,curr];});
    const wsCollections=XLSX.utils.aoa_to_sheet([collectionsHeaders,...collectionsBody]);
    (collectionsBody||[]).forEach((r,i)=>{const adr=XLSX.utils.encode_cell({c:4,r:i+1});if(wsCollections[adr]){wsCollections[adr].t='n';wsCollections[adr].z=`#,##0.00"${r[5]?" "+r[5]:""}"`;}});XLSX.utils.book_append_sheet(wb,wsCollections,"Tahsilatlar");
    const ratesForReport = activeExchangeRates || { USD: { ForexBuying: localExchangeRates.USD_TO_TRY }, EUR: { ForexBuying: localExchangeRates.EUR_TO_TRY }}; // Excel raporu için kurlar
    let totalExpConverted=0;(p.expenses||[]).forEach(e=>{totalExpConverted+=convertToMainCurrency(e.amount||0,e.currency||'TRY',contractCurr,ratesForReport);});
    let totalCollConverted=0;(p.collections||[]).forEach(c=>{const amt=c.type==="Barter"&&c.barterDetails?(c.barterDetails.value||0):(c.amount||0);totalCollConverted+=convertToMainCurrency(amt,c.currency||'TRY',contractCurr,ratesForReport);});
    const contractVal=p.contractValue||0;const realProfit=contractVal-totalExpConverted;const profitMargin=contractVal>0?(realProfit/contractVal)*100:0;const remainBal=contractVal-totalCollConverted;
    const financialData=[["Sözleşme Tutarı",contractVal,contractCurr],["Toplam Harcama ("+contractCurr+")",totalExpConverted,contractCurr],["Gerçekleşen Kar ("+contractCurr+")",realProfit,contractCurr],["Kar Marjı (%)",profitMargin],["Toplam Tahsil Edilen ("+contractCurr+")",totalCollConverted,contractCurr],["Kalan Bakiye ("+contractCurr+")",remainBal,contractCurr]];
    const wsFinancial=XLSX.utils.aoa_to_sheet(financialData);
    financialData.forEach((r,i)=>{const adr1=XLSX.utils.encode_cell({c:1,r:i});if(wsFinancial[adr1]){wsFinancial[adr1].t='n';wsFinancial[adr1].z=i===3?'0.00%':`#,##0.00" ${r[2]}"`;if(i===3)wsFinancial[adr1].v=profitMargin/100;}});XLSX.utils.book_append_sheet(wb,wsFinancial,"Finansal Özet");
    if(p.files&&p.files.length>0){const filesHeaders=["Dosya Adı","Açıklama","Yüklenme Tarihi","URL"];const filesBody=(p.files||[]).map(f=>[f.name,f.description||'',f.uploadedAt?.toDate?f.uploadedAt.toDate().toLocaleDateString('tr-TR'):'N/A',f.url]);const wsFiles=XLSX.utils.aoa_to_sheet([filesHeaders,...filesBody]);XLSX.utils.book_append_sheet(wb,wsFiles,"Proje Dosyaları");}
    const fileName=`${p.name?p.name.replace(/[^a-zA-Z0-9]/g,'_'):'proje'}_rapor.xlsx`;XLSX.writeFile(wb,fileName);alert("Excel raporu oluşturuldu ve indiriliyor.");}
    let sortDirections={};function sortTable(tableId,columnIndex,dataType='string'){const table=document.getElementById(tableId);if(!table||!table.tBodies[0]||table.tBodies[0].rows.length===0){return;}const tbody=table.tBodies[0];const rows=Array.from(tbody.rows);const headerCells=table.tHead.rows[0].cells;const headerCell=headerCells[columnIndex];const currentSortKey=`${tableId}-${columnIndex}`;let newDirection='asc';if(sortDirections[currentSortKey]==='asc'){newDirection='desc';}
    for(let i=0;i<headerCells.length;i++){headerCells[i].classList.remove('sort-asc','sort-desc');}sortDirections={};sortDirections[currentSortKey]=newDirection;headerCell.classList.add(newDirection==='asc'?'sort-asc':'sort-desc');
    rows.sort((rowA,rowB)=>{let valA=rowA.cells[columnIndex].textContent.trim();let valB=rowB.cells[columnIndex].textContent.trim();if(dataType==='number'){const cleanA=valA.replace(/[^\d,.-]/g,'').replace(',','.');const cleanB=valB.replace(/[^\d,.-]/g,'').replace(',','.');valA=parseFloat(cleanA)||0;valB=parseFloat(cleanB)||0;}else if(dataType==='date'){const parseDate=(dateStr)=>{if(!dateStr||dateStr.toLowerCase()==="n/a"||dateStr.trim()==="-")return newDirection==='asc'?Infinity:-Infinity;
    let parts=dateStr.split('-');if(parts.length===3&&parts[0].length===4)return new Date(parts[0],parts[1]-1,parts[2]).getTime();parts=dateStr.split('.');if(parts.length===3&&parts[2].length===4)return new Date(parts[2],parts[1]-1,parts[0]).getTime();const parsed=new Date(dateStr).getTime();return isNaN(parsed)?(newDirection==='asc'?Infinity:-Infinity):parsed;};valA=parseDate(valA);valB=parseDate(valB);}else{valA=valA.toLowerCase();valB=valB.toLowerCase();}
    if(valA<valB)return newDirection==='asc'?-1:1;if(valA>valB)return newDirection==='asc'?1:-1;return 0;});rows.forEach(row=>tbody.appendChild(row));}
    function goBack(){window.location.href="index.html";}
    function logout(){auth.signOut().then(()=>window.location.href="login.html").catch(e=>{console.error("Çıkış hatası:",e);alert("Çıkış hatası.");});}
    // --- TÜM JavaScript Kodu Sonu ---
  </script>
</body>
</html>
