<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Detayları</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body{font-family:'Poppins',sans-serif;margin:0;background-color:#f9fbfd;color:#2c3e50}header{background-color:#34495e;color:white;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.header-content-left{flex:1}.logo-title-container{display:flex;flex-direction:column;align-items:center;text-align:center;flex:2}header img{height:40px;width:auto;margin-bottom:5px}header h1{font-weight:600;font-size:1.6rem;margin:0}.header-content-right{flex:1;display:flex;justify-content:flex-end}.header-content-right button{margin-top:0}main{max-width:1100px;margin:30px auto;padding:0 20px}h3{color:#34495e;margin-top:30px;margin-bottom:15px;border-bottom:2px solid #2980b9;padding-bottom:8px}label{display:block;margin:12px 0 6px;font-weight:600}input,button,select,textarea{padding:10px 12px;font-size:1rem;border-radius:6px;border:1px solid #ccc;outline:none;transition:border-color .3s ease;width:100%;box-sizing:border-box}input:not([type=checkbox]),select,textarea{width:100%}input[type=checkbox]{width:auto}input:focus,select:focus,textarea:focus{border-color:#2980b9;box-shadow:0 0 5px #2980b9}button{background-color:#2980b9;border:none;color:white;cursor:pointer;font-weight:600;transition:background-color .3s ease;margin-top:10px;border-radius:6px;width:auto;padding:10px 20px}button:hover{background-color:#1c5980}table{width:100%;border-collapse:collapse;background:white;margin-top:25px;border:1px solid #ddd;border-radius:8px;overflow:visible;box-shadow:0 2px 8px rgba(0,0,0,0.1)}th,td{padding:10px 12px;border-bottom:1px solid #e3e6ea;text-align:left;font-size:.9em}thead{background-color:#2980b9;color:white;font-weight:600}tr:hover{background-color:#ecf6fc}.input-group{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}.input-group>div{flex:1;min-width:150px}.input-group button{margin-top:0}.readonly{background-color:#f0f0f0;cursor:not-allowed}input[type=text].currency-input{text-align:right}.category-checkbox-group{margin-top:15px;margin-bottom:20px;padding:10px;border:1px solid #eee;border-radius:6px;background-color:#fdfdfd}.category-checkbox-group legend{font-weight:600;padding:0 5px;margin-left:5px;color:#34495e}.category-checkbox-group label{display:inline-block;margin-right:15px;font-weight:normal;cursor:pointer;margin-top:0;margin-bottom:5px}.category-checkbox-group input[type=checkbox]{margin-right:5px;vertical-align:middle}.stage-notes-input{width:100%;min-height:30px;padding:6px;font-size:.85em;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;resize:vertical}.file-list{list-style-type:none;padding:0}.file-list li{background-color:#f8f9fa;border:1px solid #dee2e6;padding:8px 12px;margin-bottom:5px;border-radius:4px;display:flex;justify-content:space-between;align-items:center}.file-list .file-name{font-weight:600;}.file-list .file-description{font-size:0.85em;color:#555;margin-top:3px;}.file-list a{color:#007bff;text-decoration:none}.file-list a:hover{text-decoration:underline}.delete-file-btn{background-color:#dc3545;color:white;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;font-size:.8em}.delete-file-btn:hover{background-color:#c82333}#uploadProgress{width:100%;background-color:#e9ecef;border-radius:.25rem;margin-top:5px;height:10px;display:none}#uploadProgressBar{width:0%;height:100%;background-color:#28a745;border-radius:.25rem;text-align:center;line-height:10px;color:white;font-size:.7em}.collection-details-fields{display:none;padding-left:15px;border-left:2px solid #eee;margin-left:5px;margin-top:10px}#collectionsTable td,#collectionsTable th{font-size:.85em}.report-table th.sortable{cursor:pointer}.report-table th.sortable:hover{background-color:#e9ecef}.report-table th.sortable::after{content:' \00A0\2195';font-size:.8em;opacity:.5}.report-table th.sort-asc::after{content:' \00A0\2191';opacity:1}.report-table th.sort-desc::after{content:' \00A0\2193';opacity:1}.exchange-rate-display{margin-top:5px;padding:5px 8px;background-color:#f0f8ff;border:1px solid #cce7ff;border-radius:4px;font-size:.85em;display:flex;gap:10px;flex-wrap:wrap;align-items:center}.exchange-rate-display span{font-weight:500;color:#0056b3}.exchange-rate-display .error{color:red;font-weight:normal}.currency-select-group{display:flex;gap:10px;align-items:flex-end;margin-top:5px}.currency-select-group input{flex-grow:3}.currency-select-group select{flex-grow:1;min-width:70px;height:43px;padding:8px 10px}
    @media print{ /* ... (Yazdırma stilleri aynı) ... */ }
    @media (max-width:768px){ /* ... (Mobil stiller aynı) ... */ }
  </style>
</head>
<body>
  <header>
    <div class="header-content-left"></div>
    <div class="logo-title-container">
      <img src="https://powerlinemersin.github.io/projetakip/logo.png" alt="Powerline Mersin" />
      <h1>Proje Detayları</h1>
    </div>
    <div class="header-content-right">
      <button onclick="logout()" style="background:#e74c3c; color:white;">Çıkış Yap</button>
    </div>
  </header>
  <main>
    <section>
      <h3>Genel Bilgiler</h3>
      <div class="input-group">
        <div style="flex: 2;"><label for="projectName">Proje Adı</label><input type="text" id="projectName" class="readonly" readonly /></div>
        <div style="flex: 2;"><label for="clientName">Müşteri Adı</label><input type="text" id="clientName" class="readonly" readonly /></div>
        <div style="flex: 1;"><label for="projectStatus">Proje Durumu</label><select id="projectStatus" onchange="updateProjectStatus(this.value)"><option value="Başlamadı">Başlamadı</option><option value="Devam Ediyor">Devam Ediyor</option><option value="Takip Ediliyor">Takip Ediliyor</option><option value="Tamamlandı">Tamamlandı</option></select></div>
      </div>
      <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer"><legend>Proje Kategorileri</legend></fieldset>
      <h3>Aşamalar & Sorumlular</h3>
      <table id="stagesTable">
        <thead><tr><th>Aşama</th><th>Sorumlu Kişi</th><th>Tarih</th><th>Notlar/Açıklama</th><th>Tamamlandı mı?</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="input-group" style="margin-top: 20px;">
        <div><label for="startDate">Sözleşme Başlangıcı</label><input type="date" id="startDate" /></div>
        <div><label for="endDate">Sözleşme Bitişi</label><input type="date" id="endDate" /></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Sözleşme ve Kar Hesapları</h3>
      <div class="input-group">
          <div>
            <label for="contractValue">Sözleşme Tutarı</label>
            <div class="currency-select-group">
                <input type="text" id="contractValue" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event, 'contractValue')"/>
                <select id="contractCurrency" onchange="fetchRatesAndUpdateCalculations('contractRates', document.getElementById('startDate').value || new Date().toISOString().split('T')[0], true)">
                    <option value="TRY" selected>TRY</option><option value="USD">USD</option><option value="EUR">EUR</option>
                </select>
            </div>
            <div id="contractRates" class="exchange-rate-display" style="display:none;">
                 TL Karşılığı (Yaklaşık): <span id="contractValueTRYRate">N/A</span>
            </div>
          </div>
          <div><label for="totalExpenses">Toplam Harcama (TL)</label><input type="text" id="totalExpenses" class="readonly currency-input" readonly /></div>
      </div>
      <div class="input-group">
          <div><label for="realizedProfit">Gerçekleşen Kar (TL)</label><input type="text" id="realizedProfit" class="readonly currency-input" readonly /></div>
          <div><label for="realizedProfitMargin">Gerçekleşen Kar Marjı (%)</label><input type="text" id="realizedProfitMargin" class="readonly" readonly style="text-align: right;"/></div>
      </div>
      <div class="input-group" style="margin-top:10px;">
          <div><label for="totalCollections">Toplam Tahsil Edilen (TL)</label><input type="text" id="totalCollections" class="readonly currency-input" readonly /></div>
          <div><label for="remainingBalance">Kalan Bakiye (TL)</label><input type="text" id="remainingBalance" class="readonly currency-input" readonly /></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Harcama Kalemleri</h3>
      <table id="expensesTable" class="report-table">
        <thead><tr><th>Açıklama</th><th class="sortable" onclick="sortTable('expensesTable', 1, 'number')">Orijinal Tutar</th><th class="sortable" onclick="sortTable('expensesTable', 2, 'string')">P.B.</th><th class="sortable" onclick="sortTable('expensesTable', 3, 'number')" style="text-align:right;">Tutar (TL)</th><th>İşlem</th></tr></thead>
        <tbody></tbody>
      </table>
        <p id="noExpensesMessage" style="text-align:center; margin-top:10px; display:none;">Henüz harcama eklenmemiş.</p>
      <div style="margin-top: 20px; padding:15px; border:1px solid #ddd; border-radius:8px;">
        <h4>Yeni Harcama Ekle</h4>
        <div class="input-group">
            <div><label for="expenseDate">Harcama Tarihi:</label><input type="date" id="expenseDate" onchange="fetchRatesAndUpdateCalculations('expenseRates', this.value)"/></div>
            <div><label for="expenseDesc">Açıklama:</label><input type="text" id="expenseDesc" placeholder="Açıklama" /></div>
        </div>
        <div id="expenseRates" class="exchange-rate-display" style="display:none;">
             <span>USD: <span id="expenseUsdRate">Yükleniyor...</span> TL</span>
             <span>EUR: <span id="expenseEurRate">Yükleniyor...</span> TL</span>
        </div>
        <div class="currency-select-group" style="margin-top:10px;">
            <label for="expenseAmount" style="width:100%; margin-bottom:5px;">Tutar:</label>
            <input type="text" id="expenseAmount" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event, 'expenseAmount')"/>
            <select id="expenseCurrency">
                <option value="TRY" selected>TRY</option><option value="USD">USD</option><option value="EUR">EUR</option>
            </select>
        </div>
        <button onclick="addExpense()" style="margin-top:15px;">Harcama Ekle</button>
      </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Tahsilatlar</h3>
        <table id="collectionsTable" class="report-table"> 
            <thead><tr>
                <th class="sortable" onclick="sortTable('collectionsTable', 0, 'date')">Tarih</th>
                <th class="sortable" onclick="sortTable('collectionsTable', 1, 'string')">Tip</th>
                <th>Açıklama / Detay</th>
                <th class="sortable" onclick="sortTable('collectionsTable', 3, 'date')">Vade Tarihi</th> 
                <th style="text-align:right;">Orijinal Tutar</th><th>P.B.</th>
                <th class="sortable" onclick="sortTable('collectionsTable', 6, 'number')" style="text-align:right;">Tutar/Değer (TL)</th>
                <th>İşlem</th>
            </tr></thead>
            <tbody></tbody>
        </table>
        <p id="noCollectionsMessage" style="text-align:center; margin-top:10px; display:none;">Henüz tahsilat eklenmemiş.</p>
        <div style="margin-top: 20px; padding:15px; border:1px solid #ddd; border-radius:8px;">
            <h4>Yeni Tahsilat Ekle</h4>
            <div class="input-group">
                <div><label for="collectionDate">Tahsilat Tarihi:</label><input type="date" id="collectionDate" onchange="fetchRatesAndUpdateCalculations('collectionRates', this.value)"/></div>
                <div><label for="collectionType">Tip:</label><select id="collectionType" onchange="toggleCollectionDetails()"><option value="Nakit">Nakit</option><option value="Banka Transferi">Banka Transferi</option><option value="Çek">Çek</option><option value="Barter">Barter</option></select></div>
            </div>
            <div id="collectionRates" class="exchange-rate-display" style="display:none;">
                <span>USD: <span id="collectionUsdRate">Yükleniyor...</span> TL</span>
                <span>EUR: <span id="collectionEurRate">Yükleniyor...</span> TL</span>
            </div>
            <div id="collectionAmountGroup" style="display:block;"> 
                <label for="collectionAmount">Tutar:</label>
                <div class="currency-select-group">
                    <input type="text" id="collectionAmount" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event, 'collectionAmount')"/>
                    <select id="collectionCurrency">
                        <option value="TRY" selected>TRY</option><option value="USD">USD</option><option value="EUR">EUR</option>
                    </select>
                </div>
            </div>
            <div id="checkDetailsGroup" class="collection-details-fields"><h5>Çek Detayları</h5><label for="checkDueDate">Vade Tarihi:</label><input type="date" id="checkDueDate" /><label for="checkNumber">Çek No:</label><input type="text" id="checkNumber" placeholder="Çek Numarası" /><label for="checkBank">Banka:</label><input type="text" id="checkBank" placeholder="Banka Adı" /></div>
            <div id="barterDetailsGroup" class="collection-details-fields"><h5>Barter Detayları</h5><label for="barterAsset">Takas Edilen Varlık:</label><input type="text" id="barterAsset" placeholder="Örn: Daire - A Blok No:5, Ford Transit" /><label for="barterValue">Belirlenen Değer (TL):</label><input type="text" id="barterValue" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event, 'barterValue')"/></div>
            <div><label for="collectionDescription">Açıklama/Not:</label><textarea id="collectionDescription" rows="3" placeholder="Tahsilatla ilgili ek notlar..."></textarea></div>
            <button onclick="addCollection()" style="margin-top:15px;">Tahsilat Ekle</button>
        </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Proje Dosyaları</h3>
        <div class="input-group file-upload-input-group">
            <div style="flex-basis: 40%;"><label for="fileUploadInput">Dosya Seç</label><input type="file" id="fileUploadInput" /></div>
            <div style="flex-basis: 40%;"><label for="fileDescriptionInput">Dosya Açıklaması (Opsiyonel)</label><input type="text" id="fileDescriptionInput" placeholder="Örn: Sözleşme V1, Teklif Onay Yazısı" /></div>
            <div style="flex-basis: 15%; min-width: 100px;"><button onclick="uploadFile()" style="width:100%;">Yükle</button></div>
        </div>
        <div id="uploadProgress"><div id="uploadProgressBar"></div></div>
        <h4 style="margin-top: 20px;">Yüklenmiş Dosyalar:</h4>
        <ul id="fileList" class="file-list"></ul>
        <p id="noProjectFilesMessage" style="display:none;">Bu projeye henüz dosya yüklenmemiş.</p>
    </section>

    <div style="margin-top: 30px; padding-bottom: 30px;">
        <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
        <button onclick="generateExcelReport()" style="margin-left:10px; background:#27ae60;">Rapor İndir (Excel)</button>
        <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
    </div>
  </main>

  <script>
    // Firebase yapılandırması
    const firebaseConfig = {
      apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
      authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
      projectId: "projetakipsistemi-fbabd",
      storageBucket: "projetakipsistemi-fbabd.appspot.com",
      messagingSenderId: "335282912485",
      appId: "1:335282912485:web:5ad9091ccf3cabd8f8280c"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    // Functions servisini, Cloud Function'ınızın deploy edildiği BÖLGEYİ belirterek initialize edin.
    // Örnek: 'europe-west1'. Firebase Console > Functions bölümünden kontrol edin.
    const functions = firebase.app().functions('europe-west1'); 

    let projectId = null;
    const predefinedStageNames = ["Keşif / Ön görüşme", "Teklif oluşturma", "Onay – sözleşme", "Malzeme temini", "Uygulama", "Test ve devreye alma", "Teslimat"];
    const defaultProjectStatus = "Başlamadı";
    const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];
    let fetchedRatesCache = {}; 

    // PARA FORMATLAMA FONKSİYONLARI
    function formatCurrencyTR(val){let n=typeof val==='string'?parseFloat(val.replace(/\./g,'').replace(',','.')):val;return isNaN(n)?"0,00":n.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});}
    function parseCurrencyTR(val){if(typeof val!=='string'||!val.trim())return 0;const cl=val.replace(/\./g,'').replace(',','.');const n=parseFloat(cl);return isNaN(n)?0:n;}
    function handleCurrencyInput(e){const i=e.target;let v=i.value;let nv=v.replace(/[^0-9,]/g,'');const p=nv.split(',');if(p.length>2){nv=p[0]+','+p.slice(1).join('');}i.value=nv;}
    
    async function formatCurrencyOnBlur(event, fieldName) { 
        const inputElement = event.target;
        const numericValue = parseCurrencyTR(inputElement.value);
        inputElement.value = formatCurrencyTR(numericValue);
        
        if (fieldName === 'contractValue') {
            const contractDateInput = document.getElementById('startDate'); 
            const dateForRate = contractDateInput.value || new Date().toISOString().split('T')[0];
            // _originalDate, Firestore'dan yüklenen veya saveDetails'te ayarlanan kur referans tarihini tutar.
            // Eğer kullanıcı input'u değiştiriyorsa, o anki sözleşme başlangıç tarihini baz alalım.
            document.getElementById('contractValue')._originalDate = dateForRate; 
            await fetchRatesAndUpdateCalculations('contractRates', dateForRate, true);
        } else {
            // Diğer para inputları (harcama, tahsilat tutarı vb.) için sadece genel hesaplamayı güncelle
            await updateCalculations(); 
        }
    }

    // KATEGORİ CHECKBOX FONKSİYONLARI
    function renderDetailCategoryCheckboxes(){const c=document.getElementById('projectCategoriesCheckboxesContainer');if(!c)return;let lg=c.querySelector('legend');if(!lg){lg=document.createElement('legend');lg.textContent='Proje Kategorileri';}c.innerHTML="";c.appendChild(lg);projectCategories.forEach(cat=>{const id=`detail_${cat.replace(/\s+/g,'-').toLowerCase()}`;const wr=document.createElement('span');wr.style.marginRight="15px";wr.style.display="inline-block";const cb=document.createElement('input');cb.type='checkbox';cb.id=id;cb.value=cat;cb.name='project_category_detail';cb.style.marginRight="5px";cb.style.verticalAlign="middle";cb.onchange=updateProjectCategories;const lb=document.createElement('label');lb.htmlFor=id;lb.textContent=cat;lb.style.fontWeight="normal";lb.style.cursor="pointer";lb.style.verticalAlign="middle";wr.appendChild(cb);wr.appendChild(lb);c.appendChild(wr);});}
    async function updateProjectCategories(){if(!projectId)return;const sel=[];document.querySelectorAll('#projectCategoriesCheckboxesContainer input[type="checkbox"]:checked').forEach(cb=>sel.push(cb.value));try{await db.collection("projects").doc(projectId).update({categories:sel});console.log("Kategoriler güncellendi:",sel);}catch(e){console.error("Kategori güncelleme hatası:",e);alert("Kategoriler güncellenemedi.");}}
    
    // OTURUM VE PROJE YÜKLEME
    auth.onAuthStateChanged(u=>{if(!u){window.location.href="login.html";}else{const p=new URLSearchParams(window.location.search);projectId=p.get("id");if(projectId){loadProject();}else{alert("Proje ID yok.");goBack();}}});
    
    async function getOrFetchRates(dateString) {
        if (!dateString) { console.warn("Kur çekmek için tarih belirtilmedi."); return null; }
        if (fetchedRatesCache[dateString]) { console.log("Kur önbellekten alındı:", dateString, fetchedRatesCache[dateString]); return fetchedRatesCache[dateString]; }
        try {
            const getRatesFunction = functions.httpsCallable('getExchangeRateForDate'); // Bölge belirtmeden çağır, initialize ederken belirtildi
            console.log(`Firebase Function çağrılıyor: getExchangeRateForDate, tarih: ${dateString}`);
            const result = await getRatesFunction({ date: dateString });
            if (result.data && result.data.success) {
                fetchedRatesCache[dateString] = result.data.rates; 
                console.log(`Firebase Function'dan kur çekildi (${result.data.source} - ${dateString}):`, result.data.rates);
                return result.data.rates;
            } else {
                console.error("Kur bilgisi alınamadı (fonksiyon başarısız):", result.data?.message || "Bilinmeyen fonksiyon hatası", result.data);
                fetchedRatesCache[dateString] = null; 
                return null;
            }
        } catch (error) {
            console.error(`Firebase Function (${dateString}) çağrılırken istemci tarafı hata:`, error); // error.message yerine error'un tamamını logla
            fetchedRatesCache[dateString] = null;
            return null;
        }
    }

    async function fetchRatesAndUpdateCalculations(displayDivId, dateString, isContract = false) {
        const displayDiv = document.getElementById(displayDivId);
        if (!displayDiv) { console.warn("Kur gösterim alanı bulunamadı:", displayDivId); return;}
        
        let usdSpan, eurSpan; 
        if (isContract) {
            usdSpan = document.getElementById('contractValueTRYRate'); 
            eurSpan = null; 
            if(!usdSpan) { console.warn("Sözleşme TL karşılığı span'ı bulunamadı."); return; }
        } else {
            usdSpan = document.getElementById(`${displayDivId.replace('Rates','')}UsdRate`);
            eurSpan = document.getElementById(`${displayDivId.replace('Rates','')}EurRate`);
            if(!usdSpan || !eurSpan) { console.warn("USD/EUR kur span'ları bulunamadı:", displayDivId); return; }
        }

        // displayDiv'in başlangıçta görünür olmasını sağla (içerik yüklenirken)
        displayDiv.style.display = 'flex';
        usdSpan.textContent = isContract ? 'Hesaplanıyor...' : 'Yükleniyor...';
        if (eurSpan) eurSpan.textContent = 'Yükleniyor...';
        
        if (!dateString) {
            usdSpan.textContent = isContract ? "" : 'N/A';
            if (eurSpan) eurSpan.textContent = 'N/A';
            if (!isContract || (isContract && document.getElementById('contractCurrency').value === 'TRY') ) {
                 displayDiv.style.display = 'none'; 
            }
            await updateCalculations(); 
            return;
        }
        
        const rates = await getOrFetchRates(dateString);

        if (rates) {
            if (isContract) {
                const contractValOriginal = parseCurrencyTR(document.getElementById('contractValue').value);
                const contractCurr = document.getElementById('contractCurrency').value;
                if (contractCurr === 'USD' && rates.USD) { usdSpan.textContent = formatCurrencyTR(contractValOriginal * rates.USD) + " TL"; }
                else if (contractCurr === 'EUR' && rates.EUR) { usdSpan.textContent = formatCurrencyTR(contractValOriginal * rates.EUR) + " TL"; }
                else if (contractCurr === 'TRY') { displayDiv.style.display = 'none'; } // TRY ise TL karşılığını gösterme
                else { usdSpan.textContent = 'Kur yok'; displayDiv.style.display = 'block';} // Kur yoksa ama döviz ise mesajı göster
            } else {
                usdSpan.textContent = rates.USD ? rates.USD.toFixed(4) : 'N/A';
                if (eurSpan) eurSpan.textContent = rates.EUR ? rates.EUR.toFixed(4) : 'N/A';
            }
        } else {
            usdSpan.textContent = 'Hata'; if (eurSpan) eurRateSpan.textContent = 'Hata';
            // if (isContract) displayDiv.style.display = 'none'; // Hata durumunda da göster, "Hata" yazsın
            if (!isContract && dateString) alert(`${dateString} için kur bilgisi alınamadı.`); // Sadece harcama/tahsilat için uyar
        }
        await updateCalculations(); 
    }

    async function loadProject(){if(!projectId)return;try{renderDetailCategoryCheckboxes();const ref=db.collection("projects").doc(projectId);const doc=await ref.get();if(!doc.exists){alert("Proje bulunamadı.");goBack();return;}const p=doc.data();document.getElementById("projectName").value=p.name||"";document.getElementById("clientName").value=p.client||"";document.getElementById("startDate").value=p.startDate||"";document.getElementById("endDate").value=p.endDate||"";
    document.getElementById("contractValue").value = formatCurrencyTR(p.originalContractAmount !== undefined ? p.originalContractAmount : (p.contractValue || 0) );
    document.getElementById("contractCurrency").value = p.contractCurrency || "TRY";
    document.getElementById("contractValue")._originalDate = p.contractDateForRate || p.startDate || new Date().toISOString().split('T')[0]; 
    document.getElementById("projectStatus").value=p.status||defaultProjectStatus;if(p.categories&&Array.isArray(p.categories)){p.categories.forEach(cat=>{const id=`detail_${cat.replace(/\s+/g,'-').toLowerCase()}`;const cb=document.getElementById(id);if(cb)cb.checked=true;});}
    let stages=p.stages||[];let updStg=false;if(!p.stages||p.stages.length===0){stages=predefinedStageNames.map(n=>({name:n,responsible:"",date:"",notes:"",completed:false}));updStg=true;}else if(stages.length!==predefinedStageNames.length||stages.some((s,i)=>s.name!==predefinedStageNames[i])){const newStg=predefinedStageNames.map(n=>{const es=stages.find(s1=>s1.name===n);return{name:n,responsible:es?.responsible||"",date:es?.date||"",notes:es?.notes||"",completed:es?.completed||false};});stages=newStg;updStg=true;}if(updStg&&stages.length>0){await ref.update({stages:stages});}
    renderStages(stages);renderExpenses(p.expenses||[]);renderCollections(p.collections||[]);renderFiles(p.files||[]);
    toggleCollectionDetails(); 
    if (document.getElementById("contractCurrency").value !== "TRY") { await fetchRatesAndUpdateCalculations('contractRates', document.getElementById("contractValue")._originalDate, true); } else { const cr = document.getElementById('contractRates'); if(cr) cr.style.display = 'none';}
    await updateCalculations();
    }catch(e){console.error("Proje yükleme hatası:",e);alert("Detaylar yüklenemedi.");}}
    
    function renderStages(data){const tb=document.querySelector("#stagesTable tbody");tb.innerHTML="";predefinedStageNames.forEach((sName,i)=>{let s=data.find(st=>st.name===sName)||( {name:sName,responsible:"",date:"",notes:"",completed:false});tb.insertAdjacentHTML("beforeend",`<tr><td>${s.name}</td><td><input type="text" value="${s.responsible||''}" data-idx="${i}" data-field="responsible" class="stage-input"></td><td><input type="date" value="${s.date||''}" data-idx="${i}" data-field="date" class="stage-input"></td><td><textarea class="stage-notes-input stage-input" data-idx="${i}" data-field="notes">${s.notes||''}</textarea></td><td><input type="checkbox" ${s.completed?"checked":""} data-idx="${i}" data-field="completed" class="stage-input"></td></tr>`);});
    tb.querySelectorAll(".stage-input").forEach(inp=>{const idx=parseInt(inp.dataset.idx),fld=inp.dataset.field;inp.addEventListener((fld==="completed"?"change":(inp.tagName==='TEXTAREA'?"blur":"blur")),e=>saveStageField(idx,fld,(fld==="completed"?e.target.checked:e.target.value)));});}
    
    async function saveStageField(idx,fld,val){if(!projectId)return;try{const ref=db.collection("projects").doc(projectId);const doc=await ref.get();if(!doc.exists)return;let stg=doc.data().stages||[];if(!stg.length||stg.length!==predefinedStageNames.length||stg.some((s,i)=>s.name!==predefinedStageNames[i])){stg=predefinedStageNames.map(n=>{const es=stg.find(s1=>s1.name===n);return{name:n,responsible:es?.responsible||"",date:es?.date||"",notes:es?.notes||"",completed:es?.completed||false};});}
    if(stg[idx]){stg[idx][fld]=val;await ref.update({stages:stg});}}catch(e){console.error(`Aşama ${fld} güncelleme hatası:`,e);}}
    
    async function updateProjectStatus(newSt){if(!projectId)return;try{await db.collection("projects").doc(projectId).update({status:newSt});console.log("Durum güncellendi:",newSt);}catch(e){console.error("Durum güncelleme hatası:",e);alert("Durum güncellenemedi.");}}
    
    function renderExpenses(list){const tb=document.querySelector("#expensesTable tbody");tb.innerHTML="";(list||[]).forEach((it,idx)=>{const originalAmountStr=it.originalAmount!==undefined?formatCurrencyTR(it.originalAmount):formatCurrencyTR(it.amountInTRY||it.amount||0);const currencyStr=it.currency||"TRY";const amountTRYStr=formatCurrencyTR(it.amountInTRY||it.amount||0);tb.insertAdjacentHTML("beforeend",`<tr><td>${it.desc}</td><td style="text-align:right;">${originalAmountStr}</td><td>${currencyStr}</td><td style="text-align:right;">${amountTRYStr}</td><td><button onclick="removeExpense(${idx})" class="delete-file-btn">Sil</button></td></tr>`);});}
    
    async function addExpense(){const desc=document.getElementById("expenseDesc").value.trim();const amountInput=document.getElementById("expenseAmount");const originalAmount=parseCurrencyTR(amountInput.value);const currency=document.getElementById("expenseCurrency").value;const expenseDate=document.getElementById("expenseDate").value||new Date().toISOString().split('T')[0];if(!desc||isNaN(originalAmount)||originalAmount<=0){alert("Geçerli açıklama ve tutar girin.");return;}if(!expenseDate){alert("Lütfen harcama tarihini seçin.");return;}
    let amountInTRY=originalAmount;if(currency!=="TRY"){const rates=await getOrFetchRates(expenseDate);if(!rates||!rates[currency]){if(!confirm(`${expenseDate} için ${currency} kuru bulunamadı. Harcamayı ${formatCurrencyTR(originalAmount)} TL olarak mı kaydetmek istersiniz?`)){return;}}else{amountInTRY=originalAmount*rates[currency];}}
    const newExpense={desc,originalAmount,currency,amountInTRY,date:expenseDate,addedAt:firebase.firestore.Timestamp.now()};try{const ref=db.collection("projects").doc(projectId);await ref.update({expenses:firebase.firestore.FieldValue.arrayUnion(newExpense)});document.getElementById("expenseDesc").value="";amountInput.value=formatCurrencyTR(0);document.getElementById("expenseCurrency").value="TRY";document.getElementById("expenseDate").value="";document.getElementById("expenseRates").style.display='none';const ud=await ref.get();if(ud.exists){renderExpenses(ud.data().expenses||[]);await updateCalculations();}}catch(e){console.error("Harcama ekleme hatası:",e);alert("Harcama eklenemedi.");}}
    
    async function removeExpense(idx){if(!confirm("Bu harcama silinsin mi?"))return;try{const ref=db.collection("projects").doc(projectId);const d=await ref.get();if(!d.exists)return;let ex=d.data().expenses||[];ex.splice(idx,1);await ref.update({expenses:ex});renderExpenses(ex);await updateCalculations();}catch(e){console.error("Harcama silme hatası:",e);alert("Harcama silinemedi.");}}
    
    function renderCollections(arr){const tb=document.querySelector("#collectionsTable tbody");const msg=document.getElementById("noCollectionsMessage");tb.innerHTML="";if(arr&&arr.length>0){msg.style.display="none";arr.forEach((col,idx)=>{let originalAmountDisp,currencyDisp,amountTRYDisp;if(col.type==="Barter"&&col.barterDetails){originalAmountDisp=formatCurrencyTR(col.barterDetails.value||0);currencyDisp=col.barterDetails.currency||"TRY";amountTRYDisp=formatCurrencyTR(col.barterDetails.valueInTRY||col.barterDetails.value||0);}else{originalAmountDisp=formatCurrencyTR(col.originalAmount||col.amount||0);currencyDisp=col.currency||"TRY";amountTRYDisp=formatCurrencyTR(col.amountInTRY||col.amount||0);}
    let descDisp=col.description||'';let dueDateDisp='-';if(col.type==="Çek"&&col.checkDetails){descDisp+=`${descDisp?' <br> ':''}Çek No: ${col.checkDetails.checkNo||'N/A'}, Banka: ${col.checkDetails.bank||'N/A'}`;dueDateDisp=col.checkDetails.dueDate||'N/A';}else if(col.type==="Barter"&&col.barterDetails){descDisp+=`${descDisp?' - ':''}Takas: ${col.barterDetails.asset||'Belirtilmemiş'}`;}
    tb.insertAdjacentHTML("beforeend",`<tr><td>${col.date||'N/A'}</td><td>${col.type||'N/A'}</td><td>${descDisp}</td><td>${dueDateDisp}</td><td style="text-align:right;">${originalAmountDisp}</td><td>${currencyDisp}</td><td style="text-align:right;">${amountTRYDisp}</td><td><button class="delete-file-btn" style="padding:5px 8px;" onclick="removeCollection(${idx})">Sil</button></td></tr>`);});}else{msg.style.display="block";}updateCalculations();}
    
    function toggleCollectionDetails(){const t=document.getElementById('collectionType').value;document.getElementById('checkDetailsGroup').style.display=t==='Çek'?'block':'none';document.getElementById('barterDetailsGroup').style.display=t==='Barter'?'block':'none';const collectionAmountDiv = document.getElementById('collectionAmountGroup'); const collectionCurrencySelect = document.getElementById('collectionCurrency'); if (collectionAmountDiv) collectionAmountDiv.style.display=t==='Barter'?'none':'block'; if(t!=='Barter'){ if(collectionCurrencySelect) collectionCurrencySelect.value = 'TRY'; fetchRatesAndUpdateCalculations('collectionRates', document.getElementById('collectionDate').value); } else { const cr = document.getElementById('collectionRates'); if(cr) cr.style.display='none';}}
    
    async function addCollection(){const dateInput=document.getElementById('collectionDate').value;const type=document.getElementById('collectionType').value;const description=document.getElementById('collectionDescription').value.trim();let originalAmount=0,currency="",amountInTRY=0,checkDetails=null,barterDetails=null;if(!dateInput||!type){alert("Tarih ve tip seçin.");return;}
    if(type==="Nakit"||type==="Banka Transferi"||type==="Çek"){originalAmount=parseCurrencyTR(document.getElementById('collectionAmount').value);currency=document.getElementById('collectionCurrency').value;if(isNaN(originalAmount)||originalAmount<=0){alert("Geçerli tutar.");return;}amountInTRY=originalAmount;if(currency!=="TRY"){const rates=await getOrFetchRates(dateInput);if(!rates||!rates[currency]){if(!confirm(`${dateInput} için ${currency} kuru bulunamadı. Tahsilatı ${formatCurrencyTR(originalAmount)} TL olarak mı kaydetmek istersiniz?`))return;}else{amountInTRY=originalAmount*rates[currency];}}
    if(type==="Çek"){const dueDate=document.getElementById('checkDueDate').value;const checkNo=document.getElementById('checkNumber').value.trim();const bank=document.getElementById('checkBank').value.trim();if(!dueDate||!checkNo||!bank){alert("Çek detayları.");return;}checkDetails={dueDate,checkNo,bank};}}else if(type==="Barter"){const asset=document.getElementById('barterAsset').value.trim();const value=parseCurrencyTR(document.getElementById('barterValue').value);if(!asset||isNaN(value)||value<=0){alert("Barter varlık ve değer.");return;}barterDetails={asset,value,currency:"TRY",valueInTRY:value};originalAmount=value;currency="TRY";amountInTRY=value;}
    const newCollection={date:dateInput,type,description,originalAmount,currency,amountInTRY,checkDetails,barterDetails,addedAt:firebase.firestore.Timestamp.now()};
    try{const projectRef=db.collection("projects").doc(projectId);await projectRef.update({collections:firebase.firestore.FieldValue.arrayUnion(newCollection)});
    ['collectionDate','collectionDescription','checkDueDate','checkNumber','checkBank','barterAsset'].forEach(id=>{const el=document.getElementById(id); if(el)el.value="";});
    document.getElementById('collectionType').value="Nakit";document.getElementById('collectionAmount').value=formatCurrencyTR(0);document.getElementById('collectionCurrency').value="TRY";document.getElementById('barterValue').value=formatCurrencyTR(0);
    toggleCollectionDetails();document.getElementById('collectionRates').style.display='none';
    const updatedDoc=await projectRef.get();if(updatedDoc.exists)renderCollections(updatedDoc.data().collections||[]);alert("Tahsilat eklendi.");}catch(error){console.error("Tahsilat eklenirken Firestore hatası:",error);alert(`Tahsilat eklenemedi. Hata: ${error.message}`);}}
    
    async function removeCollection(idx){if(!confirm("Bu tahsilat silinsin mi?"))return;try{const ref=db.collection("projects").doc(projectId);const d=await ref.get();if(!d.exists)return;let cols=d.data().collections||[];cols.splice(idx,1);await ref.update({collections:cols});renderCollections(cols);await updateCalculations();}catch(e){console.error("Tahsilat silme hatası:",e);alert("Tahsilat silinemedi.");}}
    
    async function updateCalculations() {
        if (!projectId) return; 
        let contractInTRY = 0;
        let totalExpensesInTRY = 0;
        let totalCollectionsInTRY = 0;

        try {
            const projectDoc = await db.collection("projects").doc(projectId).get();
            if (projectDoc.exists) {
                const p = projectDoc.data();
                contractInTRY = p.contractValue || 0; 
                (p.expenses || []).forEach(exp => { totalExpensesInTRY += (exp.amountInTRY || exp.amount || 0); }); // amountInTRY öncelikli
                (p.collections || []).forEach(col => { 
                    if (col.type === "Barter" && col.barterDetails) {
                        totalCollectionsInTRY += (col.barterDetails.valueInTRY || col.barterDetails.value || 0);
                    } else {
                        totalCollectionsInTRY += (col.amountInTRY || col.amount || 0); // amountInTRY öncelikli
                    }
                });
            }
        } catch (error) { console.error("Hesaplama için proje verileri çekilirken hata:", error); }
        
        const profit = contractInTRY - totalExpensesInTRY;
        const margin = contractInTRY > 0 ? (profit / contractInTRY) * 100 : 0;
        const remainingBalance = contractInTRY - totalCollectionsInTRY;

        document.getElementById("totalExpenses").value = formatCurrencyTR(totalExpensesInTRY);
        document.getElementById("realizedProfit").value = formatCurrencyTR(profit);
        document.getElementById("realizedProfitMargin").value = margin.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
        document.getElementById("totalCollections").value = formatCurrencyTR(totalCollectionsInTRY);
        document.getElementById("remainingBalance").value = formatCurrencyTR(remainingBalance);
    }

    async function saveDetails(){
        const originalAmount = parseCurrencyTR(document.getElementById("contractValue").value);
        const currency = document.getElementById("contractCurrency").value;
        const dateForRateEl = document.getElementById("startDate"); 
        const dateForRate = dateForRateEl.value || new Date().toISOString().split('T')[0]; 
        document.getElementById('contractValue')._originalDate = dateForRate; 
        
        let valueInTRY = originalAmount;
        if (currency !== "TRY") {
            const rates = await getOrFetchRates(dateForRate);
            if (rates && rates[currency]) {
                valueInTRY = originalAmount * rates[currency];
            } else {
                alert(`${currency} kuru (${dateForRate}) alınamadı. Sözleşme tutarının TL karşılığı güncellenemedi. Lütfen geçerli bir başlangıç tarihi seçin. Orijinal tutar ve para birimi kaydedilecek, TL karşılığı olarak son bilinen veya orijinal tutar yazılacaktır.`);
                const projectDoc = await db.collection("projects").doc(projectId).get(); 
                valueInTRY = projectDoc.exists ? (projectDoc.data().contractValue || originalAmount) : originalAmount; 
                if(!rates || !rates[currency]) {
                     alert(`Uyarı: ${currency} kuru alınamadığı için TL karşılığı güncellenmedi.`);
                }
            }
        }
        
        const dataToUpdate = {
            startDate: document.getElementById("startDate").value,
            endDate: document.getElementById("endDate").value,
            originalContractAmount: originalAmount,
            contractCurrency: currency,
            contractValue: valueInTRY, 
            contractDateForRate: dateForRate 
        };
        try {
            const ref = db.collection("projects").doc(projectId);
            await ref.update(dataToUpdate);
            alert("Sözleşme bilgileri kaydedildi.");
            if (currency !== "TRY") {
                await fetchRatesAndUpdateCalculations('contractRates', dateForRate, true); 
            } else {
                 const cr = document.getElementById('contractRates'); if(cr) cr.style.display = 'none';
            }
            await updateCalculations();
        } catch(e){ console.error("Detay kaydetme hatası:",e); alert("Bilgiler kaydedilemedi.");}
    }

    function renderFiles(files){const ul=document.getElementById("fileList");const msg=document.getElementById("noProjectFilesMessage"); if(!ul || !msg) { return; } ul.innerHTML="";if(files&&files.length>0){msg.style.display="none";files.forEach((f,i)=>{ul.innerHTML+=`<li><div><a href="${f.url}" target="_blank" class="file-name" title="İndir: ${f.name}">${f.name}</a>${f.description ? `<span class="file-description">${f.description}</span>` : ''}</div><button class="delete-file-btn" onclick="deleteFile(${i},'${f.name}','${f.path}')">Sil</button></li>`;});}else{msg.style.display="block";}}
    async function uploadFile(){const fin=document.getElementById('fileUploadInput');const desInp=document.getElementById('fileDescriptionInput');const f=fin.files[0];const des=desInp.value.trim();const pBarC=document.getElementById('uploadProgress');const pBar=document.getElementById('uploadProgressBar');if(!f){alert("Dosya seçin.");return;}if(!projectId){alert("Proje ID yok.");return;}
    const fNameStore=`${Date.now()}_${f.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;const fPath=`projects/${projectId}/${fNameStore}`;const fRef=storage.ref(fPath);try{const task=fRef.put(f);pBarC.style.display='block';task.on('state_changed',(s)=>{const prog=(s.bytesTransferred/s.totalBytes)*100;pBar.style.width=prog+'%';pBar.textContent=Math.round(prog)+'%';},(err)=>{console.error("Yükleme hatası:",err);alert(`Yükleme hatası: ${err.code} - ${err.message}`);pBarC.style.display='none';},async ()=>{pBarC.style.display='none';pBar.style.width='0%';pBar.textContent='';const url=await task.snapshot.ref.getDownloadURL();const pRef=db.collection("projects").doc(projectId);await pRef.update({files:firebase.firestore.FieldValue.arrayUnion({name:f.name,url,path:fPath,description:des,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()})});alert("Dosya yüklendi!");fin.value="";desInp.value="";const pDoc=await pRef.get();if(pDoc.exists)renderFiles(pDoc.data().files||[]);});}catch(e){console.error("Yükleme başlatma hatası:",e);alert("Yükleme başlatılamadı.");pBarC.style.display='none';}}
    async function deleteFile(idx,name,path){if(!confirm(`"${name}" silinsin mi?`))return;if(!projectId||!path){alert("Silinemedi, bilgi eksik.");return;}try{await storage.ref(path).delete();const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(pDoc.exists){let files=pDoc.data().files||[];files=files.filter(f=>f.path!==path);await pRef.update({files});renderFiles(files);alert(`"${name}" silindi.`);}}catch(e){console.error("Dosya silme hatası:",e);if(e.code==='storage/object-not-found'){alert("Dosya Storage'da yok. DB kaydı siliniyor.");const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(pDoc.exists){let files=pDoc.data().files||[];files=files.filter(f=>f.path!==path);await pRef.update({files});renderFiles(files);}}else{alert(`Silme hatası: ${e.message}`);}}}
    async function generateExcelReport(){if(!projectId){alert("Proje bulunamadı.");return;}const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(!pDoc.exists){alert("Proje verisi yok.");return;}const p=pDoc.data();const wb=XLSX.utils.book_new();
    const generalInfoData=[["Proje Adı",p.name||'N/A'],["Müşteri Adı",p.client||'N/A'],["Proje Durumu",p.status||defaultProjectStatus],["Kategoriler",(p.categories||[]).join(", ")||'N/A'],["Sözleşme Başlangıcı",p.startDate||'N/A'],["Sözleşme Bitişi",p.endDate||'N/A'],["Sözleşme Tutarı (Orijinal)",p.originalContractAmount!==undefined?`${formatCurrencyTR(p.originalContractAmount)} ${p.contractCurrency}`:formatCurrencyTR(p.contractValue||0)+" TRY"],["Sözleşme Tutarı (TL)",formatCurrencyTR(p.contractValue||0)], ["Kur Tarihi", p.contractDateForRate || 'N/A']];const wsGeneral=XLSX.utils.aoa_to_sheet(generalInfoData);XLSX.utils.book_append_sheet(wb,wsGeneral,"Genel Bilgiler");
    const stagesHeaders=["Aşama Adı","Sorumlu Kişi","Tarih","Notlar","Durum"];const stagesBody=(p.stages||[]).map(s=>[s.name,s.responsible,s.date,s.notes||'',s.completed?"Tamamlandı":"Tamamlanmadı"]);const wsStages=XLSX.utils.aoa_to_sheet([stagesHeaders,...stagesBody]);XLSX.utils.book_append_sheet(wb,wsStages,"Aşamalar");
    const expensesHeaders=["Açıklama","Harcama Tarihi","Orijinal Tutar","P.B.","Tutar (TL)"];const expensesBody=(p.expenses||[]).map(e=>[e.desc,e.date||'N/A',e.originalAmount,e.currency,e.amountInTRY]);const wsExpenses=XLSX.utils.aoa_to_sheet([expensesHeaders,...expensesBody]);(expensesBody||[]).forEach((r,i)=>{const adrOrig=XLSX.utils.encode_cell({c:2,r:i+1});if(wsExpenses[adrOrig]){wsExpenses[adrOrig].t='n';wsExpenses[adrOrig].z='#,##0.00';} const adrTRY=XLSX.utils.encode_cell({c:4,r:i+1});if(wsExpenses[adrTRY]){wsExpenses[adrTRY].t='n';wsExpenses[adrTRY].z='#,##0.00 TL';}});XLSX.utils.book_append_sheet(wb,wsExpenses,"Harcamalar");
    const collectionsHeaders=["Tahsilat Tarihi","Tip","Açıklama / Detay","Vade Tarihi","Orijinal Tutar","P.B.","Tutar/Değer (TL)"];const collectionsBody=(p.collections||[]).map(c=>{let oAmt=c.type==="Barter"&&c.barterDetails?c.barterDetails.value:(c.originalAmount||c.amount||0);let curr=c.type==="Barter"&&c.barterDetails?(c.barterDetails.currency||"TRY"):(c.currency||"TRY");let amtTRY=c.amountInTRY||0;let desc=c.description||'';let dueDate='-';if(c.type==="Çek"&&c.checkDetails){desc+=`${desc?' <br> ':''}Çek No: ${c.checkDetails.checkNo||'N/A'}, Banka: ${col.checkDetails.bank||'N/A'}`;dueDate=c.checkDetails.dueDate||'-';}else if(c.type==="Barter"&&c.barterDetails){desc+=`${desc?' - ':''}Takas: ${c.barterDetails.asset||'Belirtilmemiş'}`;}return[c.date,c.type,desc,dueDate,oAmt,curr,amtTRY];});const wsCollections=XLSX.utils.aoa_to_sheet([collectionsHeaders,...collectionsBody]);(collectionsBody||[]).forEach((r,i)=>{const adrOrig=XLSX.utils.encode_cell({c:4,r:i+1});if(wsCollections[adrOrig]){wsCollections[adrOrig].t='n';wsCollections[adrOrig].z='#,##0.00';}const adrTRY=XLSX.utils.encode_cell({c:6,r:i+1});if(wsCollections[adrTRY]){wsCollections[adrTRY].t='n';wsCollections[adrTRY].z='#,##0.00 TL';}});XLSX.utils.book_append_sheet(wb,wsCollections,"Tahsilatlar");
    const contractInTRY=p.contractValue||0;const totalExpInTRY=(p.expenses||[]).reduce((s,e)=>s+(e.amountInTRY||0),0);const totalCollInTRY=(p.collections||[]).reduce((s,c)=>s+((c.amountInTRY || (c.type==="Barter"&&c.barterDetails ? c.barterDetails.valueInTRY : c.amount))||0),0);const realProfit=contractInTRY-totalExpInTRY;const profitMargin=contractInTRY>0?(realProfit/contractInTRY)*100:0;const remainBal=contractInTRY-totalCollInTRY;
    const financialData=[["Sözleşme Tutarı (TL)",contractInTRY],["Toplam Harcama (TL)",totalExpInTRY],["Gerçekleşen Kar (TL)",realProfit],["Kar Marjı (%)",profitMargin],["Toplam Tahsil Edilen (TL)",totalCollInTRY],["Kalan Bakiye (TL)",remainBal]];const wsFinancial=XLSX.utils.aoa_to_sheet(financialData);financialData.forEach((r,i)=>{const adr=XLSX.utils.encode_cell({c:1,r:i});if(wsFinancial[adr]){wsFinancial[adr].t='n';wsFinancial[adr].z=i===3?'0.00%':'#,##0.00 TL';if(i===3)wsFinancial[adr].v=profitMargin/100;}});XLSX.utils.book_append_sheet(wb,wsFinancial,"Finansal Özet");
    if(p.files&&p.files.length>0){const filesHeaders=["Dosya Adı","Açıklama","Yüklenme Tarihi","URL"];const filesBody=(p.files||[]).map(f=>[f.name,f.description||'',f.uploadedAt?.toDate?f.uploadedAt.toDate().toLocaleDateString('tr-TR'):'N/A',f.url]);const wsFiles=XLSX.utils.aoa_to_sheet([filesHeaders,...filesBody]);XLSX.utils.book_append_sheet(wb,wsFiles,"Proje Dosyaları");}
    const fileName=`${p.name?p.name.replace(/[^a-zA-Z0-9]/g,'_'):'proje'}_rapor.xlsx`;XLSX.writeFile(wb,fileName);alert("Excel raporu oluşturuldu ve indiriliyor.");}
    let sortDirections={};function sortTable(tableId,columnIndex,dataType='string'){const table=document.getElementById(tableId);if(!table||!table.tBodies[0]||table.tBodies[0].rows.length===0){return;}const tbody=table.tBodies[0];const rows=Array.from(tbody.rows);const headerCells=table.tHead.rows[0].cells;const headerCell=headerCells[columnIndex];const currentSortKey=`${tableId}-${columnIndex}`;let newDirection='asc';if(sortDirections[currentSortKey]==='asc'){newDirection='desc';}
    for(let i=0;i<headerCells.length;i++){headerCells[i].classList.remove('sort-asc','sort-desc');}sortDirections={};sortDirections[currentSortKey]=newDirection;headerCell.classList.add(newDirection==='asc'?'sort-asc':'sort-desc');
    rows.sort((rowA,rowB)=>{let valA=rowA.cells[columnIndex].textContent.trim();let valB=rowB.cells[columnIndex].textContent.trim();if(dataType==='number'){const cleanA=valA.replace(/[^\d,-]/g,'').replace(',','.');const cleanB=valB.replace(/[^\d,-]/g,'').replace(',','.');valA=parseFloat(cleanA)||0;valB=parseFloat(cleanB)||0;}else if(dataType==='date'){const parseDate=(dateStr)=>{if(!dateStr||dateStr.toLowerCase()==="n/a"||dateStr.trim()==="-")return 0;let parts=dateStr.split('-');if(parts.length===3&&parts[0].length===4)return new Date(parts[0],parts[1]-1,parts[2]).getTime();parts=dateStr.split('.');if(parts.length===3&&parts[2].length===4)return new Date(parts[2],parts[1]-1,parts[0]).getTime();const parsed=new Date(dateStr).getTime();return isNaN(parsed)?(newDirection==='asc'?Infinity:-Infinity):parsed;};valA=parseDate(valA);valB=parseDate(valB);}else{valA=valA.toLowerCase();valB=valB.toLowerCase();}
    if(valA<valB)return newDirection==='asc'?-1:1;if(valA>valB)return newDirection==='asc'?1:-1;return 0;});rows.forEach(row=>tbody.appendChild(row));}
    function goBack(){window.location.href="index.html";}
    function logout(){auth.signOut().then(()=>window.location.href="login.html").catch(e=>{console.error("Çıkış hatası:",e);alert("Çıkış hatası.");});}
  </script>
</body>
</html>
