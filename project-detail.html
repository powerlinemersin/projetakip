<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Detayları</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f9fbfd; color: #2c3e50;
    }
    header {
      background-color: #34495e; color: white; padding: 15px 20px; display: flex;
      align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header-content-left { flex: 1; }
    .logo-title-container {
      display: flex; flex-direction: column; align-items: center; text-align: center;
      flex: 2; 
    }
    header img { height: 40px; width: auto; margin-bottom: 5px; }
    header h1 { font-weight: 600; font-size: 1.6rem; margin: 0; }
    .header-content-right { flex: 1; display: flex; justify-content: flex-end; }
    .header-content-right button { margin-top: 0; }
    
    main { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
    h3 {
        color: #34495e; margin-top: 30px; margin-bottom: 15px;
        border-bottom: 2px solid #2980b9; padding-bottom: 8px;
    }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input, button, select, textarea {
      padding: 10px 12px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;
      outline: none; transition: border-color 0.3s ease; width: 100%; box-sizing: border-box;
    }
    input:not([type="checkbox"]), select, textarea { width: 100%;}
    input[type="checkbox"] { width: auto; }
    input:focus, select:focus, textarea:focus {
      border-color: #2980b9; box-shadow: 0 0 5px #2980b9;
    }
    button {
      background-color: #2980b9; border: none; color: white; cursor: pointer; font-weight: 600;
      transition: background-color 0.3s ease; margin-top: 10px; border-radius: 6px;
      width: auto; padding: 10px 20px;
    }
    button:hover { background-color: #1c5980; }
    table {
      width: 100%; border-collapse: collapse; background: white; margin-top: 25px;
      border: 1px solid #ddd; border-radius: 8px; overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { padding: 14px 18px; border-bottom: 1px solid #e3e6ea; text-align: left; }
    thead { background-color: #2980b9; color: white; font-weight: 600; }
    tr:hover { background-color: #ecf6fc; }
    .input-group { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
    .input-group > div { flex: 1; min-width: 150px; }
    .input-group button {margin-top:0;}
    .readonly { background-color: #f0f0f0; cursor: not-allowed; }
    input[type="text"].currency-input { text-align: right; }
    .category-checkbox-group {
        margin-top: 15px; margin-bottom: 20px; padding: 10px; border: 1px solid #eee;
        border-radius: 6px; background-color: #fdfdfd;
    }
    .category-checkbox-group legend {
        font-weight: 600; padding: 0 5px; margin-left: 5px; color: #34495e;
    }
    .category-checkbox-group label {
        display: inline-block; margin-right: 15px; font-weight: normal; cursor: pointer;
        margin-top: 0; margin-bottom: 5px;
    }
    .category-checkbox-group input[type="checkbox"] {
        margin-right: 5px; vertical-align: middle;
    }
    .stage-notes-input {
        width: 100%; min-height: 40px; padding: 6px; font-size: 0.9em;
        border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; resize: vertical;
    }
    .file-list { list-style-type: none; padding: 0; }
    .file-list li {
        background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px;
        margin-bottom: 5px; border-radius: 4px; display: flex;
        justify-content: space-between; align-items: center;
    }
    .file-list a { color: #007bff; text-decoration: none; }
    .file-list a:hover { text-decoration: underline; }
    .delete-file-btn {
        background-color: #dc3545; color: white; border: none; padding: 5px 8px;
        border-radius: 4px; cursor: pointer; font-size: 0.8em;
    }
    .delete-file-btn:hover { background-color: #c82333; }
    #uploadProgress {
        width: 100%; background-color: #e9ecef; border-radius: .25rem;
        margin-top: 5px; height: 10px; display: none;
    }
    #uploadProgressBar {
        width: 0%; height: 100%; background-color: #28a745; border-radius: .25rem;
        text-align: center; line-height: 10px; color: white; font-size: 0.7em;
    }
    .collection-details-fields {
        display: none; padding-left: 15px; border-left: 2px solid #eee;
        margin-left: 5px; margin-top: 10px;
    }
    #collectionsTable td, #collectionsTable th { font-size: 0.9em; }
    .report-table th.sortable { cursor: pointer; }
    .report-table th.sortable:hover { background-color: #e9ecef; }
    .report-table th.sortable::after { content: ' \00A0\2195'; font-size: 0.8em; opacity: 0.5; }
    .report-table th.sort-asc::after { content: ' \00A0\2191'; opacity: 1;}
    .report-table th.sort-desc::after { content: ' \00A0\2193'; opacity: 1;}

    .exchange-rate-display {
        margin-top: 10px; padding: 8px 12px; background-color: #e6f7ff; border: 1px solid #b3e0ff; border-radius: 5px;
        font-size: 0.9em; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
    }
    .exchange-rate-display span {
        font-weight: 600; color: #2196f3;
    }
    .exchange-rate-display .error {
        color: red; font-weight: normal;
    }

    @media print { /* Yazdırma Stilleri */
      body { font-family: Arial, sans-serif; margin: 20mm; font-size: 10pt; }
      header, main > div:last-child > button, 
      main > section:nth-of-type(3) > .input-group > div:last-child > button, 
      main > section:nth-of-type(5) > .input-group > div:last-child > button, 
      #uploadProgress, .delete-file-btn, 
      #expensesTable button, #collectionsTable button,
      .stage-input[type="checkbox"] + label, .category-checkbox-group input[type="checkbox"],
      .category-checkbox-group label[for^="detail_"],
      .exchange-rate-display /* Kur gösterimini yazdırmada gizle */
       { display: none !important; }
      h3 { border-bottom: 1px solid #ccc; margin-top: 15px; margin-bottom: 10px; font-size: 14pt;}
      table { margin-top: 10px; font-size: 9pt; width: 100% !important; border: 1px solid #ccc !important; page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      th, td { padding: 4px 6px !important; border: 1px solid #eee !important; word-wrap: break-word; }
      thead { background-color: #f0f0f0 !important; color: #333 !important; display: table-header-group; }
      a { text-decoration: none; color: black; }
      a[href]::after { content: " (" attr(href) ")"; font-size: 0.8em; color: #555; }
      input[type="text"], input[type="date"], select, textarea.stage-notes-input {
        border: none !important; box-shadow: none !important; padding: 0 !important;
        background-color: transparent !important; font: inherit !important; color: inherit !important;
        -webkit-appearance: none; -moz-appearance: none; appearance: none; width: auto !important;
      }
      input.readonly { color: #333; font-weight: normal; }
      .stage-input[type="checkbox"]::after { content: attr(checked) ? "Evet" : "Hayır"; }
      #projectCategoriesCheckboxesContainer legend { font-weight: bold; margin-bottom: 3px; }
      #projectCategoriesCheckboxesContainer { border: none; padding: 0; margin-bottom: 10px; }
      .file-list li { background-color: transparent; border: none; padding: 2px 0; margin-bottom: 2px; }
      main > section:nth-of-type(4) > div[style*="border:1px solid #ddd"] { display: none !important; } 
    }
    @media (max-width: 768px) {
      header { flex-direction: column; padding: 15px; }
      .logo-title-container { order: 1; margin-bottom: 10px; }
      .header-content-left { display: none; }
      .header-content-right { order: 2; width: 100%; justify-content: center; }
      .header-content-right button { width: auto; }

      .input-group { flex-direction: column; align-items: stretch; }
      .input-group input, .input-group > div > button, .input-group select, .input-group textarea { width: 100%; margin-left: 0; }
      .input-group > div > button { margin-top: 10px; } 
      .file-upload-input-group > div:last-child > button { margin-top: 10px; }
      .category-checkbox-group label { margin-bottom: 8px; }
      #stagesTable, #expensesTable, #collectionsTable { display: block; width: 100%; }
      #stagesTable thead, #expensesTable thead, #collectionsTable thead { display: none; }
      #stagesTable tbody, #expensesTable tbody, #collectionsTable tbody { display: block; width: 100%; }
      #stagesTable tr, #expensesTable tr, #collectionsTable tr {
        display: block; margin-bottom: 15px; background: white; border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 10px; border: 1px solid #ddd;
      }
      #stagesTable td, #expensesTable td, #collectionsTable td {
        display: flex; justify-content: space-between; padding: 8px 0;
        border-bottom: 1px solid #eee; text-align: right;
      }
      #stagesTable td:last-child, #expensesTable td:last-child, #collectionsTable td:last-child { border-bottom: 0; }
      #stagesTable td::before, #expensesTable td::before, #collectionsTable td::before {
        font-weight: bold; margin-right: 10px; text-align: left; flex-grow: 1;
      }
      #stagesTable tbody td:nth-of-type(1)::before { content: "Aşama:"; }
      #stagesTable tbody td:nth-of-type(2)::before { content: "Sorumlu Kişi:"; }
      #stagesTable tbody td:nth-of-type(3)::before { content: "Tarih:"; }
      #stagesTable tbody td:nth-of-type(4)::before { content: "Notlar/Açıklama:"; }
      #stagesTable tbody td:nth-of-type(5)::before { content: "Tamamlandı mı?:"; }
      #expensesTable tbody td:nth-of-type(1)::before { content: "Açıklama:"; }
      #expensesTable tbody td:nth-of-type(2)::before { content: "Tutar (TL):"; }
      #expensesTable tbody td:nth-of-type(3)::before { content: "İşlem:"; }
      #collectionsTable tbody td:nth-of-type(1)::before { content: "Tarih:"; }
      #collectionsTable tbody td:nth-of-type(2)::before { content: "Tip:"; }
      #collectionsTable tbody td:nth-of-type(3)::before { content: "Açıklama / Detay:"; }
      #collectionsTable tbody td:nth-of-type(4)::before { content: "Vade Tarihi:"; } 
      #collectionsTable tbody td:nth-of-type(5)::before { content: "Tutar/Değer (TL):"; }
      #collectionsTable tbody td:nth-of-type(6)::before { content: "İşlem:"; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content-left"></div>
    <div class="logo-title-container">
      <img src="https://powerlinemersin.github.io/projetakip/logo.png" alt="Powerline Mersin" />
      <h1>Proje Detayları</h1>
    </div>
    <div class="header-content-right">
      <button onclick="logout()" style="background:#e74c3c; color:white;">Çıkış Yap</button>
    </div>
  </header>
  <main>
    <section>
      <h3>Genel Bilgiler</h3>
      <div class="input-group">
        <div style="flex: 2;"><label for="projectName">Proje Adı</label><input type="text" id="projectName" class="readonly" readonly /></div>
        <div style="flex: 2;"><label for="clientName">Müşteri Adı</label><input type="text" id="clientName" class="readonly" readonly /></div>
        <div style="flex: 1;"><label for="projectStatus">Proje Durumu</label><select id="projectStatus" onchange="updateProjectStatus(this.value)"><option value="Başlamadı">Başlamadı</option><option value="Devam Ediyor">Devam Ediyor</option><option value="Takip Ediliyor">Takip Ediliyor</option><option value="Tamamlandı">Tamamlandı</option></select></div>
      </div>
      <fieldset class="category-checkbox-group" id="projectCategoriesCheckboxesContainer"><legend>Proje Kategorileri</legend></fieldset>
      <h3>Aşamalar & Sorumlular</h3>
      <table id="stagesTable">
        <thead><tr><th>Aşama</th><th>Sorumlu Kişi</th><th>Tarih</th><th>Notlar/Açıklama</th><th>Tamamlandı mı?</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="input-group" style="margin-top: 20px;">
        <div><label for="startDate">Sözleşme Başlangıcı</label><input type="date" id="startDate" /></div>
        <div><label for="endDate">Sözleşme Bitişi</label><input type="date" id="endDate" /></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Sözleşme ve Kar Hesapları</h3>
      <div class="input-group">
          <div><label for="contractValue">Sözleşme Tutarı (TL)</label><input type="text" id="contractValue" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event)"/></div>
          <div><label for="totalExpenses">Toplam Harcama (TL)</label><input type="text" id="totalExpenses" class="readonly currency-input" readonly /></div>
      </div>
      <div class="input-group">
          <div><label for="realizedProfit">Gerçekleşen Kar (TL)</label><input type="text" id="realizedProfit" class="readonly currency-input" readonly /></div>
          <div><label for="realizedProfitMargin">Gerçekleşen Kar Marjı (%)</label><input type="text" id="realizedProfitMargin" class="readonly" readonly style="text-align: right;"/></div>
      </div>
      <div class="input-group" style="margin-top:10px;">
          <div><label for="totalCollections">Toplam Tahsil Edilen (TL)</label><input type="text" id="totalCollections" class="readonly currency-input" readonly /></div>
          <div><label for="remainingBalance">Kalan Bakiye (TL)</label><input type="text" id="remainingBalance" class="readonly currency-input" readonly /></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
      <h3>Harcama Kalemleri</h3>
      <table id="expensesTable">
        <thead><tr><th>Açıklama</th><th>Tutar (TL)</th><th>İşlem</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="input-group" style="margin-top: 15px;">
        <div><input type="text" id="expenseDesc" placeholder="Açıklama" /></div>
        <div><input type="text" id="expenseAmount" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event)"/></div>
        <div><button onclick="addExpense()">Harcama Ekle</button></div>
      </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Tahsilatlar</h3>
        <table id="collectionsTable" class="report-table"> 
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable('collectionsTable', 0, 'date')">Tarih</th>
                    <th class="sortable" onclick="sortTable('collectionsTable', 1, 'string')">Tip</th>
                    <th>Açıklama / Detay</th>
                    <th class="sortable" onclick="sortTable('collectionsTable', 3, 'date')">Vade Tarihi</th> 
                    <th class="sortable" onclick="sortTable('collectionsTable', 4, 'number')" style="text-align:right;">Tutar/Değer (TL)</th>
                    <th>İşlem</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="noCollectionsMessage" style="text-align:center; margin-top:10px; display:none;">Henüz tahsilat eklenmemiş.</p>
        <div style="margin-top: 20px; padding:15px; border:1px solid #ddd; border-radius:8px;">
            <h4>Yeni Tahsilat Ekle</h4>
            <div class="input-group">
                <div><label for="collectionDate">Tarih:</label><input type="date" id="collectionDate" onchange="fetchExchangeRatesForCollectionDate(this.value)"/></div>
                <div><label for="collectionType">Tip:</label><select id="collectionType" onchange="toggleCollectionDetails()"><option value="Nakit">Nakit</option><option value="Banka Transferi">Banka Transferi</option><option value="Çek">Çek</option><option value="Barter">Barter</option></select></div>
            </div>
            <!-- Kur gösterim alanı -->
            <div id="exchangeRateDisplay" class="exchange-rate-display" style="display:none;">
                <span>USD: <span id="usdRate">N/A</span> TL</span>
                <span>EUR: <span id="eurRate">N/A</span> TL</span>
            </div>
            <div id="collectionAmountGroup"><label for="collectionAmount">Tutar (TL):</label><input type="text" id="collectionAmount" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event)"/></div>
            <div id="checkDetailsGroup" class="collection-details-fields"><h5>Çek Detayları</h5><label for="checkDueDate">Vade Tarihi:</label><input type="date" id="checkDueDate" /><label for="checkNumber">Çek No:</label><input type="text" id="checkNumber" placeholder="Çek Numarası" /><label for="checkBank">Banka:</label><input type="text" id="checkBank" placeholder="Banka Adı" /></div>
            <div id="barterDetailsGroup" class="collection-details-fields"><h5>Barter Detayları</h5><label for="barterAsset">Takas Edilen Varlık:</label><input type="text" id="barterAsset" placeholder="Örn: Daire - A Blok No:5, Ford Transit" /><label for="barterValue">Belirlenen Değer (TL):</label><input type="text" id="barterValue" class="currency-input" placeholder="0,00" oninput="handleCurrencyInput(event)" onblur="formatCurrencyOnBlur(event)"/></div>
            <div><label for="collectionDescription">Açıklama/Not:</label><textarea id="collectionDescription" rows="3" placeholder="Tahsilatla ilgili ek notlar..."></textarea></div>
            <button onclick="addCollection()" style="margin-top:15px;">Tahsilat Ekle</button>
        </div>
    </section>

    <section style="margin-top: 30px;">
        <h3>Proje Dosyaları</h3>
        <div class="input-group file-upload-input-group">
            <div><label for="fileUploadInput">Dosya Seç</label><input type="file" id="fileUploadInput" /></div>
            <div><label for="fileDescriptionInput">Dosya Açıklaması (Opsiyonel)</label><input type="text" id="fileDescriptionInput" placeholder="Örn: Sözleşme V1, Teklif Onay Yazısı" /></div>
            <div><button onclick="uploadFile()">Yükle</button></div>
        </div>
        <div id="uploadProgress"><div id="uploadProgressBar"></div></div>
        <h4 style="margin-top: 20px;">Yüklenmiş Dosyalar:</h4>
        <ul id="fileList" class="file-list"></ul>
        <p id="noProjectFilesMessage" style="display:none;">Bu projeye henüz dosya yüklenmemiş.</p>
    </section>

    <div style="margin-top: 30px; padding-bottom: 30px;">
        <button onclick="saveDetails()">Sözleşme Bilgilerini Kaydet</button>
        <button onclick="generateExcelReport()" style="margin-left:10px; background:#27ae60;">Rapor İndir (Excel)</button>
        <button onclick="goBack()" style="margin-left:10px; background:#7f8c8d;">Geri Dön</button>
    </div>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
      authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
      projectId: "projetakipsistemi-fbabd",
      storageBucket: "projetakipsistemi-fbabd.appspot.com",
      messagingSenderId: "335282912485",
      appId: "1:335282912485:web:5ad9091ccf3cabd8f8280c"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    const functions = firebase.functions(); // Firebase Functions Client SDK'sı başlatıldı

    let projectId = null;
    const predefinedStageNames = ["Keşif / Ön görüşme", "Teklif oluşturma", "Onay – sözleşme", "Malzeme temini", "Uygulama", "Test ve devreye alma", "Teslimat"];
    const defaultProjectStatus = "Başlamadı";
    const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];

    function formatCurrencyTR(val){let n=typeof val==='string'?parseFloat(val.replace(/\./g,'').replace(',','.')):val;return isNaN(n)?"0,00":n.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});}
    function parseCurrencyTR(val){if(typeof val!=='string'||!val.trim())return 0;const cl=val.replace(/\./g,'').replace(',','.');const n=parseFloat(cl);return isNaN(n)?0:n;}
    function handleCurrencyInput(e){const i=e.target;let v=i.value;let nv=v.replace(/[^0-9,]/g,'');const p=nv.split(',');if(p.length>2){nv=p[0]+','+p.slice(1).join('');}i.value=nv;}
    function formatCurrencyOnBlur(e){const i=e.target;const nv=parseCurrencyTR(i.value);i.value=formatCurrencyTR(nv);updateCalculations();}
    function renderDetailCategoryCheckboxes(){const c=document.getElementById('projectCategoriesCheckboxesContainer');if(!c)return;let lg=c.querySelector('legend');if(!lg){lg=document.createElement('legend');lg.textContent='Proje Kategorileri';}c.innerHTML="";c.appendChild(lg);projectCategories.forEach(cat=>{const id=`detail_${cat.replace(/\s+/g,'-').toLowerCase()}`;const wr=document.createElement('span');wr.style.marginRight="15px";wr.style.display="inline-block";const cb=document.createElement('input');cb.type='checkbox';cb.id=id;cb.value=cat;cb.name='project_category_detail';cb.style.marginRight="5px";cb.style.verticalAlign="middle";cb.onchange=updateProjectCategories;const lb=document.createElement('label');lb.htmlFor=id;lb.textContent=cat;lb.style.fontWeight="normal";lb.style.cursor="pointer";lb.style.verticalAlign="middle";wr.appendChild(cb);wr.appendChild(lb);c.appendChild(wr);});}
    async function updateProjectCategories(){if(!projectId)return;const sel=[];document.querySelectorAll('#projectCategoriesCheckboxesContainer input[type="checkbox"]:checked').forEach(cb=>sel.push(cb.value));try{await db.collection("projects").doc(projectId).update({categories:sel});console.log("Kategoriler güncellendi:",sel);}catch(e){console.error("Kategori güncelleme hatası:",e);alert("Kategoriler güncellenemedi.");}}
    auth.onAuthStateChanged(u=>{if(!u){window.location.href="login.html";}else{const p=new URLSearchParams(window.location.search);projectId=p.get("id");if(projectId){loadProject();}else{alert("Proje ID yok.");goBack();}}});
    async function loadProject(){if(!projectId)return;try{renderDetailCategoryCheckboxes();const ref=db.collection("projects").doc(projectId);const doc=await ref.get();if(!doc.exists){alert("Proje bulunamadı.");goBack();return;}const p=doc.data();document.getElementById("projectName").value=p.name||"";document.getElementById("clientName").value=p.client||"";document.getElementById("startDate").value=p.startDate||"";document.getElementById("endDate").value=p.endDate||"";document.getElementById("contractValue").value=formatCurrencyTR(p.contractValue||0);document.getElementById("projectStatus").value=p.status||defaultProjectStatus;if(p.categories&&Array.isArray(p.categories)){p.categories.forEach(cat=>{const id=`detail_${cat.replace(/\s+/g,'-').toLowerCase()}`;const cb=document.getElementById(id);if(cb)cb.checked=true;});}
    let stages=p.stages||[];let updStg=false;if(!p.stages||p.stages.length===0){stages=predefinedStageNames.map(n=>({name:n,responsible:"",date:"",notes:"",completed:false}));updStg=true;}else if(stages.length!==predefinedStageNames.length||stages.some((s,i)=>s.name!==predefinedStageNames[i])){const newStg=predefinedStageNames.map(n=>{const es=stages.find(s1=>s1.name===n);return{name:n,responsible:es?.responsible||"",date:es?.date||"",notes:es?.notes||"",completed:es?.completed||false};});stages=newStg;updStg=true;}if(updStg&&stages.length>0){await ref.update({stages:stages});}
    renderStages(stages);renderExpenses(p.expenses||[]);renderCollections(p.collections||[]);renderFiles(p.files||[]);updateCalculations();}catch(e){console.error("Proje yükleme hatası:",e);alert("Detaylar yüklenemedi.");}}
    function renderStages(data){const tb=document.querySelector("#stagesTable tbody");tb.innerHTML="";predefinedStageNames.forEach((sName,i)=>{let s=data.find(st=>st.name===sName)||( {name:sName,responsible:"",date:"",notes:"",completed:false});tb.insertAdjacentHTML("beforeend",`<tr><td>${s.name}</td><td><input type="text" value="${s.responsible||''}" data-idx="${i}" data-field="responsible" class="stage-input"></td><td><input type="date" value="${s.date||''}" data-idx="${i}" data-field="date" class="stage-input"></td><td><textarea class="stage-notes-input stage-input" data-idx="${i}" data-field="notes">${s.notes||''}</textarea></td><td><input type="checkbox" ${s.completed?"checked":""} data-idx="${i}" data-field="completed" class="stage-input"></td></tr>`);});
    tb.querySelectorAll(".stage-input").forEach(inp=>{const idx=parseInt(inp.dataset.idx),fld=inp.dataset.field;inp.addEventListener((fld==="completed"?"change":(inp.tagName==='TEXTAREA'?"blur":"blur")),e=>saveStageField(idx,fld,(fld==="completed"?e.target.checked:e.target.value)));});}
    async function saveStageField(idx,fld,val){if(!projectId)return;try{const ref=db.collection("projects").doc(projectId);const doc=await ref.get();if(!doc.exists)return;let stg=doc.data().stages||[];if(!stg.length||stg.length!==predefinedStageNames.length||stg.some((s,i)=>s.name!==predefinedStageNames[i])){stg=predefinedStageNames.map(n=>{const es=stg.find(s1=>s1.name===n);return{name:n,responsible:es?.responsible||"",date:es?.date||"",notes:es?.notes||"",completed:es?.completed||false};});}
    if(stg[idx]){stg[idx][fld]=val;await ref.update({stages:stg});}}catch(e){console.error(`Aşama ${fld} güncelleme hatası:`,e);}}
    async function updateProjectStatus(newSt){if(!projectId)return;try{await db.collection("projects").doc(projectId).update({status:newSt});console.log("Durum güncellendi:",newSt);}catch(e){console.error("Durum güncelleme hatası:",e);alert("Durum güncellenemedi.");}}
    function renderExpenses(list){const tb=document.querySelector("#expensesTable tbody");tb.innerHTML="";(list||[]).forEach((it,idx)=>{tb.insertAdjacentHTML("beforeend",`<tr><td>${it.desc}</td><td style="text-align:right;">${formatCurrencyTR(it.amount||0)}</td><td><button onclick="removeExpense(${idx})" class="delete-file-btn" style="padding:5px 8px;">Sil</button></td></tr>`);});}
    async function addExpense(){const d=document.getElementById("expenseDesc").value.trim();const ai=document.getElementById("expenseAmount");const a=parseCurrencyTR(ai.value);if(!d||isNaN(a)||a<=0){alert("Geçerli açıklama ve tutar.");return;}try{const ref=db.collection("projects").doc(projectId);await ref.update({expenses:firebase.firestore.FieldValue.arrayUnion({desc:d,amount:a})});document.getElementById("expenseDesc").value="";ai.value=formatCurrencyTR(0);const ud=await ref.get();if(ud.exists){renderExpenses(ud.data().expenses||[]);updateCalculations();}}catch(e){console.error("Harcama ekleme hatası:",e);alert("Harcama eklenemedi.");}}
    async function removeExpense(idx){if(!confirm("Bu harcama silinsin mi?"))return;try{const ref=db.collection("projects").doc(projectId);const d=await ref.get();if(!d.exists)return;let ex=d.data().expenses||[];ex.splice(idx,1);await ref.update({expenses:ex});renderExpenses(ex);updateCalculations();}catch(e){console.error("Harcama silme hatası:",e);alert("Harcama silinemedi.");}}
    function renderCollections(arr){const tb=document.querySelector("#collectionsTable tbody");const msg=document.getElementById("noCollectionsMessage");tb.innerHTML="";if(arr&&arr.length>0){msg.style.display="none";arr.forEach((col,idx)=>{let amtDisp=col.type==="Barter"&&col.barterDetails?formatCurrencyTR(col.barterDetails.value||0):formatCurrencyTR(col.amount||0);let descDisp=col.description||'';let dueDateDisp='-';if(col.type==="Çek"&&col.checkDetails){descDisp+=`${descDisp?' <br> ':''}Çek No: ${col.checkDetails.checkNo||'N/A'}, Banka: ${col.checkDetails.bank||'N/A'}`;dueDateDisp=col.checkDetails.dueDate||'N/A';}else if(col.type==="Barter"&&col.barterDetails){descDisp+=`${descDisp?' - ':''}Takas: ${col.barterDetails.asset||'Belirtilmemiş'}`;}
    tb.insertAdjacentHTML("beforeend",`<tr><td>${col.date||'N/A'}</td><td>${col.type||'N/A'}</td><td>${descDisp}</td><td>${dueDateDisp}</td><td style="text-align:right;">${amtDisp}</td><td><button class="delete-file-btn" style="padding:5px 8px;" onclick="removeCollection(${idx})">Sil</button></td></tr>`);});}else{msg.style.display="block";}updateCalculations();}
    function toggleCollectionDetails(){const t=document.getElementById('collectionType').value;document.getElementById('checkDetailsGroup').style.display=t==='Çek'?'block':'none';document.getElementById('barterDetailsGroup').style.display=t==='Barter'?'block':'none';document.getElementById('collectionAmountGroup').style.display=t==='Barter'?'none':'block';}
    async function addCollection(){const dateInput=document.getElementById('collectionDate').value;const type=document.getElementById('collectionType').value;const description=document.getElementById('collectionDescription').value.trim();let amount=0,checkDetails=null,barterDetails=null;if(!dateInput||!type){alert("Tarih ve tip seçin.");return;}
    if(type==="Nakit"||type==="Banka Transferi"){amount=parseCurrencyTR(document.getElementById('collectionAmount').value);if(isNaN(amount)||amount<=0){alert("Geçerli tutar.");return;}}else if(type==="Çek"){amount=parseCurrencyTR(document.getElementById('collectionAmount').value);const dueDate=document.getElementById('checkDueDate').value;const checkNo=document.getElementById('checkNumber').value.trim();const bank=document.getElementById('checkBank').value.trim();if(isNaN(amount)||amount<=0||!dueDate||!checkNo||!bank){alert("Çek detayları ve tutar.");return;}checkDetails={dueDate,checkNo,bank};}else if(type==="Barter"){const asset=document.getElementById('barterAsset').value.trim();const value=parseCurrencyTR(document.getElementById('barterValue').value);if(!asset||isNaN(value)||value<=0){alert("Barter varlık ve değer.");return;}barterDetails={asset,value};}
    const newCollection={date:dateInput,type,description,amount:(type!=="Barter"?amount:null),checkDetails,barterDetails,addedAt:firebase.firestore.Timestamp.now()};
    try{const projectRef=db.collection("projects").doc(projectId);await projectRef.update({collections:firebase.firestore.FieldValue.arrayUnion(newCollection)});['collectionDate','collectionDescription','checkDueDate','checkNumber','checkBank','barterAsset'].forEach(id=>document.getElementById(id).value="");document.getElementById('collectionType').value="Nakit";document.getElementById('collectionAmount').value=formatCurrencyTR(0);document.getElementById('barterValue').value=formatCurrencyTR(0);toggleCollectionDetails();const updatedDoc=await projectRef.get();if(updatedDoc.exists)renderCollections(updatedDoc.data().collections||[]);alert("Tahsilat eklendi.");}catch(error){console.error("Tahsilat eklenirken Firestore hatası:",error);alert(`Tahsilat eklenemedi. Hata: ${error.message}`);}}
    async function removeCollection(idx){if(!confirm("Bu tahsilat silinsin mi?"))return;try{const ref=db.collection("projects").doc(projectId);const d=await ref.get();if(!d.exists)return;let cols=d.data().collections||[];cols.splice(idx,1);await ref.update({collections:cols});renderCollections(cols);alert("Tahsilat silindi.");}catch(e){console.error("Tahsilat silme hatası:",e);alert("Tahsilat silinemedi.");}}
    function updateCalculations(){const contract=parseCurrencyTR(document.getElementById("contractValue").value);let totalCost=0;document.querySelectorAll("#expensesTable tbody tr").forEach(r=>{totalCost+=parseCurrencyTR(r.cells[1]?r.cells[1].innerText:"0,00");});let totalColl=0;document.querySelectorAll("#collectionsTable tbody tr").forEach(r=>{totalColl+=parseCurrencyTR(r.cells[4]?r.cells[4].innerText:"0,00");});
    const profit=contract-totalCost;const margin=contract>0?(profit/contract)*100:0;const remain=contract-totalColl;
    document.getElementById("totalExpenses").value=formatCurrencyTR(totalCost);document.getElementById("realizedProfit").value=formatCurrencyTR(profit);document.getElementById("realizedProfitMargin").value=margin.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});document.getElementById("totalCollections").value=formatCurrencyTR(totalColl);document.getElementById("remainingBalance").value=formatCurrencyTR(remain);}
    async function saveDetails(){const ref=db.collection("projects").doc(projectId);try{await ref.update({startDate:document.getElementById("startDate").value,endDate:document.getElementById("endDate").value,contractValue:parseCurrencyTR(document.getElementById("contractValue").value)});alert("Sözleşme bilgileri kaydedildi.");updateCalculations();}catch(e){console.error("Detay kaydetme hatası:",e);alert("Bilgiler kaydedilemedi.");}}
    function renderFiles(files){const ul=document.getElementById("fileList");const msg=document.getElementById("noProjectFilesMessage"); if(!ul || !msg) { console.error("Dosya listesi veya mesaj elementi bulunamadı!"); return; } ul.innerHTML="";if(files&&files.length>0){msg.style.display="none";files.forEach((f,i)=>{ul.innerHTML+=`<li><a href="${f.url}" target="_blank" title="İndir: ${f.name}">${f.name}</a><button class="delete-file-btn" onclick="deleteFile(${i},'${f.name}','${f.path}')">Sil</button></li>`;});}else{msg.style.display="block";}}
    async function uploadFile(){const fin=document.getElementById('fileUploadInput');const desInp=document.getElementById('fileDescriptionInput');const f=fin.files[0];const des=desInp.value.trim();const pBarC=document.getElementById('uploadProgress');const pBar=document.getElementById('uploadProgressBar');if(!f){alert("Dosya seçin.");return;}if(!projectId){alert("Proje ID yok.");return;}
    const fNameStore=`${Date.now()}_${f.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;const fPath=`projects/${projectId}/${fNameStore}`;const fRef=storage.ref(fPath);try{const task=fRef.put(f);pBarC.style.display='block';task.on('state_changed',(s)=>{const prog=(s.bytesTransferred/s.totalBytes)*100;pBar.style.width=prog+'%';pBar.textContent=Math.round(prog)+'%';},(err)=>{console.error("Yükleme hatası:",err);alert(`Yükleme hatası: ${err.code} - ${err.message}`);pBarC.style.display='none';},async ()=>{pBarC.style.display='none';pBar.style.width='0%';pBar.textContent='';const url=await task.snapshot.ref.getDownloadURL();const pRef=db.collection("projects").doc(projectId);await pRef.update({files:firebase.firestore.FieldValue.arrayUnion({name:f.name,url,path:fPath,description:des,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()})});alert("Dosya yüklendi!");fin.value="";desInp.value="";const pDoc=await pRef.get();if(pDoc.exists)renderFiles(pDoc.data().files||[]);});}catch(e){console.error("Yükleme başlatma hatası:",e);alert("Yükleme başlatılamadı.");pBarC.style.display='none';}}
    async function deleteFile(idx,name,path){if(!confirm(`"${name}" silinsin mi?`))return;if(!projectId||!path){alert("Silinemedi, bilgi eksik.");return;}try{await storage.ref(path).delete();const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(pDoc.exists){let files=pDoc.data().files||[];files=files.filter(f=>f.path!==path);await pRef.update({files});renderFiles(files);alert(`"${name}" silindi.`);}}catch(e){console.error("Dosya silme hatası:",e);if(e.code==='storage/object-not-found'){alert("Dosya Storage'da yok. DB kaydı siliniyor.");const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(pDoc.exists){let files=pDoc.data().files||[];files=files.filter(f=>f.path!==path);await pRef.update({files});renderFiles(files);}}else{alert(`Silme hatası: ${e.message}`);}}}
    async function generateExcelReport(){if(!projectId){alert("Proje bulunamadı.");return;}const pRef=db.collection("projects").doc(projectId);const pDoc=await pRef.get();if(!pDoc.exists){alert("Proje verisi yok.");return;}const p=pDoc.data();const wb=XLSX.utils.book_new();
    const generalInfoData=[["Proje Adı",p.name||'N/A'],["Müşteri Adı",p.client||'N/A'],["Proje Durumu",p.status||defaultProjectStatus],["Kategoriler",(p.categories||[]).join(", ")||'N/A'],["Sözleşme Başlangıcı",p.startDate||'N/A'],["Sözleşme Bitişi",p.endDate||'N/A']];const wsGeneral=XLSX.utils.aoa_to_sheet(generalInfoData);XLSX.utils.book_append_sheet(wb,wsGeneral,"Genel Bilgiler");
    const stagesHeaders=["Aşama Adı","Sorumlu Kişi","Tarih","Notlar","Durum"];const stagesBody=(p.stages||[]).map(s=>[s.name,s.responsible,s.date,s.notes||'',s.completed?"Tamamlandı":"Tamamlanmadı"]);const wsStages=XLSX.utils.aoa_to_sheet([stagesHeaders,...stagesBody]);XLSX.utils.book_append_sheet(wb,wsStages,"Aşamalar");
    const expensesHeaders=["Açıklama","Tutar (TL)"];const expensesBody=(p.expenses||[]).map(e=>[e.desc,e.amount]);const wsExpenses=XLSX.utils.aoa_to_sheet([expensesHeaders,...expensesBody]);(expensesBody||[]).forEach((r,i)=>{const adr=XLSX.utils.encode_cell({c:1,r:i+1});if(wsExpenses[adr]){wsExpenses[adr].t='n';wsExpenses[adr].z='#,##0.00 TL';}});XLSX.utils.book_append_sheet(wb,wsExpenses,"Harcamalar");
    const collectionsHeaders=["Tarih","Tip","Açıklama / Detay","Vade Tarihi","Tutar/Değer (TL)"];const collectionsBody=(p.collections||[]).map(c=>{let amt=0;let desc=c.description||'';let dueDate='-';if(c.type==="Barter"&&c.barterDetails){amt=c.barterDetails.value||0;desc+=`${desc?' - ':''}Takas: ${c.barterDetails.asset||'Belirtilmemiş'}`;}else if(c.type==="Çek"&&c.checkDetails){amt=c.amount||0;desc+=`${desc?' <br> ':''}Çek No: ${c.checkDetails.checkNo||'N/A'}, Banka: ${col.checkDetails.bank||'N/A'}`;dueDate=c.checkDetails.dueDate||'-';}else{amt=c.amount||0;}return[c.date,c.type,desc,dueDate,amt];});const wsCollections=XLSX.utils.aoa_to_sheet([collectionsHeaders,...collectionsBody]);(collectionsBody||[]).forEach((r,i)=>{const adr=XLSX.utils.encode_cell({c:4,r:i+1});if(wsCollections[adr]){wsCollections[adr].t='n';wsCollections[adr].z='#,##0.00 TL';}});XLSX.utils.book_append_sheet(wb,wsCollections,"Tahsilatlar");
    const contractVal=p.contractValue||0;const totalExp=(p.expenses||[]).reduce((s,e)=>s+(e.amount||0),0);const totalColl=(p.collections||[]).reduce((s,c)=>s+((c.type==="Barter"&&c.barterDetails?c.barterDetails.value:c.amount)||0),0);const realProfit=contractVal-totalExp;const profitMargin=contractVal>0?(realProfit/contractVal)*100:0;const remainBal=contractVal-totalColl;
    const financialData=[["Sözleşme Tutarı (TL)",contractVal],["Toplam Harcama (TL)",totalExp],["Gerçekleşen Kar (TL)",realProfit],["Kar Marjı (%)",profitMargin],["Toplam Tahsil Edilen (TL)",totalColl],["Kalan Bakiye (TL)",remainBal]];const wsFinancial=XLSX.utils.aoa_to_sheet(financialData);financialData.forEach((r,i)=>{const adr=XLSX.utils.encode_cell({c:1,r:i});if(wsFinancial[adr]){wsFinancial[adr].t='n';wsFinancial[adr].z=i===3?'0.00%':'#,##0.00 TL';if(i===3)wsFinancial[adr].v=profitMargin/100;}});XLSX.utils.book_append_sheet(wb,wsFinancial,"Finansal Özet");
    if(p.files&&p.files.length>0){const filesHeaders=["Dosya Adı","Yüklenme Tarihi","URL"];const filesBody=(p.files||[]).map(f=>[f.name,f.uploadedAt?.toDate?f.uploadedAt.toDate().toLocaleDateString('tr-TR'):'N/A',f.url]);const wsFiles=XLSX.utils.aoa_to_sheet([filesHeaders,...filesBody]);XLSX.utils.book_append_sheet(wb,wsFiles,"Proje Dosyaları");}
    const fileName=`${p.name?p.name.replace(/[^a-zA-Z0-9]/g,'_'):'proje'}_rapor.xlsx`;XLSX.writeFile(wb,fileName);alert("Excel raporu oluşturuldu ve indiriliyor.");}
    let sortDirections={};function sortTable(tableId,columnIndex,dataType='string'){const table=document.getElementById(tableId);if(!table||!table.tBodies[0]||table.tBodies[0].rows.length===0){return;}const tbody=table.tBodies[0];const rows=Array.from(tbody.rows);const headerCells=table.tHead.rows[0].cells;const headerCell=headerCells[columnIndex];const currentSortKey=`${tableId}-${columnIndex}`;let newDirection='asc';if(sortDirections[currentSortKey]==='asc'){newDirection='desc';}
    for(let i=0;i<headerCells.length;i++){headerCells[i].classList.remove('sort-asc','sort-desc');}sortDirections={};sortDirections[currentSortKey]=newDirection;headerCell.classList.add(newDirection==='asc'?'sort-asc':'sort-desc');
    rows.sort((rowA,rowB)=>{let valA=rowA.cells[columnIndex].textContent.trim();let valB=rowB.cells[columnIndex].textContent.trim();if(dataType==='number'){const cleanA=valA.replace(/[^\d,-]/g,'').replace(',','.');const cleanB=valB.replace(/[^\d,-]/g,'').replace(',','.');valA=parseFloat(cleanA)||0;valB=parseFloat(cleanB)||0;}else if(dataType==='date'){const parseDate=(dateStr)=>{if(!dateStr||dateStr.toLowerCase()==="n/a"||dateStr.trim()==="-")return 0;let parts=dateStr.split('-');if(parts.length===3&&parts[0].length===4)return new Date(parts[0],parts[1]-1,parts[2]).getTime();parts=dateStr.split('.');if(parts.length===3&&parts[2].length===4)return new Date(parts[2],parts[1]-1,parts[0]).getTime();const parsed=new Date(dateStr).getTime();return isNaN(parsed)?(newDirection==='asc'?Infinity:-Infinity):parsed;};valA=parseDate(valA);valB=parseDate(valB);}else{valA=valA.toLowerCase();valB=valB.toLowerCase();}
    if(valA<valB)return newDirection==='asc'?-1:1;if(valA>valB)return newDirection==='asc'?1:-1;return 0;});rows.forEach(row=>tbody.appendChild(row));}
    function goBack(){window.location.href="index.html";}
    function logout(){auth.signOut().then(()=>window.location.href="login.html").catch(e=>{console.error("Çıkış hatası:",e);alert("Çıkış hatası.");});}

    // KUR ÇEKME VE GÖSTERME FONKSİYONLARI
    async function fetchExchangeRatesForCollectionDate(dateString) {
        const usdRateSpan = document.getElementById('usdRate');
        const eurRateSpan = document.getElementById('eurRate');
        const displayDiv = document.getElementById('exchangeRateDisplay');

        usdRateSpan.textContent = 'Yükleniyor...';
        eurRateSpan.textContent = 'Yükleniyor...';
        displayDiv.style.display = 'flex'; // Göster

        if (!dateString) {
            usdRateSpan.textContent = 'N/A';
            eurRateSpan.textContent = 'N/A';
            displayDiv.style.display = 'none'; // Tarih seçilmezse gizle
            return;
        }

        try {
            const getRates = firebase.functions().httpsCallable('getExchangeRateForDate'); // Function adı
            const result = await getRates({ date: dateString }); // Tarihi gönder

            if (result.data && result.data.success) {
                const rates = result.data.rates;
                usdRateSpan.textContent = rates.USD ? rates.USD.toFixed(4) : 'N/A';
                eurRateSpan.textContent = rates.EUR ? rates.EUR.toFixed(4) : 'N/A';
                console.log(`Kurlar çekildi (${result.data.source}):`, rates);
            } else {
                console.error("Kur çekme başarılı değil:", result.data);
                usdRateSpan.textContent = 'Hata';
                eurRateSpan.textContent = 'Hata';
                alert(`Kur bilgisi alınamadı: ${result.data.message || 'Bilinmeyen Hata'}`);
            }
        } catch (error) {
            console.error("Kur çekme fonksiyonu çağrılırken hata:", error);
            usdRateSpan.textContent = 'Hata';
            eurRateSpan.textContent = 'Hata';
            alert(`Kur bilgisi alınamadı. Hata: ${error.message}`);
        }
    }
  </script>
</body>
</html>
