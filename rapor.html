<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dönemsel Proje Analiz Raporu</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f9fbfd; color: #2c3e50;
      padding: 20px;
    }
    header {
      background-color: #34495e; color: white; padding: 15px 30px; display: flex;
      align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    header h1 { font-weight: 600; font-size: 1.6rem; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .filter-section { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-section > div { display: flex; flex-direction: column; }
    .filter-section label { margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
    .filter-section input[type="date"], .filter-section button {
      padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem;
    }
    .filter-section button {
      background-color: #2980b9; color: white; cursor: pointer; border: none;
      transition: background-color 0.3s ease; height: 43px; 
    }
    .filter-section button:hover { background-color: #1c5980; }
    #loadingIndicator { margin-top: 10px; font-style: italic; color: #555; }
    #reportResults { margin-top: 20px; }
    #reportResults h3 { 
        color: #34495e; margin-top: 25px; margin-bottom: 10px;
        border-bottom: 1px solid #2980b9; padding-bottom: 5px; font-size: 1.2rem;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
    th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: left; word-wrap: break-word; }
    thead th { background-color: #f2f2f2; font-weight: 600; }
    .summary-section div { margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; }
    .summary-section strong { display: block; margin-bottom: 5px; font-size: 1.1em; color: #34495e; }
    .summary-section span { font-size: 1.3em; font-weight: 600; }
    .error-message { color: red; font-weight: bold; }
    .report-table th, .report-table td { vertical-align: top; }
     .report-table th.sortable { cursor: pointer; }
    .report-table th.sortable:hover { background-color: #e9ecef; }
    .report-table th.sortable::after {
        content: ' \2195'; font-size: 0.8em; opacity: 0.5;
    }
    .report-table th.sort-asc::after { content: ' \2191'; opacity: 1;}
    .report-table th.sort-desc::after { content: ' \2193'; opacity: 1;}
  </style>
</head>
<body>
  <header>
    <h1>Dönemsel Proje Analiz Raporu</h1>
    <button onclick="goBackToDashboard()" style="margin-left:auto; background:#7f8c8d; color:white;">Ana Sayfaya Dön</button>
  </header>

  <div class="container">
    <div class="filter-section">
      <div>
        <label for="reportStartDate">Rapor Başlangıç Tarihi:</label>
        <input type="date" id="reportStartDate">
      </div>
      <div>
        <label for="reportEndDate">Rapor Bitiş Tarihi:</label>
        <input type="date" id="reportEndDate">
      </div>
      <div>
        <button id="generateReportButton" onclick="generateAnalysisReport()">Raporu Oluştur</button>
      </div>
    </div>

    <div id="loadingIndicator" style="display:none;">Rapor verileri yükleniyor, lütfen bekleyin...</div>
    <div id="reportResults">
      <p>Lütfen raporlamak istediğiniz tarih aralığını seçip "Raporu Oluştur" butonuna tıklayın.</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAGo34K8pKUPPjq0Dd2U6L6BqXDbexlZ1I",
      authDomain: "projetakipsistemi-fbabd.firebaseapp.com",
      projectId: "projetakipsistemi-fbabd",
      storageBucket: "projetakipsistemi-fbabd.appspot.com",
      messagingSenderId: "335282912485",
      appId: "1:335282912485:web:5ad9091ccf3cabd8f8280c"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Proje Kategorileri Tanımı (index.html ve project-detail.html ile aynı olmalı)
    const projectCategories = ["Aydınlatma", "Otomasyon", "Taahhüt", "Danışmanlık", "Diğer"];
    const defaultProjectStatus = "Başlamadı"; // Proje durumları için varsayılan (project-detail'den)

    auth.onAuthStateChanged(user => {
      if (!user) {
        console.warn("Kullanıcı girişi yapılmamış. Bu sayfa normalde yetkili erişim gerektirir.");
        // Opsiyonel: window.location.href = "login.html"; 
      } else {
        console.log("Yetkili kullanıcı, rapor sayfasına erişebilir.");
      }
    });

    function goBackToDashboard() {
        window.location.href = "index.html";
    }

    function formatCurrencyTR(numberStrOrNum) {
        let number = typeof numberStrOrNum === 'string' ? parseFloat(numberStrOrNum.replace(/\./g, '').replace(',', '.')) : numberStrOrNum;
        if (isNaN(number)) return "0,00";
        return number.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    // parseCurrencyTR bu dosyada doğrudan kullanılmıyor ama tutarlılık için kalabilir.
    function parseCurrencyTR(formattedValue) { 
        if (typeof formattedValue !== 'string' || !formattedValue.trim()) return 0;
        const cleanedValue = formattedValue.replace(/\./g, '').replace(',', '.');
        const number = parseFloat(cleanedValue);
        return isNaN(number) ? 0 : number;
    }

    async function generateAnalysisReport() {
      const startDateInput = document.getElementById('reportStartDate').value;
      const endDateInput = document.getElementById('reportEndDate').value;
      const resultsDiv = document.getElementById('reportResults');
      const loadingIndicator = document.getElementById('loadingIndicator');

      resultsDiv.innerHTML = ""; 
      if (!startDateInput || !endDateInput) {
        resultsDiv.innerHTML = "<p class='error-message'>Lütfen başlangıç ve bitiş tarihlerini seçin!</p>";
        return;
      }
      if (new Date(startDateInput) > new Date(endDateInput)) {
        resultsDiv.innerHTML = "<p class='error-message'>Başlangıç tarihi, bitiş tarihinden sonra olamaz!</p>";
        return;
      }

      loadingIndicator.style.display = 'block';
      resultsDiv.innerHTML = ""; 

      try {
        const projectsSnapshot = await db.collection("projects").get();
        let allProjects = [];
        projectsSnapshot.forEach(doc => {
          allProjects.push({ id: doc.id, ...doc.data() });
        });

        const projectsInDateRange = allProjects.filter(proj => {
            const projectStartDate = proj.startDate ? new Date(proj.startDate) : null;
            const projectEndDate = proj.endDate ? new Date(proj.endDate) : null;
            const reportStartDate = new Date(startDateInput);
            const reportEndDate = new Date(endDateInput);
            reportEndDate.setHours(23, 59, 59, 999);
            if (!projectStartDate || !projectEndDate) return false;
            return projectStartDate <= reportEndDate && projectEndDate >= reportStartDate;
        });

        if (projectsInDateRange.length === 0) {
          resultsDiv.innerHTML = "<p>Belirtilen tarih aralığıyla kesişen proje bulunamadı.</p>";
          loadingIndicator.style.display = 'none';
          return;
        }
        
        console.log("Filtrelenmiş Projeler:", projectsInDateRange);
        let reportHTML = `<h3>Rapor Dönemi: ${startDateInput} - ${endDateInput}</h3>`;

        let totalContractValue = 0;
        let totalActualExpenses = 0;
        projectsInDateRange.forEach(p => {
            totalContractValue += (p.contractValue || 0);
            (p.expenses || []).forEach(exp => { totalActualExpenses += (exp.amount || 0); });
        });
        const totalNetProfitOrLoss = totalContractValue - totalActualExpenses;
        const averageProfitMargin = totalContractValue > 0 ? (totalNetProfitOrLoss / totalContractValue) * 100 : 0;
        const averageProfitPerProject = projectsInDateRange.length > 0 ? totalNetProfitOrLoss / projectsInDateRange.length : 0;

        reportHTML += `<div class="summary-section"><h3>Genel Finansal Özet</h3>
            <div><strong>Bu Dönemde Kapsanan Proje Sayısı:</strong> <span>${projectsInDateRange.length}</span></div>
            <div><strong>Toplam Sözleşme Bedeli:</strong> <span>${formatCurrencyTR(totalContractValue)} TL</span></div>
            <div><strong>Toplam Gerçekleşen Harcama:</strong> <span>${formatCurrencyTR(totalActualExpenses)} TL</span></div>
            <div><strong>Net Dönemsel Kar/Zarar:</strong> <span style="color:${totalNetProfitOrLoss >= 0 ? 'green' : 'red'};">${formatCurrencyTR(totalNetProfitOrLoss)} TL</span></div>
            <div><strong>Ortalama Proje Başına Kar/Zarar:</strong> <span>${formatCurrencyTR(averageProfitPerProject)} TL</span></div>
            <div><strong>Ortalama Kar Marjı:</strong> <span>${averageProfitMargin.toFixed(2)}%</span></div></div>`;

        reportHTML += `<h3>Proje Detayları (Dönem İçi Kapsananlar)</h3>
            <table class="report-table" id="projectDetailTable"><thead><tr>
            <th class="sortable" onclick="sortTable('projectDetailTable',0)">Proje Adı</th><th class="sortable" onclick="sortTable('projectDetailTable',1)">Müşteri</th>
            <th>Kategoriler</th><th class="sortable" onclick="sortTable('projectDetailTable',3)">Durum</th>
            <th class="sortable" onclick="sortTable('projectDetailTable',4,'date')">Söz. Başlangıç</th><th class="sortable" onclick="sortTable('projectDetailTable',5,'date')">Söz. Bitiş</th>
            <th class="sortable" onclick="sortTable('projectDetailTable',6,'number')">Söz. Tutarı (TL)</th><th class="sortable" onclick="sortTable('projectDetailTable',7,'number')">Top. Harcama (TL)</th>
            <th class="sortable" onclick="sortTable('projectDetailTable',8,'number')">Net Kar/Zarar (TL)</th><th class="sortable" onclick="sortTable('projectDetailTable',9,'number')">Kar Marjı (%)</th>
            <th class="sortable" onclick="sortTable('projectDetailTable',10,'number')">Proje Süresi (Gün)</th>
            </tr></thead><tbody>`;
        projectsInDateRange.forEach(p => {
            const pExp = (p.expenses||[]).reduce((s,e)=>s+(e.amount||0),0); const pProfit=(p.contractValue||0)-pExp;
            const pMrg=(p.contractValue||0)>0?(pProfit/(p.contractValue||0))*100:0;
            const sDate=p.startDate?new Date(p.startDate):null; const eDate=p.endDate?new Date(p.endDate):null;
            let pDur="N/A"; if(sDate&&eDate&&eDate>=sDate){pDur=Math.ceil((eDate-sDate)/(1000*60*60*24))+1;}
            reportHTML += `<tr><td>${p.name||'N/A'}</td><td>${p.client||'N/A'}</td><td>${(p.categories||[]).join(", ")||'N/A'}</td>
                <td>${p.status||defaultProjectStatus}</td><td>${p.startDate||'N/A'}</td><td>${p.endDate||'N/A'}</td>
                <td style="text-align:right;">${formatCurrencyTR(p.contractValue||0)}</td><td style="text-align:right;">${formatCurrencyTR(pExp)}</td>
                <td style="text-align:right;color:${pProfit>=0?'green':'red'};">${formatCurrencyTR(pProfit)}</td>
                <td style="text-align:right;">${pMrg.toFixed(2)}%</td><td style="text-align:right;">${pDur}</td></tr>`;
        });
        reportHTML += `</tbody></table>`;

        const categoryAnalysis = {};
        // projectCategories burada tanımlı olmalı (globalde tanımlandı)
        projectCategories.forEach(cat => { categoryAnalysis[cat] = { count:0,totalContract:0,totalExpense:0,totalProfit:0,projects:[]}; });
        projectsInDateRange.forEach(p => {
            const pExp=(p.expenses||[]).reduce((s,e)=>s+(e.amount||0),0); const pProfit=(p.contractValue||0)-pExp;
            (p.categories||[]).forEach(cat=>{if(categoryAnalysis[cat]){categoryAnalysis[cat].count++; categoryAnalysis[cat].totalContract+=(p.contractValue||0); categoryAnalysis[cat].totalExpense+=pExp; categoryAnalysis[cat].totalProfit+=pProfit; categoryAnalysis[cat].projects.push({name:p.name,profit:pProfit});}});
        });

        reportHTML += `<h3>Proje Tipi (Kategori) Bazlı Performans Analizi</h3>
            <table class="report-table" id="categoryAnalysisTable"><thead><tr>
            <th class="sortable" onclick="sortTable('categoryAnalysisTable',0)">Kategori Adı</th><th class="sortable" onclick="sortTable('categoryAnalysisTable',1,'number')">Proje Sayısı</th>
            <th class="sortable" onclick="sortTable('categoryAnalysisTable',2,'number')">Top. Söz. Bedeli (TL)</th><th class="sortable" onclick="sortTable('categoryAnalysisTable',3,'number')">Top. Harcama (TL)</th>
            <th class="sortable" onclick="sortTable('categoryAnalysisTable',4,'number')">Top. Net Kar/Zarar (TL)</th><th class="sortable" onclick="sortTable('categoryAnalysisTable',5,'number')">Ort. Kar Marjı (%)</th>
            <th>En Karlı Proje (Kar)</th><th>En Zararlı Proje (Zarar)</th>
            </tr></thead><tbody>`;
        for(const cat in categoryAnalysis){
            if(categoryAnalysis.hasOwnProperty(cat)&&categoryAnalysis[cat].count>0){
                const cd=categoryAnalysis[cat]; const avgM=cd.totalContract>0?(cd.totalProfit/cd.totalContract)*100:0;
                let mostP={name:"N/A",profit:-Infinity}; let leastP={name:"N/A",profit:Infinity};
                cd.projects.forEach(p=>{if(p.profit>mostP.profit)mostP=p; if(p.profit<leastP.profit)leastP=p;});
                const mostPDisp=mostP.profit>0?`${mostP.name} (${formatCurrencyTR(mostP.profit)})`:"N/A";
                const leastPDisp=leastP.profit<0?`${leastP.name} (${formatCurrencyTR(leastP.profit)})`:"N/A";
                reportHTML+=`<tr><td>${cat}</td><td style="text-align:right;">${cd.count}</td>
                    <td style="text-align:right;">${formatCurrencyTR(cd.totalContract)}</td><td style="text-align:right;">${formatCurrencyTR(cd.totalExpense)}</td>
                    <td style="text-align:right;color:${cd.totalProfit>=0?'green':'red'};">${formatCurrencyTR(cd.totalProfit)}</td>
                    <td style="text-align:right;">${avgM.toFixed(2)}%</td><td>${mostPDisp}</td><td>${leastPDisp}</td></tr>`;
            }
        }
        reportHTML += `</tbody></table>`;
        reportHTML += `<p style="font-size:0.8em; margin-top:10px;">Rapor Oluşturma Tarihi: ${new Date().toLocaleString('tr-TR')}</p>`;
        resultsDiv.innerHTML = reportHTML;

      } catch (error) {
        console.error("Rapor oluşturulurken hata oluştu: ", error);
        resultsDiv.innerHTML = `<p class='error-message'>Rapor oluşturulurken bir hata oluştu. Konsolu kontrol edin. Hata: ${error.message}</p>`;
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }
    
    let sortDirections = {}; 
    function sortTable(tableId, columnIndex, type = 'string') {
        const table = document.getElementById(tableId); if (!table) return;
        const tbody = table.tBodies[0]; const rows = Array.from(tbody.rows);
        const headerCell = table.tHead.rows[0].cells[columnIndex];
        const currentDirection = sortDirections[`${tableId}-${columnIndex}`] || 'asc';
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        sortDirections = {}; // Sadece bir sütun için aktif sıralama
        sortDirections[`${tableId}-${columnIndex}`] = newDirection;
        Array.from(table.tHead.rows[0].cells).forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
        headerCell.classList.add(newDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        rows.sort((a, b) => {
            let valA = a.cells[columnIndex].textContent.trim();
            let valB = b.cells[columnIndex].textContent.trim();
            if (type === 'number') {
                // Para formatını ve yüzdeyi sayıya çevir
                const cleanValA = valA.replace(/[^\d,-]/g, '').replace(',', '.');
                const cleanValB = valB.replace(/[^\d,-]/g, '').replace(',', '.');
                valA = parseFloat(cleanValA) || 0; // NaN ise 0
                valB = parseFloat(cleanValB) || 0;
            } else if (type === 'date') {
                // YYYY-MM-DD formatı için basit string karşılaştırması yeterli olabilir.
                // Daha sağlamı: new Date(valA.split('.').reverse().join('-')) vs.
            }
            if (valA < valB) return newDirection === 'asc' ? -1 : 1;
            if (valA > valB) return newDirection === 'asc' ? 1 : -1;
            return 0;
        });
        rows.forEach(row => tbody.appendChild(row));
    }
  </script>
</body>
</html>
