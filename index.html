<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proje Takip Sistemi</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* ... (mevcut stilleriniz aynÄ± kalacak, sadece filtreleme bÃ¶lÃ¼mÃ¼ iÃ§in eklemeler) ... */
    .filter-sort-container {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap; /* Mobil iÃ§in Ã¶nemli */
        gap: 15px; /* Elemanlar arasÄ± boÅŸluk */
        align-items: flex-end; /* Label ve select'leri hizalamak iÃ§in */
    }
    .filter-sort-container > div {
        display: flex;
        flex-direction: column; /* Label Ã¼stte, select altta */
        flex-grow: 1; /* AlanÄ± doldurmasÄ± iÃ§in */
        min-width: 180px; /* Mobil iÃ§in minimum geniÅŸlik */
    }
    .filter-sort-container label {
        margin-bottom: 5px; /* Label ve select arasÄ± boÅŸluk */
        font-size: 0.9em;
        color: #555;
    }
    .filter-sort-container select, .filter-sort-container button {
        padding: 8px 10px; /* Buton ve select iÃ§in daha uygun padding */
        font-size: 0.95rem;
    }
    .filter-sort-container button {
        flex-grow: 0; /* ButonlarÄ±n geniÅŸlemesini engelle */
        width: auto; /* Buton iÃ§eriÄŸe gÃ¶re geniÅŸlesin */
        margin-top: 0; /* Global button margin-top'unu ez */
    }
    /* ... (diÄŸer mevcut stilleriniz) ... */
  </style>
</head>
<body>
  <header>
    <!-- ... (header iÃ§eriÄŸi) ... -->
  </header>

  <main>
    <h3>âž• Yeni Proje Ekle</h3>
    <!-- ... (Yeni Proje Ekleme Formu - kategori checkboxlarÄ± dahil) ... -->
     <div class="input-group">
      <input id="projectName" placeholder="Proje AdÄ±" />
      <input id="clientName" placeholder="MÃ¼ÅŸteri AdÄ±" />
    </div>
    <fieldset class="category-checkbox-group" id="newProjectCategories">
        <legend>Proje Kategorileri</legend>
    </fieldset>
    <div class="input-group" style="margin-top:10px;">
         <button class="btn-primary" onclick="addProject()">Ekle</button>
    </div>


    <h3>ðŸ“‹ Proje Listesi (<span id="userRoleDisplay" style="font-weight:normal; font-size:0.9em;"></span>)</h3>

    <!-- FÄ°LTRELEME VE SIRALAMA BÃ–LÃœMÃœ -->
    <div class="filter-sort-container">
        <div>
            <label for="filterStatus">Duruma GÃ¶re Filtrele:</label>
            <select id="filterStatus" onchange="applyFiltersAndSort()">
                <option value="">TÃ¼mÃ¼</option>
                <option value="BaÅŸlamadÄ±">BaÅŸlamadÄ±</option>
                <option value="Devam Ediyor">Devam Ediyor</option>
                <option value="TamamlandÄ±">TamamlandÄ±</option>
            </select>
        </div>
        <div>
            <label for="filterCategory">Kategoriye GÃ¶re Filtrele:</label>
            <select id="filterCategory" onchange="applyFiltersAndSort()">
                <option value="">TÃ¼mÃ¼</option>
                <!-- Kategoriler JavaScript ile eklenecek -->
            </select>
        </div>
        <div>
            <label for="sortField">SÄ±rala:</label>
            <select id="sortField" onchange="applyFiltersAndSort()">
                <option value="createdAt">OluÅŸturulma Tarihi</option>
                <option value="name">Proje AdÄ±</option>
                <option value="contractValue">SÃ¶zleÅŸme Bedeli</option>
            </select>
        </div>
        <div>
            <label for="sortDirection">YÃ¶n:</label>
            <select id="sortDirection" onchange="applyFiltersAndSort()">
                <option value="desc">Azalan (Yeni/Z-A/YÃ¼ksek)</option>
                <option value="asc">Artan (Eski/A-Z/DÃ¼ÅŸÃ¼k)</option>
            </select>
        </div>
        <div>
            <button onclick="resetFiltersAndSort()" style="background-color:#7f8c8d;">SÄ±fÄ±rla</button>
        </div>
    </div>
    <!-- FÄ°LTRELEME VE SIRALAMA BÃ–LÃœMÃœ SONU -->

    <table id="projectTable">
      <!-- ... (Tablo baÅŸlÄ±ÄŸÄ± ve tbody aynÄ±) ... -->
       <thead>
        <tr>
          <th>Proje AdÄ±</th>
          <th>MÃ¼ÅŸteri</th>
          <th>Kategoriler</th>
          <th>Durum</th>
          <th>SÃ¶zleÅŸme Bedeli</th>
          <th>Ä°ÅŸlem</th>
        </tr>
      </thead>
      <tbody id="projectBody"></tbody>
    </table>
    <p id="noProjectsMessage" style="text-align:center; margin-top:20px; display:none;">Filtreyle eÅŸleÅŸen proje bulunamadÄ± veya henÃ¼z kayÄ±tlÄ± proje yok.</p>
  </main>

  <script>
    // ... (Firebase config, app, db, auth tanÄ±mlamalarÄ± aynÄ±) ...
    const firebaseConfig = { /* ... */ };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let userId = null;
    let currentUserRole = null;
    const projectStatuses = { /* ... */ };
    const defaultStatus = "BaÅŸlamadÄ±";
    const projectCategories = ["AydÄ±nlatma", "Otomasyon", "TaahhÃ¼t", "DanÄ±ÅŸmanlÄ±k", "DiÄŸer"];

    // Kategori checkbox'larÄ±nÄ± ve filtre dropdown'Ä±nÄ± oluÅŸtur
    function renderCategoryCheckboxes(containerId, prefix = "") { /* ... (mevcut kod) ... */ }
    
    function populateCategoryFilter() {
        const filterCategorySelect = document.getElementById('filterCategory');
        if (!filterCategorySelect) return;
        // Ä°lk "TÃ¼mÃ¼" seÃ§eneÄŸini koru
        projectCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            filterCategorySelect.appendChild(option);
        });
    }
    
    window.onload = function() {
        renderCategoryCheckboxes('newProjectCategories', 'new_');
        populateCategoryFilter(); // Kategori filtresini doldur
        // BaÅŸlangÄ±Ã§ta filtre/sÄ±ralama olmadan yÃ¼kle (auth.onAuthStateChanged iÃ§inde Ã§aÄŸrÄ±lacak)
    };

    auth.onAuthStateChanged(async user => {
      if (!user) { /* ... */ } 
      else {
        userId = user.uid;
        try { /* ... (rol alma kodu) ... */ } 
        catch (error) { /* ... */ }
        // loadProjects() buradan kaldÄ±rÄ±ldÄ±, applyFiltersAndSort Ã§aÄŸrÄ±lacak.
        // Ä°lk yÃ¼klemede filtreler boÅŸ olacaÄŸÄ± iÃ§in tÃ¼m projeler (role gÃ¶re) gelecek.
        applyFiltersAndSort(); 
      }
    });

    function getStatusBadge(statusText) { /* ... (mevcut kod) ... */ }

    async function loadProjects(filters = {}) { // filters objesi eklendi
      if (!userId || currentUserRole === null) { return; }
      const tbody = document.getElementById("projectBody");
      const noProjectsMessage = document.getElementById("noProjectsMessage");
      tbody.innerHTML = ""; 
      noProjectsMessage.textContent = "Filtreyle eÅŸleÅŸen proje bulunamadÄ± veya henÃ¼z kayÄ±tlÄ± proje yok."; // MesajÄ± gÃ¼ncelle

      try {
        let projectsQuery = db.collection("projects");

        // KullanÄ±cÄ± rolÃ¼ne gÃ¶re temel filtreleme
        if (currentUserRole !== "admin") {
          projectsQuery = projectsQuery.where("userId", "==", userId);
        }

        // Durum filtresi
        if (filters.status) {
            projectsQuery = projectsQuery.where("status", "==", filters.status);
        }
        // Kategori filtresi
        if (filters.category) {
            projectsQuery = projectsQuery.where("categories", "array-contains", filters.category);
        }

        // SÄ±ralama (Admin iÃ§in varsayÄ±lan createdAt, kullanÄ±cÄ± iÃ§in name)
        let sortField = filters.sortField || (currentUserRole === "admin" ? "createdAt" : "name");
        let sortDirection = filters.sortDirection || "desc";
        
        // contractValue gibi sayÄ±sal alanlarda sÄ±ralama yaparken, 
        // eÄŸer bu alan tÃ¼m dokÃ¼manlarda yoksa veya null ise sorun olabilir.
        // GÃ¼venli olmasÄ± iÃ§in tÃ¼m projelerde bu alanÄ±n var olduÄŸundan emin olunmalÄ±.
        projectsQuery = projectsQuery.orderBy(sortField, sortDirection);
        
        // Ä°kincil sÄ±ralama (opsiyonel, eÄŸer ana sÄ±ralama alanÄ± aynÄ± olan Ã§ok proje varsa)
        if (sortField !== "name") { // EÄŸer ana sÄ±ralama adÄ± deÄŸilse, ikinci olarak ada gÃ¶re sÄ±rala
             projectsQuery = projectsQuery.orderBy("name", "asc");
        }


        console.log("Firestore Query:", projectsQuery); // Sorguyu konsolda gÃ¶rmek iÃ§in

        const projectsSnapshot = await projectsQuery.get();
        
        if (projectsSnapshot.empty) {
            noProjectsMessage.style.display = "block";
        } else {
            noProjectsMessage.style.display = "none";
            projectsSnapshot.forEach(doc => {
              const proj = doc.data();
              const tr = document.createElement("tr");
              // ... (mevcut tr.innerHTML kodu aynÄ±, kategori ve diÄŸer alanlarÄ± gÃ¶sterir) ...
               let categoriesHtml = "N/A";
              if (proj.categories && proj.categories.length > 0) {
                  categoriesHtml = proj.categories.map(cat => `<span>${cat}</span>`).join(" ");
              }
              const contractValueDisplay = (proj.contractValue != null && typeof proj.contractValue === 'number')
                ? proj.contractValue.toLocaleString('tr-TR', {style: 'currency', currency: 'TRY'})
                : 'BelirtilmemiÅŸ';

              tr.innerHTML = `
                <td data-label="Proje AdÄ±"><a href="project-detail.html?id=${doc.id}">${proj.name}</a></td>
                <td data-label="MÃ¼ÅŸteri">${proj.client}</td>
                <td data-label="Kategoriler">${categoriesHtml}</td>
                <td data-label="Durum">${getStatusBadge(proj.status)}</td>
                <td data-label="SÃ¶zleÅŸme Bedeli">${contractValueDisplay}</td>
                <td data-label="Ä°ÅŸlem"><button class="btn-danger" onclick="deleteProject('${doc.id}', '${proj.name}')">Sil</button></td>
              `;
              tbody.appendChild(tr);
            });
        }
      } catch (error) {
          console.error("Projeler yÃ¼klenirken hata oluÅŸtu: ", error);
          noProjectsMessage.textContent = "Projeler yÃ¼klenirken bir hata oluÅŸtu.";
          noProjectsMessage.style.display = "block";
          if (error.code === 'failed-precondition') {
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">VeritabanÄ± sorgusu iÃ§in gerekli bir indeks eksik olabilir. LÃ¼tfen tarayÄ±cÄ± konsolunu kontrol edin ve Firebase'in Ã¶nerdiÄŸi indeksi oluÅŸturun.</td></tr>`;
          } else {
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Projeler yÃ¼klenirken bir hata oluÅŸtu.</td></tr>`;
          }
      }
    }
    
    function applyFiltersAndSort() {
        const selectedStatus = document.getElementById('filterStatus').value;
        const selectedCategory = document.getElementById('filterCategory').value;
        const selectedSortField = document.getElementById('sortField').value;
        const selectedSortDirection = document.getElementById('sortDirection').value;

        const filters = {};
        if (selectedStatus) filters.status = selectedStatus;
        if (selectedCategory) filters.category = selectedCategory;
        if (selectedSortField) filters.sortField = selectedSortField;
        if (selectedSortDirection) filters.sortDirection = selectedSortDirection;
        
        loadProjects(filters);
    }

    function resetFiltersAndSort() {
        document.getElementById('filterStatus').value = "";
        document.getElementById('filterCategory').value = "";
        document.getElementById('sortField').value = (currentUserRole === "admin" ? "createdAt" : "name"); // Role gÃ¶re varsayÄ±lan
        document.getElementById('sortDirection').value = "desc";
        applyFiltersAndSort();
    }


    async function addProject() { /* ... (mevcut kod aynÄ±) ... */ }
    async function deleteProject(id, projectName) { /* ... (mevcut kod aynÄ±) ... */ }
    function logout() { /* ... (mevcut kod aynÄ±) ... */ }

  </script>
</body>
</html>
